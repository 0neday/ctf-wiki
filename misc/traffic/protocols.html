


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="zh_CN">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>协议分析 &#8212; CTF Wiki </title>
    <link rel="stylesheet" href="../../_static/cloud.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Noticia+Text|Open+Sans|Droid+Sans+Mono" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/translations.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../_static/jquery.cookie.js"></script>
    <script type="text/javascript" src="../../_static/cloud.base.js"></script>
    <script type="text/javascript" src="../../_static/cloud.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="search" title="搜索" href="../../search.html" />
    <link rel="next" title="数据提取" href="data.html" />
    <link rel="prev" title="PCAP文件修复" href="fix.html" /> 
        <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>
  <body>
    <div class="relbar-top">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>导航</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../index.html" title="內容目录"
             accesskey="C">toc</a></li>
        <li class="right" >
          <a href="data.html" title="数据提取"
             accesskey="N">下一页</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="fix.html" title="PCAP文件修复"
             accesskey="P">上一页</a> &nbsp; &nbsp;</li>
    <li><a href="../../index.html">CTF Wiki </a> &#187;</li>

          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">流量包分析</a> &#187;</li> 
      </ul>
    </div>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="id1">
<h1>协议分析<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h1>
<div class="section" id="wireshark">
<h2>Wireshark 常用功能介绍<a class="headerlink" href="#wireshark" title="永久链接至标题">¶</a></h2>
<div class="section" id="id2">
<h3>显示过滤器<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h3>
<p>显示过滤器可以用很多不同的参数来作为匹配标准，比如IP地址、协议、端口号、某些协议头部的参数。此外，用户也用一些条件工具和串联运算符创建出更加复杂的表达式。用户可以将不同的表达式组合起来，让软件显示的数据包范围更加精确。在数据包列表面板中显示的所有数据包都可以用数据包中包含的字段进行过滤。</p>
<p><code class="docutils literal"><span class="pre">[not]</span> <span class="pre">Expression</span> <span class="pre">[and|or]</span> <span class="pre">[not]</span> <span class="pre">Expression</span></code></p>
<p>经常要用到各种运算符</p>
<table border="1" class="docutils">
<colgroup>
<col width="43%" />
<col width="57%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">运算符</th>
<th class="head">说明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>==</td>
<td>等于</td>
</tr>
<tr class="row-odd"><td>!=</td>
<td>不等于</td>
</tr>
<tr class="row-even"><td>&gt;</td>
<td>大于</td>
</tr>
<tr class="row-odd"><td>&lt;</td>
<td>小于</td>
</tr>
<tr class="row-even"><td>&gt;=</td>
<td>大于等于</td>
</tr>
<tr class="row-odd"><td>&lt;=</td>
<td>小于等于</td>
</tr>
<tr class="row-even"><td>与</td>
<td>and , &amp;&amp;</td>
</tr>
<tr class="row-odd"><td>或</td>
<td>or , ||</td>
</tr>
<tr class="row-even"><td>非</td>
<td>! , not</td>
</tr>
</tbody>
</table>
<div class="section" id="id3">
<h4>配置方法<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h4>
<ol class="arabic simple">
<li>借助于过滤器窗口</li>
</ol>
<div class="figure">
<img alt="filter\_window" src="../../_images/filter_window.png" />
</div>
<ol class="arabic simple" start="2">
<li>借助于工具条的输入栏</li>
</ol>
<div class="figure">
<img alt="filter\_tool" src="../../_images/filter_tool.png" />
</div>
<ol class="arabic simple" start="3">
<li>将数据包某个属性值指定为过滤条件</li>
</ol>
<div class="figure">
<img alt="filter\_select" src="../../_images/filter_select.png" />
</div>
<ul class="simple">
<li>Notes: 复杂的过滤命令可以直接通过第三种方式得到过滤语法</li>
</ul>
</div>
</div>
<div class="section" id="id4">
<h3>信息统计<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h3>
<div class="section" id="protocol-history">
<h4>Protocol History(协议分级)<a class="headerlink" href="#protocol-history" title="永久链接至标题">¶</a></h4>
<p>这个窗口现实的是捕捉文件包含的所有协议的树状分支</p>
<div class="figure">
<img alt="pro\_his" src="../../_images/pro_his.png" />
</div>
<p>包含的字段</p>
<table border="1" class="docutils">
<colgroup>
<col width="25%" />
<col width="75%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">名称</th>
<th class="head">含义</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Protocol：</td>
<td>协议名称</td>
</tr>
<tr class="row-odd"><td>% Packets：</td>
<td>含有该协议的包数目在捕捉文件所有包所占的比例</td>
</tr>
<tr class="row-even"><td>Packets：</td>
<td>含有该协议的包的数目</td>
</tr>
<tr class="row-odd"><td>Bytes：</td>
<td>含有该协议的字节数</td>
</tr>
<tr class="row-even"><td>Mbit/s：</td>
<td>抓包时间内的协议带宽</td>
</tr>
<tr class="row-odd"><td>End Packets：</td>
<td>该协议中的包的数目（作为文件中的最高协议层）</td>
</tr>
<tr class="row-even"><td>End Bytes：</td>
<td>该协议中的字节数（作为文件中的最高协议层）</td>
</tr>
<tr class="row-odd"><td>End Mbit/s：</td>
<td>抓包时间内的协议带宽（作为文件中的最高协议层）</td>
</tr>
</tbody>
</table>
<p>这一功能可以为分析数据包的主要方向提供依据</p>
</div>
<div class="section" id="conversation">
<h4>Conversation(对话)<a class="headerlink" href="#conversation" title="永久链接至标题">¶</a></h4>
<p>发生于一特定端点的IP间的所有流量.</p>
<div class="figure">
<img alt="Conversation" src="../../_images/conversation.png" />
</div>
<ul class="simple">
<li>Notes<ul>
<li>查看收发大量数据流的IP地址。如果是你知道的服务器（你记得服务器的地址或地址范围），那问题就解决了；但也有可能只是某台设备正在扫描网络，或仅是一台产生过多数据的PC。</li>
<li>查看扫描模式（scan pattern）。这可能是一次正常的扫描，如SNMP软件发送ping报文以查找网络，但通常扫描都不是好事情</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="endpoints">
<h4>EndPoints(端点)<a class="headerlink" href="#endpoints" title="永久链接至标题">¶</a></h4>
<p>这一工具列出了Wireshark发现的所有endpoints上的统计信息</p>
<div class="figure">
<img alt="points" src="../../_images/points.png" />
</div>
</div>
<div class="section" id="http">
<h4>HTTP<a class="headerlink" href="#http" title="永久链接至标题">¶</a></h4>
<ul class="simple">
<li>Packet Counter</li>
</ul>
<div class="figure">
<img alt="pac\_count" src="../../_images/pac_count.png" />
</div>
<p><strong>参考</strong></p>
<ul class="simple">
<li><a class="reference external" href="http://blog.jobbole.com/73482/">http://blog.jobbole.com/73482/</a></li>
<li><a class="reference external" href="http://www.vuln.cn/2103">http://www.vuln.cn/2103</a></li>
</ul>
</div>
</div>
<div class="section" id="id5">
<h3>信息统计 进阶版<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h3>
<p>根据总体信息迅速把握流量包总体特征,搞清楚 <strong>做什么?</strong></p>
<p>TODO</p>
</div>
</div>
<div class="section" id="id6">
<h2>常见协议<a class="headerlink" href="#id6" title="永久链接至标题">¶</a></h2>
<div class="section" id="http-https">
<h3>HTTP/HTTPs<a class="headerlink" href="#http-https" title="永久链接至标题">¶</a></h3>
<p>主要集中在流量中附件或是总体分析上,搞明白流量在做什么之后,基本可以定位到寻找flag的位置</p>
<div class="section" id="id7">
<h4>HTTP<a class="headerlink" href="#id7" title="永久链接至标题">¶</a></h4>
<p><strong>例题</strong></p>
<p>查看 <code class="xref download docutils literal"><span class="pre">this</span> <span class="pre">example</span> <span class="pre">script</span></code>.</p>
<p>查看 :download: <a href="#id8"><span class="problematic" id="id9">`</span></a>this example script &lt;file/hack.pcap&gt;</p>
<p>查看 <a href="#id10"><span class="problematic" id="id11">:download:`this example script &lt;../example.py&gt;`__</span></a></p>
<p>总体观察可以得出:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">HTTP</span></code>为主</li>
<li><code class="docutils literal"><span class="pre">102.168.173.134</span></code>为主</li>
<li>不存在附件</li>
</ul>
<div class="figure">
<img alt="linghang\_hack" src="../../_images/linghang_hack.png" />
</div>
<p>从这张图,基本可以判断初这是一个在<code class="docutils literal"><span class="pre">sql注入-盲注时产生的流量包</span></code></p>
<p>到此为止,基本可以判断flag的方向,提取出所有的url后,用<code class="docutils literal"><span class="pre">python</span></code>辅助即可得到flag</p>
<ul class="simple">
<li>提取url: <code class="docutils literal"><span class="pre">tshark</span> <span class="pre">-r</span> <span class="pre">hack.pcap</span> <span class="pre">-T</span> <span class="pre">fields</span>&#160; <span class="pre">-e</span> <span class="pre">http.request.full_uri|tr</span> <span class="pre">-s</span> <span class="pre">'\n'|grep</span> <span class="pre">flag</span> <span class="pre">&gt;</span> <span class="pre">log</span></code></li>
<li>得到盲注结果</li>
</ul>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">re</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">flag</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;=(\d*)%23&#39;</span><span class="p">,</span><span class="n">tmp</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">num</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">num</span> <span class="o">&gt;</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">flag</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="nb">print</span> <span class="n">flag</span>
</pre></div>
</div>
</div>
<div class="section" id="https">
<h4>HTTPs<a class="headerlink" href="#https" title="永久链接至标题">¶</a></h4>
<p><code class="docutils literal"><span class="pre">HTTPs</span> <span class="pre">=</span> <span class="pre">HTTP</span> <span class="pre">+</span> <span class="pre">SSL</span> <span class="pre">/</span> <span class="pre">TLS</span></code>.服务端和客户端的信息传输都会通过TLS进行加密，所以传输的数据都是加密后的数据</p>
<ul class="simple">
<li><a class="reference external" href="http://www.freebuf.com/articles/system/37900.html">wireshark分析HTTPs</a></li>
</ul>
<div class="line-block">
<div class="line"><strong>例题</strong>:</div>
<div class="line">- <a class="reference external" href="https://github.com/ctfs/write-ups-2015/tree/master/hack-dat-kiwi-ctf-2015/forensics/ssl-sniff-2">hack-dat-kiwi-ctf-2015:ssl-sniff-2</a></div>
</div>
<p>打开流量包发现是SSL加密过的数据,导入题目提供的<code class="docutils literal"><span class="pre">server.key.insecure</span></code>,即可解密</p>
<div class="code xml highlight-default"><div class="highlight"><pre><span></span><span class="n">GET</span> <span class="o">/</span><span class="n">key</span><span class="o">.</span><span class="n">html</span> <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span>
<span class="n">Host</span><span class="p">:</span> <span class="n">localhost</span>

<span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">200</span> <span class="n">OK</span>
<span class="n">Date</span><span class="p">:</span> <span class="n">Fri</span><span class="p">,</span> <span class="mi">20</span> <span class="n">Nov</span> <span class="mi">2015</span> <span class="mi">14</span><span class="p">:</span><span class="mi">16</span><span class="p">:</span><span class="mi">24</span> <span class="n">GMT</span>
<span class="n">Server</span><span class="p">:</span> <span class="n">Apache</span><span class="o">/</span><span class="mf">2.4</span><span class="o">.</span><span class="mi">7</span> <span class="p">(</span><span class="n">Ubuntu</span><span class="p">)</span>
<span class="n">Last</span><span class="o">-</span><span class="n">Modified</span><span class="p">:</span> <span class="n">Fri</span><span class="p">,</span> <span class="mi">20</span> <span class="n">Nov</span> <span class="mi">2015</span> <span class="mi">14</span><span class="p">:</span><span class="mi">15</span><span class="p">:</span><span class="mi">54</span> <span class="n">GMT</span>
<span class="n">ETag</span><span class="p">:</span> <span class="s2">&quot;1c-524f98378d4e1&quot;</span>
<span class="n">Accept</span><span class="o">-</span><span class="n">Ranges</span><span class="p">:</span> <span class="nb">bytes</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Length</span><span class="p">:</span> <span class="mi">28</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="p">:</span> <span class="n">text</span><span class="o">/</span><span class="n">html</span>

<span class="n">The</span> <span class="n">key</span> <span class="ow">is</span> <span class="mi">39</span><span class="n">u7v25n1jxkl123</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="ftp">
<h3>FTP<a class="headerlink" href="#ftp" title="永久链接至标题">¶</a></h3>
<p>TODO</p>
</div>
<div class="section" id="dns">
<h3>DNS<a class="headerlink" href="#dns" title="永久链接至标题">¶</a></h3>
<p>DNS通常为UDP协议,报文格式</p>
<div class="code sh highlight-default"><div class="highlight"><pre><span></span><span class="o">+-------------------------------+</span>
<span class="o">|</span> <span class="n">报文头</span>                         <span class="o">|</span>
<span class="o">+-------------------------------+</span>
<span class="o">|</span> <span class="n">问题</span> <span class="p">(</span><span class="n">向服务器提出的查询部分</span><span class="p">)</span>    <span class="o">|</span>
<span class="o">+-------------------------------+</span>
<span class="o">|</span> <span class="n">回答</span> <span class="p">(</span><span class="n">服务器回复的资源记录</span><span class="p">)</span>      <span class="o">|</span>
<span class="o">+-------------------------------+</span>
<span class="o">|</span> <span class="n">授权</span> <span class="p">(</span><span class="n">权威的资源记录</span><span class="p">)</span>           <span class="o">|</span>
<span class="o">+-------------------------------+</span>
<span class="o">|</span> <span class="n">格外的</span> <span class="p">(</span><span class="n">格外的资源记录</span><span class="p">)</span>         <span class="o">|</span>
<span class="o">+-------------------------------+</span>
</pre></div>
</div>
<p>查询包只有头部和问题两个部分，DNS收到查询包后，根据查询到的信息追加回答信息、授权机构、额外资源记录，并且修改了包头的相关标识再返回给客户端。</p>
<p>每个question部分</p>
<p><code class="docutils literal"><span class="pre">0</span>&#160; <span class="pre">1</span>&#160; <span class="pre">2</span>&#160; <span class="pre">3</span>&#160; <span class="pre">4</span>&#160; <span class="pre">5</span>&#160; <span class="pre">6</span>&#160; <span class="pre">7</span>&#160; <span class="pre">8</span>&#160; <span class="pre">9</span>&#160; <span class="pre">0</span>&#160; <span class="pre">1</span>&#160; <span class="pre">2</span>&#160; <span class="pre">3</span>&#160; <span class="pre">4</span>&#160; <span class="pre">5</span>&#160; <span class="pre">+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+</span>&#160; <span class="pre">|</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span class="pre">|</span>&#160; <span class="pre">/</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span class="pre">QNAME</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span class="pre">/</span>&#160; <span class="pre">/</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span class="pre">/</span>&#160; <span class="pre">+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+</span>&#160; <span class="pre">|</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span class="pre">QTYPE</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span class="pre">|</span>&#160; <span class="pre">+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+</span>&#160; <span class="pre">|</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span class="pre">QCLASS</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span class="pre">|</span>&#160; <span class="pre">+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+</span></code></p>
<ul class="simple">
<li>QNAME：为查询的域名，是可变长的，编码格式为：将域名用.号划分为多个部分，每个部分前面加上一个字节表示该部分的长度，最后加一个0字节表示结束</li>
<li>QTYPE：占16位，表示查询类型，共有16种，常用值有：1（A记录，请求主机IP地址）、2（NS，请求授权DNS服务器）、5（CNAME别名查询）</li>
</ul>
<p><strong>例题</strong></p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/ctfs/write-ups-2017/tree/master/bsidessf-ctf-2017/forensics/dnscap-500">BSides San Francisco CTF 2017 : dnscap-500</a></li>
<li>wireshark 打开发现全部为DNS协议,查询名为大量字符串<code class="docutils literal"><span class="pre">([\w\.]+)\.skullseclabs\.org</span></code></li>
<li><code class="docutils literal"><span class="pre">tshark</span> <span class="pre">-r</span> <span class="pre">dnscap.pcap</span> <span class="pre">-T</span> <span class="pre">fields</span> <span class="pre">-e</span> <span class="pre">dns.qry.name</span> <span class="pre">&gt;</span> <span class="pre">hex</span></code>提取后，python转码</li>
</ul>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">re</span>


<span class="n">find</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">,</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;([\w\.]+)\.skull&#39;</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">text</span><span class="p">:</span>
            <span class="n">find</span> <span class="o">+=</span> <span class="n">text</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="nb">print</span> <span class="n">find</span>
</pre></div>
</div>
<ul class="simple">
<li>发现几条关键信息</li>
</ul>
<div class="code xml highlight-default"><div class="highlight"><pre><span></span>Welcome to dnscap! The flag is below, have fun!!
Welcome to dnscap! The flag is below, have fun!!
!command (sirvimes)
...
IHDR
gAMA
bKGD
        pHYs
IHDR
gAMA
bKGD
        pHYs
tIME
IDATx
...
2017-02-01T21:04:00-08:00
IEND
console (sirvimes)
console (sirvimes)
Good luck! That was dnscat2 traffic on a flaky connection with lots of re-transmits. Seriously,
Good luck! That was dnscat2 traffic on a flaky connection with lots of re-transmits. Seriously, d[
good luck. :)+
</pre></div>
</div>
<p>flag确实包含在其中,但是有大量重复信息,一是应为<code class="docutils literal"><span class="pre">question</span></code>在dns协议中查询和反馈时都会用到,<code class="docutils literal"><span class="pre">-Y</span> <span class="pre">&quot;ip.src</span> <span class="pre">==</span> <span class="pre">192.168.43.91&quot;</span></code>进行过滤后发现还是有不少重复部分</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>%2A}
%2A}
%2A}q
%2A}x
%2A}
IHDR
gAMA
bKGD
        pHYs
tIME
IDATx
HBBH
CxRH!
C1%t
ceyF
i4ZI32
rP@1
ceyF
i4ZI32
rP@1
ceyF
i4ZI32
rP@1
ceyF
i4ZI32
rP@1
</pre></div>
</div>
<ul class="simple">
<li>根据发现的<code class="docutils literal"><span class="pre">dnscat</span></code>找到 <a class="reference external" href="https://github.com/iagox86/dnscat2/blob/master/doc/protocol.md">https://github.com/iagox86/dnscat2/blob/master/doc/protocol.md</a>
这里介绍了<code class="docutils literal"><span class="pre">dnscat</span></code>协议的相关信息,这是一种通过DNS传递数据的变种协议,题目文件中应该未使用加密,所以直接看这里的数据块信息</li>
</ul>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">MESSAGE_TYPE_MSG</span><span class="p">:</span> <span class="p">[</span><span class="mh">0x01</span><span class="p">]</span>
<span class="p">(</span><span class="n">uint16_t</span><span class="p">)</span> <span class="n">packet_id</span>
<span class="p">(</span><span class="n">uint8_t</span><span class="p">)</span> <span class="n">message_type</span> <span class="p">[</span><span class="mh">0x01</span><span class="p">]</span>
<span class="p">(</span><span class="n">uint16_t</span><span class="p">)</span> <span class="n">session_id</span>
<span class="p">(</span><span class="n">uint16_t</span><span class="p">)</span> <span class="n">seq</span>
<span class="p">(</span><span class="n">uint16_t</span><span class="p">)</span> <span class="n">ack</span>
<span class="p">(</span><span class="n">byte</span><span class="p">[])</span> <span class="n">data</span>
</pre></div>
</div>
<ul class="simple">
<li>在<code class="docutils literal"><span class="pre">qry.name</span></code>中去除其余字段,只留下<code class="docutils literal"><span class="pre">data</span></code>快,从而合并数据,再从16进制中检索<code class="docutils literal"><span class="pre">89504e.....6082</span></code>提取<code class="docutils literal"><span class="pre">png</span></code>,得到flag</li>
</ul>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">re</span>


<span class="n">find</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">,</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;([\w\.]+)\.skull&#39;</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">text</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">=</span>  <span class="n">text</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">find</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">18</span><span class="p">:])</span>
<span class="n">last</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">find</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">last</span><span class="p">:</span>
        <span class="n">last</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>


<span class="nb">print</span>  <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">last</span><span class="p">)</span>
</pre></div>
</div>
<p><em>flag</em></p>
<div class="figure">
<img alt="dnscat\_flag" src="../../_images/dnscat_flag.png" />
</div>
<p><strong>相关题目</strong></p>
<ul class="simple">
<li><a class="reference external" href="https://mrpnkt.github.io/2016/icectf-2016-search/">IceCTF-2016:Search</a></li>
<li><a class="reference external" href="https://github.com/susers/Writeups/blob/master/2017/EIS/Misc/DNS%20101/Write-up.md">EIS-2017:DNS 101</a></li>
</ul>
<p><strong>参考</strong></p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/lisijie/homepage/blob/master/posts/tech/dns%E5%8D%8F%E8%AE%AE%E8%A7%A3%E6%9E%90.md">https://github.com/lisijie/homepage/blob/master/posts/tech/dns%E5%8D%8F%E8%AE%AE%E8%A7%A3%E6%9E%90.md</a></li>
<li><a class="reference external" href="https://xpnsec.tumblr.com/post/157479786806/bsidessf-ctf-dnscap-walkthrough">https://xpnsec.tumblr.com/post/157479786806/bsidessf-ctf-dnscap-walkthrough</a></li>
</ul>
</div>
<div class="section" id="wifi">
<h3>WIFI<a class="headerlink" href="#wifi" title="永久链接至标题">¶</a></h3>
<blockquote>
<div>802.11是现今无线局域网通用的标准,常见认证方式 - 不启用安全‍‍ - WEP‍‍ - WPA/WPA2-PSK（预共享密钥）‍‍ - PA/WPA2 802.1X （radius认证）</div></blockquote>
<div class="section" id="wpa-psk">
<h4>WPA-PSK<a class="headerlink" href="#wpa-psk" title="永久链接至标题">¶</a></h4>
<p>认证大致过程如下图</p>
<div class="figure">
<img alt="wpa-psk" src="../../_images/wpa-psk.png" />
</div>
<p>其中四次握手过程</p>
<div class="figure">
<img alt="eapol" src="../../_images/eapol.png" />
</div>
<ol class="arabic simple">
<li>4次握手开始于验证器(AP)，它产生一个随机的值(ANonce)发送给请求者</li>
<li>请求者也产生了它自己的随机SNonce，然后用这两个Nonces以及PMK生成了PTK。请求者回复消息2给验证器,还有一个MIC（message integrity code，消息验证码）作为PMK的验证</li>
<li>它先要验证请求者在消息2中发来的MIC等信息，验证成功后，如果需要就生成GTK。然后发送消息3</li>
<li>请求者收到消息3，验证MIC，安装密钥，发送消息4，一个确认信息。验证器收到消息4，验证MIC，安装相同的密钥</li>
</ol>
<p><strong>例题</strong></p>
<ul class="simple">
<li>实验吧: <a class="reference external" href="http://ctf5.shiyanbar.com/misc/shipin.cap">http://ctf5.shiyanbar.com/misc/shipin.cap</a></li>
</ul>
<p>从大量的<code class="docutils literal"><span class="pre">Deauth</span></code> 攻击基本可以判断是一个破解wifi时的流量攻击</p>
<p>同时也成功发现了握手包信息</p>
<div class="figure">
<img alt="shiyanba-wpa" src="../../_images/shiyanba-wpa.png" />
</div>
<p>接下来跑密码</p>
<ul class="simple">
<li>linux: aircrack套件</li>
<li>windows: wifipr,速度比esaw快,GTX850能将近10w:raw-latex:<a href="#id12"><span class="problematic" id="id13">`</span></a>s  <a href="#id14"><span class="problematic" id="id15">`</span></a>:)</li>
</ul>
<p>得到密码<code class="docutils literal"><span class="pre">88888888</span></code>在wireshark中<code class="docutils literal"><span class="pre">Edit</span> <span class="pre">-&gt;</span> <span class="pre">Preferences</span> <span class="pre">-&gt;</span> <span class="pre">Protocols</span> <span class="pre">-&gt;</span> <span class="pre">IEEE802.11</span> <span class="pre">-&gt;</span> <span class="pre">Edit</span></code>以<code class="docutils literal"><span class="pre">key:SSID</span></code>形式填入即可解密wifi包看到明文流量</p>
<blockquote>
<div>KCARCK相关: <a class="reference external" href="https://www.krackattacks.com/">https://www.krackattacks.com/</a></div></blockquote>
<p><strong>参考</strong></p>
<ul class="simple">
<li><a class="reference external" href="http://www.freebuf.com/articles/wireless/58342.html">http://www.freebuf.com/articles/wireless/58342.html</a></li>
<li><a class="reference external" href="http://blog.csdn.net/keekjkj/article/details/46753883">http://blog.csdn.net/keekjkj/article/details/46753883</a></li>
</ul>
</div>
</div>
<div class="section" id="usb">
<h3>USB<a class="headerlink" href="#usb" title="永久链接至标题">¶</a></h3>
<p><strong>USB详述</strong>: <a class="reference external" href="http://www.usb.org/developers/hidpage/Hut1_12v2.pdf">http://www.usb.org/developers/hidpage/Hut1_12v2.pdf</a></p>
<ul class="simple">
<li>鼠标协议</li>
</ul>
<p>鼠标移动时表现为连续性，与键盘击键的离散性不一样，不过实际上鼠标动作所产生的数据包也是离散的，毕竟计算机表现的连续性信息都是由大量离散信息构成的</p>
<div class="figure">
<img alt="mouse" src="../../_images/mouse.png" />
</div>
<p>每一个数据包的数据区有四个字节，第一个字节代表按键，当取0x00时，代表没有按键、为0x01时，代表按左键，为0x02时，代表当前按键为右键。第二个字节可以看成是一个signed
byte类型，其最高位为符号位，当这个值为正时，代表鼠标水平右移多少像素，为负时，代表水平左移多少像素。第三个字节与第二字节类似，代表垂直上下移动的偏移。</p>
<p>得到这些点的信息后,即可恢复出鼠标移动轨迹</p>
<ul class="simple">
<li>Tools<ul>
<li><a class="reference external" href="https://github.com/WangYihang/UsbMiceDataHacker">UsbMiceDataHacker</a></li>
</ul>
</li>
<li>键盘协议</li>
</ul>
<p>键盘数据包的数据长度为8个字节，击键信息集中在第3个字节</p>
<div class="figure">
<img alt="keyboard" src="../../_images/keyboard.png" />
</div>
<p>根据data值与具体键位的对应关系</p>
<div class="figure">
<img alt="keyboard\_pro" src="../../_images/keyboard_pro.png" />
</div>
<p>可从数据包恢复出键盘的案件信息</p>
<ul class="simple">
<li>Tools<ul>
<li><a class="reference external" href="https://github.com/WangYihang/UsbKeyboardDataHacker">UsbKeyboardDataHacker</a></li>
</ul>
</li>
</ul>
<p><strong>参考</strong> - <a class="reference external" href="https://www.anquanke.com/post/id/85218">https://www.anquanke.com/post/id/85218</a></p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>快速搜索</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="转向" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
<div class="sphinx-toc sphinxglobaltoc">
<h3><a href="../../index.html">內容目录</a></h3>
<p class="caption"><span class="caption-text">CTF 介绍</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../introduction/history.html">CTF 竞赛的历史</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../introduction/mode.html">CTF 竞赛模式简介</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../introduction/content.html">CTF 竞赛内容</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../introduction/experience.html">线下攻防经验小结</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../introduction/cgc.html">CGC 网络超级挑战赛</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../introduction/resources.html">学习资源</a></li>
</ul>
<p class="caption"><span class="caption-text">Misc</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../about.html">杂项简介</a></li>
<li class="toctree-l1"><a class="reference internal" href="../recon.html">信息搜集技术</a></li>
<li class="toctree-l1"><a class="reference internal" href="../encode/index.html">编码分析</a></li>
<li class="toctree-l1"><a class="reference internal" href="../prefix.html">取证隐写</a></li>
<li class="toctree-l1"><a class="reference internal" href="../picture/index.html">图片分析</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">流量包分析</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="fix.html">PCAP文件修复</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">协议分析</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#wireshark">Wireshark 常用功能介绍</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id2">显示过滤器</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#id3">配置方法</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#id4">信息统计</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#protocol-history">Protocol History(协议分级)</a></li>
<li class="toctree-l5"><a class="reference internal" href="#conversation">Conversation(对话)</a></li>
<li class="toctree-l5"><a class="reference internal" href="#endpoints">EndPoints(端点)</a></li>
<li class="toctree-l5"><a class="reference internal" href="#http">HTTP</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#id5">信息统计 进阶版</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id6">常见协议</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#http-https">HTTP/HTTPs</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#id7">HTTP</a></li>
<li class="toctree-l5"><a class="reference internal" href="#https">HTTPs</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#ftp">FTP</a></li>
<li class="toctree-l4"><a class="reference internal" href="#dns">DNS</a></li>
<li class="toctree-l4"><a class="reference internal" href="#wifi">WIFI</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#wpa-psk">WPA-PSK</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#usb">USB</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="data.html">数据提取</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../archive/index.html">压缩包分析</a></li>
<li class="toctree-l1"><a class="reference internal" href="../audio/index.html">音频分析</a></li>
<li class="toctree-l1"><a class="reference internal" href="../disk_memory/index.html">磁盘 / 内存分析</a></li>
</ul>
<p class="caption"><span class="caption-text">Crypto</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../crypto/introduction.html">密码学简介</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crypto/classical/index.html">古典密码</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crypto/symmetric/index.html">对称加密</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crypto/asymmetric/index.html">非对称密码</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crypto/hash/index.html">哈希函数</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crypto/signature/index.html">数字签名</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crypto/others/others.html">证书格式</a></li>
</ul>
<p class="caption"><span class="caption-text">Web</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../web/index.html">WEB 简介</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../web/sqli.html">SQL 注入</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../web/xss.html">XSS 跨站脚本攻击</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../web/csrf.html">CSRF 跨站请求伪造</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../web/ssrf.html">SSRF 服务端请求伪造</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../web/php.html">PHP 代码审计</a></li>
</ul>
<p class="caption"><span class="caption-text">Reverse</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../reverse/introduction.html">软件逆向工程简介</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reverse/unpack/index.html">Unpack Tricks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reverse/unicorn/index.html">Unicorn Engine</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reverse/anti_debug/index.html">Anti Debug Tech</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reverse/linux/index.html">Linux RE</a></li>
</ul>
<p class="caption"><span class="caption-text">Pwn</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../pwn/stackoverflow/index.html">栈溢出</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pwn/fmtstr/index.html">格式化字符串漏洞</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pwn/heap/index.html">堆利用</a></li>
</ul>
<p class="caption"><span class="caption-text">Executable</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../executable/elf/index.html">ELF文件</a></li>
</ul>
</div>
        </div>
      </div>
    
    
        <div class="sidebar-toggle-group no-js">
            
            <button class="sidebar-toggle" id="sidebar-hide" title="Hide the sidebar menu">
                 «
                <span class="show-for-small">hide menu</span>
                
            </button>
            <button class="sidebar-toggle" id="sidebar-show" title="Show the sidebar menu">
                
                <span class="show-for-small">menu</span>
                <span class="hide-for-small">sidebar</span>
                 »
            </button>
        </div>
    
      <div class="clearer"></div>
    </div>
    <div class="relbar-bottom">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>导航</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../index.html" title="內容目录"
             >toc</a></li>
        <li class="right" >
          <a href="data.html" title="数据提取"
             >下一页</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="fix.html" title="PCAP文件修复"
             >上一页</a> &nbsp; &nbsp;</li>
    <li><a href="../../index.html">CTF Wiki </a> &#187;</li>

          <li class="nav-item nav-item-1"><a href="index.html" >流量包分析</a> &#187;</li> 
      </ul>
    </div>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2016-2017, CTF Wiki.
      由 <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.7 创建。
    </div>
    <!-- cloud_sptheme 1.4 -->
  </body>
</html>