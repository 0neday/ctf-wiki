


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="zh_CN">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Coppersmith Related Attack &#8212; CTF Wiki </title>
    <link rel="stylesheet" href="../../../_static/cloud.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/css/custom.css" type="text/css" />
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Noticia+Text|Open+Sans|Droid+Sans+Mono" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/translations.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../../_static/jquery.cookie.js"></script>
    <script type="text/javascript" src="../../../_static/cloud.base.js"></script>
    <script type="text/javascript" src="../../../_static/cloud.js"></script>
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
    <link rel="search" title="搜索" href="../../../search.html" />
    <link rel="next" title="侧信道攻击" href="rsa_side_channel.html" />
    <link rel="prev" title="选择密文攻击" href="rsa_chosen_cipher.html" /> 
        <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>
  <body>
    <div class="relbar-top">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>导航</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../index.html" title="內容目录"
             accesskey="C">toc</a></li>
        <li class="right" >
          <a href="rsa_side_channel.html" title="侧信道攻击"
             accesskey="N">下一页</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="rsa_chosen_cipher.html" title="选择密文攻击"
             accesskey="P">上一页</a> &nbsp; &nbsp;</li>
    <li><a href="../../../index.html">CTF Wiki </a> &#187;</li>

          <li class="nav-item nav-item-1"><a href="../index.html" >非对称密码</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="rsa_index.html" accesskey="U">RSA</a> &#187;</li> 
      </ul>
    </div>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="coppersmith-related-attack">
<h1>Coppersmith Related Attack<a class="headerlink" href="#coppersmith-related-attack" title="永久链接至标题">¶</a></h1>
<div class="section" id="id1">
<h2>基本原理<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h2>
<p>首先，我们来简单介绍一下<strong>Coppersmith method</strong> 方法，该方法由<a class="reference external" href="https://en.wikipedia.org/wiki/Don_Coppersmith">Don Coppersmith</a>
提出，可以用来找到单变量或者二元变量的多项式在模某个整数下的根，这里我们主要以单变量为主，假设我们有如下的一个在模N意义下的多项式F</p>
<div class="math">
\[F(x)=x^n + a_{n-1} x^{n-1} + \cdots + a_1x + a_0\]</div>
<p>假设该多项式在模N意义下有一个根<span class="math">\(x_0\)</span> ，这里我们令<span class="math">\(x_0 &lt; M^{\frac{1}{n}}\)</span> 。如果等号成立的话，显然只有<span class="math">\(x^n\)</span> 这一项，那0就是，也满足。</p>
<p><strong>Coppersmith method</strong> 主要是通过<a class="reference external" href="https://en.wikipedia.org/wiki/Lenstra%E2%80%93Lenstra%E2%80%93Lov%C3%A1sz_lattice_basis_reduction_algorithm">Lenstra–Lenstra–Lovász lattice basis reduction
algorithm</a> (LLL) 方法来找到与该函数具有相同根<span class="math">\(x_0\)</span>
但有更小系数的多项式。关于更加详细的介绍，请自行搜索。</p>
</div>
<div class="section" id="basic-broadcast-attack">
<h2>Basic Broadcast Attack<a class="headerlink" href="#basic-broadcast-attack" title="永久链接至标题">¶</a></h2>
<div class="section" id="id2">
<h3>攻击条件<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h3>
<p>如果一个用户使用同一个加密指数e加密了同一个密文，并发送给了其他e个用户。那么就会产生广播攻击。这一攻击由 Håstad 提出。</p>
</div>
<div class="section" id="id3">
<h3>攻击原理<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h3>
<p>这里我们假设e为3，并且加密者使用了三个不同的模数<span class="math">\(n_1,n_2,n_3\)</span> 给三个不同的用户发送了加密后的消息m，如下</p>
<div class="math">
\[\begin{split}\begin{align}
c_1&amp;=m^3\bmod n_1 \\
c_2&amp;=m^3\bmod n_2 \\
c_3&amp;=m^3\bmod n_3 \\
\end{align}\end{split}\]</div>
<p>这里我们假设<span class="math">\(n_1,n_2,n_3​\)</span> 互相互素，不然，我们就可以直接进行分解，然后得到d，进而然后直接解密。</p>
<p>同时，我们假设<span class="math">\(m&lt;n_i, 1\leq i \leq 3\)</span> 。如果这个条件不满足的话，就会使得情况变得比较复杂，这里我们暂不讨论。</p>
<p>既然他们互素，那么我们可以根据中国剩余定理，可得<span class="math">\(m^3 \equiv C \bmod n_1n_2n_3\)</span> 。</p>
<p>此外，既然<span class="math">\(m&lt;n_i, 1\leq i \leq 3\)</span> ，那么我们知道<span class="math">\(m^3 &lt; n_1n_2n_3\)</span> 并且<span class="math">\(C&lt;m^3 &lt; n_1n_2n_3\)</span> ，那么<span class="math">\(m^3 = C\)</span> ，我们对C开三次根即可得到m的值。</p>
<p>对于较大的e来说，我们只是需要更多的明密文对。</p>
</div>
<div class="section" id="sctf-rsa3-level4">
<h3>SCTF RSA3 LEVEL4<a class="headerlink" href="#sctf-rsa3-level4" title="永久链接至标题">¶</a></h3>
<p>参考http://ohroot.com/2016/07/11/rsa-in-ctf。</p>
<p>这里我们以SCTF RSA3中的level4为例进行介绍，首先编写代码提取cap包中的数据，如下</p>
<div class="code shell highlight-default"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>

<span class="kn">from</span> <span class="nn">scapy.all</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">zlib</span>
<span class="kn">import</span> <span class="nn">struct</span>

<span class="n">PA</span> <span class="o">=</span> <span class="mi">24</span>
<span class="n">packets</span> <span class="o">=</span> <span class="n">rdpcap</span><span class="p">(</span><span class="s1">&#39;./syc_security_system_traffic3.pcap&#39;</span><span class="p">)</span>
<span class="n">client</span> <span class="o">=</span> <span class="s1">&#39;192.168.1.180&#39;</span>
<span class="n">list_n</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">list_m</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">list_id</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">packet</span> <span class="ow">in</span> <span class="n">packets</span><span class="p">:</span>
    <span class="c1"># TCP Flag PA 24 means carry data</span>
    <span class="k">if</span> <span class="n">packet</span><span class="p">[</span><span class="n">TCP</span><span class="p">]</span><span class="o">.</span><span class="n">flags</span> <span class="o">==</span> <span class="n">PA</span> <span class="ow">or</span> <span class="n">packet</span><span class="p">[</span><span class="n">TCP</span><span class="p">]</span><span class="o">.</span><span class="n">flags</span> <span class="o">==</span> <span class="n">PA</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">src</span> <span class="o">=</span> <span class="n">packet</span><span class="p">[</span><span class="n">IP</span><span class="p">]</span><span class="o">.</span><span class="n">src</span>
        <span class="n">raw_data</span> <span class="o">=</span> <span class="n">packet</span><span class="p">[</span><span class="n">TCP</span><span class="p">]</span><span class="o">.</span><span class="n">load</span>
        <span class="n">head</span> <span class="o">=</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">strip</span><span class="p">()[:</span><span class="mi">7</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">head</span> <span class="o">==</span> <span class="s2">&quot;We have&quot;</span><span class="p">:</span>
            <span class="n">n</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;We have got N is &quot;</span><span class="p">,</span>
                                            <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">e is &#39;</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">head</span> <span class="o">==</span> <span class="s2">&quot;encrypt&quot;</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;encrypted messages is 0x&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="mi">16</span><span class="p">)))</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;./data.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">])</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>其次，利用得到的数据直接使用中国剩余定理求解。</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">reduce</span>
<span class="kn">import</span> <span class="nn">gmpy</span>
<span class="kn">import</span> <span class="nn">json</span><span class="o">,</span> <span class="nn">binascii</span>


<span class="k">def</span> <span class="nf">modinv</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">gmpy</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">gmpy</span><span class="o">.</span><span class="n">mpz</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">gmpy</span><span class="o">.</span><span class="n">mpz</span><span class="p">(</span><span class="n">m</span><span class="p">)))</span>


<span class="k">def</span> <span class="nf">chinese_remainder</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
    <span class="nb">sum</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">prod</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="c1"># 并行运算</span>
    <span class="k">for</span> <span class="n">n_i</span><span class="p">,</span> <span class="n">a_i</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">prod</span> <span class="o">//</span> <span class="n">n_i</span>
        <span class="nb">sum</span> <span class="o">+=</span> <span class="n">a_i</span> <span class="o">*</span> <span class="n">modinv</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">n_i</span><span class="p">)</span> <span class="o">*</span> <span class="n">p</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="nb">sum</span> <span class="o">%</span> <span class="n">prod</span><span class="p">)</span>


<span class="n">nset</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">cset</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;data.txt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">now</span><span class="p">:</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="n">nset</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">cset</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

<span class="n">m</span> <span class="o">=</span> <span class="n">chinese_remainder</span><span class="p">(</span><span class="n">nset</span><span class="p">,</span> <span class="n">cset</span><span class="p">)</span>
<span class="n">m</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">gmpy</span><span class="o">.</span><span class="n">mpz</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">root</span><span class="p">(</span><span class="mi">19</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span> <span class="n">binascii</span><span class="o">.</span><span class="n">unhexlify</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">m</span><span class="p">)[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
<p>得到密文，然后再次解密即可得到flag。</p>
<div class="code shell highlight-default"><div class="highlight"><pre><span></span><span class="n">H1sTaDs_B40aDcadt_attaCk_e_are_same_and_smA9l</span>
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h3>题目<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h3>
<ul class="simple">
<li>2017 WHCTF OldDriver</li>
</ul>
</div>
</div>
<div class="section" id="broadcast-attack-with-linear-padding">
<h2>Broadcast Attack with Linear Padding<a class="headerlink" href="#broadcast-attack-with-linear-padding" title="永久链接至标题">¶</a></h2>
<p>对于具有线性填充的情况下，仍然可以攻击，这时候就会使用<strong>Coppersmith method</strong> 的方法了，这里暂不介绍。可以参考</p>
<ul class="simple">
<li><a class="reference external" href="https://en.wikipedia.org/wiki/Coppersmith%27s_attack#Generalizations">https://en.wikipedia.org/wiki/Coppersmith%27s_attack#Generalizations</a></li>
</ul>
</div>
<div class="section" id="related-message-attack">
<h2>Related Message Attack<a class="headerlink" href="#related-message-attack" title="永久链接至标题">¶</a></h2>
<div class="section" id="id5">
<h3>攻击条件<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h3>
<p>当Alice使用同一公钥对两个具有某种线性关系的消息M1与M2 进行加密，并将加密后的消息C1，C2发送给了Bob时，我们就可能可以获得对应的消息M1与M2。这里我们假设模数为N，两者之间的线性关系如下</p>
<p><span class="math">\(M_1 \equiv f(M_2) \bmod N\)</span></p>
<p>其中f为一个线性函数，比如说<span class="math">\(f=ax+b\)</span>。</p>
<p>在具有较小错误概率下的情况下，其复杂度为<span class="math">\(O(elog^2N)\)</span> 。</p>
<p>这一攻击由Franklin，Reiter提出。</p>
</div>
<div class="section" id="id6">
<h3>攻击原理<a class="headerlink" href="#id6" title="永久链接至标题">¶</a></h3>
<p>首先，我们知道<span class="math">\(C_1 \equiv M_1 ^e \bmod N\)</span> ，并且<span class="math">\(M_1 \equiv f(M_2) \bmod N\)</span> ，那么我们可以知道<span class="math">\(M_2\)</span> 是<span class="math">\(f(x)^e \equiv C_1 \bmod N\)</span>
的一个解，即它是方程<span class="math">\(f(x)^e-C_1\)</span> 在模N意义下的一个根。同样的，<span class="math">\(M_2\)</span> 是<span class="math">\(x^e - C_2\)</span> 在模N意义下的一个根。所以说<span class="math">\(x-M_2\)</span>
同时整除以上两个多项式。因此，我们可以求得两个多项式的最大公因子，如果最大公因子恰好是线性的话，那么我们就求得了<span class="math">\(M_2\)</span> 。需要注意的是，在e=3的情况下，最大公因子一定是线性的。</p>
<p>这里我们关注一下e=3，且<span class="math">\(f(x)=ax+b\)</span> 的情况。首先我们有</p>
<p><span class="math">\(C_1 \equiv M_1 ^3 \bmod N\)</span> 且<span class="math">\(M_1 \equiv aM_2+b \bmod N\)</span></p>
<p>那么我们有</p>
<p><span class="math">\(C_1 \equiv (aM_2+b)^3 \bmod N\)</span> 且<span class="math">\(C_2 \equiv M_2^3 \bmod N\)</span></p>
<p>我们需要明确一下我们想要得到的是消息M，所以需要将其单独构造出来。</p>
<p>首先，我们有式1</p>
<p><span class="math">\((aM_2+b)^3=a^3M_2^3+3a^2M^2b+3aM_2b^2+b^3\)</span></p>
<p>再者我们构造如下式2</p>
<p><span class="math">\((aM_2)^3-b^3 \equiv (aM_2-b)(a^2M_2^2+aM_2b+b^2) \bmod N\)</span></p>
<p>根据式1我们有</p>
<p><span class="math">\(a^3M_2^3-2b^3+3b(a^2M_2^2+aM_2b+b^2) \equiv C_1 \bmod N\)</span></p>
<p>继而我们有式3</p>
<p><span class="math">\(3b(a^2M_2^2+aM_2b+b^2) \equiv C_1-a^3C_2+2b^3 \bmod N\)</span></p>
<p>那么我们根据式2与式3可得</p>
<p><span class="math">\((a^3C_2-b^3)*3b \equiv (aM_2-b)( C_1-a^3C_2+2b^3 ) \bmod N\)</span></p>
<p>进而我们有</p>
<p><span class="math">\(aM_2-b=\frac{3a^3bC_2-3b^4}{C_1-a^3C_2+2b^3}\)</span></p>
<p>进而</p>
<p><span class="math">\(aM_2\equiv \frac{2a^3bC_2-b^4+C_1b}{C_1-a^3C_2+2b^3}\)</span></p>
<p>进而</p>
<p><span class="math">\(M_2 \equiv\frac{2a^3bC_2-b^4+C_1b}{aC_1-a^4C_2+2ab^3}=\frac{b}{a}\frac{C_1+2a^3C_2-b^3}{C_1-a^3C_2+2b^3}\)</span></p>
<p>上面的式子中右边所有的内容都是已知的内容，所以我们可以直接获取对应的消息。</p>
<p>有兴趣的可以进一步阅读<a class="reference external" href="https://www.iacr.org/archive/pkc2005/33860001/33860001.pdf">A New Related Message Attack on RSA</a>
以及<a class="reference external" href="https://www.cs.unc.edu/~reiter/papers/1996/Eurocrypt.pdf">paper</a>这里暂不做过多的讲解。</p>
</div>
<div class="section" id="id7">
<h3>例子<a class="headerlink" href="#id7" title="永久链接至标题">¶</a></h3>
<p>这里我们以SCTF rsa3中的level3为例进行介绍。首先，跟踪TCP流可以知道，加密方式是将明文加上用户的user id进行加密，而且还存在多组。这里我们选择第0组和第9组，他们的模数一样，解密脚本如下</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">gmpy2</span>
<span class="n">id1</span> <span class="o">=</span> <span class="mi">1002</span>
<span class="n">id2</span> <span class="o">=</span> <span class="mi">2614</span>

<span class="n">c1</span> <span class="o">=</span> <span class="mh">0x547995f4e2f4c007e6bb2a6913a3d685974a72b05bec02e8c03ba64278c9347d8aaaff672ad8460a8cf5bffa5d787c5bb724d1cee07e221e028d9b8bc24360208840fbdfd4794733adcac45c38ad0225fde19a6a4c38e4207368f5902c871efdf1bdf4760b1a98ec1417893c8fce8389b6434c0fee73b13c284e8c9fb5c77e420a2b5b1a1c10b2a7a3545e95c1d47835c2718</span><span class="n">L</span>
<span class="n">c2</span> <span class="o">=</span> <span class="mh">0x547995f4e2f4c007e6bb2a6913a3d685974a72b05bec02e8c03ba64278c9347d8aaaff672ad8460a8cf5bffa5d787c72722fe4fe5a901e2531b3dbcb87e5aa19bbceecbf9f32eacefe81777d9bdca781b1ec8f8b68799b4aa4c6ad120506222c7f0c3e11b37dd0ce08381fabf9c14bc74929bf524645989ae2df77c8608d0512c1cc4150765ab8350843b57a2464f848d8e08</span><span class="n">L</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">25357901189172733149625332391537064578265003249917817682864120663898336510922113258397441378239342349767317285221295832462413300376704507936359046120943334215078540903962128719706077067557948218308700143138420408053500628616299338204718213283481833513373696170774425619886049408103217179262264003765695390547355624867951379789924247597370496546249898924648274419164899831191925127182066301237673243423539604219274397539786859420866329885285232179983055763704201023213087119895321260046617760702320473069743688778438854899409292527695993045482549594428191729963645157765855337481923730481041849389812984896044723939553</span>
<span class="n">a</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">id1</span> <span class="o">-</span> <span class="n">id2</span>


<span class="k">def</span> <span class="nf">getmessage</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="n">b3</span> <span class="o">=</span> <span class="n">gmpy2</span><span class="o">.</span><span class="n">powmod</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="n">part1</span> <span class="o">=</span> <span class="n">b</span> <span class="o">*</span> <span class="p">(</span><span class="n">c1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">c2</span> <span class="o">-</span> <span class="n">b3</span><span class="p">)</span> <span class="o">%</span> <span class="n">n</span>
    <span class="n">part2</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="p">(</span><span class="n">c1</span> <span class="o">-</span> <span class="n">c2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">b3</span><span class="p">)</span> <span class="o">%</span> <span class="n">n</span>
    <span class="n">part2</span> <span class="o">=</span> <span class="n">gmpy2</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">part2</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">part1</span> <span class="o">*</span> <span class="n">part2</span> <span class="o">%</span> <span class="n">n</span>


<span class="n">message</span> <span class="o">=</span> <span class="n">getmessage</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">-</span> <span class="n">id2</span>
<span class="n">message</span> <span class="o">=</span> <span class="nb">hex</span><span class="p">(</span><span class="n">message</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span> <span class="o">+</span> <span class="n">message</span>

<span class="nb">print</span> <span class="n">message</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>得到明文</p>
<div class="code shell highlight-default"><div class="highlight"><pre><span></span>➜  sctf-rsa3-level3 git:(master) ✗ python exp.py
F4An8LIn_rElT3r_rELa53d_Me33Age_aTtaCk_e_I2_s7aLL
</pre></div>
</div>
<p>当然，我们也可以直接使用sage来做，会更加简单一点。</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">binascii</span>

<span class="k">def</span> <span class="nf">attack</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="n">PR</span><span class="o">.&lt;</span><span class="n">x</span><span class="o">&gt;=</span><span class="n">PolynomialRing</span><span class="p">(</span><span class="n">Zmod</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
    <span class="n">g1</span> <span class="o">=</span> <span class="n">x</span><span class="o">^</span><span class="n">e</span> <span class="o">-</span> <span class="n">c1</span>
    <span class="n">g2</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">b</span><span class="p">)</span><span class="o">^</span><span class="n">e</span> <span class="o">-</span> <span class="n">c2</span>

    <span class="k">def</span> <span class="nf">gcd</span><span class="p">(</span><span class="n">g1</span><span class="p">,</span> <span class="n">g2</span><span class="p">):</span>
        <span class="k">while</span> <span class="n">g2</span><span class="p">:</span>
            <span class="n">g1</span><span class="p">,</span> <span class="n">g2</span> <span class="o">=</span> <span class="n">g2</span><span class="p">,</span> <span class="n">g1</span> <span class="o">%</span> <span class="n">g2</span>
        <span class="k">return</span> <span class="n">g1</span><span class="o">.</span><span class="n">monic</span><span class="p">()</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">gcd</span><span class="p">(</span><span class="n">g1</span><span class="p">,</span> <span class="n">g2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">c1</span> <span class="o">=</span> <span class="mh">0x547995f4e2f4c007e6bb2a6913a3d685974a72b05bec02e8c03ba64278c9347d8aaaff672ad8460a8cf5bffa5d787c5bb724d1cee07e221e028d9b8bc24360208840fbdfd4794733adcac45c38ad0225fde19a6a4c38e4207368f5902c871efdf1bdf4760b1a98ec1417893c8fce8389b6434c0fee73b13c284e8c9fb5c77e420a2b5b1a1c10b2a7a3545e95c1d47835c2718</span><span class="n">L</span>
<span class="n">c2</span> <span class="o">=</span> <span class="mh">0x547995f4e2f4c007e6bb2a6913a3d685974a72b05bec02e8c03ba64278c9347d8aaaff672ad8460a8cf5bffa5d787c72722fe4fe5a901e2531b3dbcb87e5aa19bbceecbf9f32eacefe81777d9bdca781b1ec8f8b68799b4aa4c6ad120506222c7f0c3e11b37dd0ce08381fabf9c14bc74929bf524645989ae2df77c8608d0512c1cc4150765ab8350843b57a2464f848d8e08</span><span class="n">L</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">25357901189172733149625332391537064578265003249917817682864120663898336510922113258397441378239342349767317285221295832462413300376704507936359046120943334215078540903962128719706077067557948218308700143138420408053500628616299338204718213283481833513373696170774425619886049408103217179262264003765695390547355624867951379789924247597370496546249898924648274419164899831191925127182066301237673243423539604219274397539786859420866329885285232179983055763704201023213087119895321260046617760702320473069743688778438854899409292527695993045482549594428191729963645157765855337481923730481041849389812984896044723939553</span>
<span class="n">e</span><span class="o">=</span><span class="mi">3</span>
<span class="n">a</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">id1</span> <span class="o">=</span> <span class="mi">1002</span>
<span class="n">id2</span> <span class="o">=</span> <span class="mi">2614</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">id2</span> <span class="o">-</span> <span class="n">id1</span>
<span class="n">m1</span> <span class="o">=</span> <span class="n">attack</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span><span class="n">c2</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
<span class="nb">print</span> <span class="n">binascii</span><span class="o">.</span><span class="n">unhexlify</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%x</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="n">m1</span> <span class="o">-</span> <span class="n">id1</span><span class="p">))</span>
</pre></div>
</div>
<p>结果如下</p>
<div class="code shell highlight-default"><div class="highlight"><pre><span></span>➜  sctf-rsa3-level3 git:(master) ✗ sage exp.sage
sys:1: RuntimeWarning: not adding directory &#39;&#39; to sys.path since everybody can write to it.
Untrusted users could put files in this directory which might then be imported by your Python code. As a general precaution from similar exploits, you should not execute Python code from this directory
F4An8LIn_rElT3r_rELa53d_Me33Age_aTtaCk_e_I2_s7aLL
</pre></div>
</div>
</div>
<div class="section" id="id8">
<h3>题目<a class="headerlink" href="#id8" title="永久链接至标题">¶</a></h3>
<ul class="simple">
<li>hitcon 2014 rsaha</li>
</ul>
</div>
</div>
<div class="section" id="coppersmiths-short-pad-attack">
<h2>Coppersmith’s short-pad attack<a class="headerlink" href="#coppersmiths-short-pad-attack" title="永久链接至标题">¶</a></h2>
<div class="section" id="id9">
<h3>攻击条件<a class="headerlink" href="#id9" title="永久链接至标题">¶</a></h3>
<p>目前在大部分消息加密之前都会进行padding，但是如果padding的长度过短，也有<strong>可能</strong>被很容易地攻击。</p>
</div>
<div class="section" id="id10">
<h3>攻击原理<a class="headerlink" href="#id10" title="永久链接至标题">¶</a></h3>
<p>我们假设爱丽丝要给鲍勃发送消息，首先爱丽丝对要加密的消息M进行随机padding，然后加密得到密文C1，发送给鲍勃。这时，中间人皮特截获了密文。一段时间后，爱丽丝没有收到鲍勃的回复，再次对要加密的消息M进行随机padding，然后加密得到密文C2，发送给Bob。皮特再一次截获。这时，皮特就<strong>可能</strong>可以利用如下原理解密。</p>
<p>这里我们假设模数N的长度为k，并且padding的长度为<span class="math">\(m=\lfloor \frac{k}{e^2} \rfloor\)</span> 。此外，假设要加密的消息的长度最多为k-m比特，padding的方式如下</p>
<p><span class="math">\(M_1=2^mM+r_1, 0\leq r_1\leq 2^m\)</span></p>
<p>消息M2的padding方式类似。</p>
<p>那么我们可以利用如下的方式来解密。</p>
<p>首先定义</p>
<p><span class="math">\(g_1(x,y)=x^e-C_1\)</span></p>
<p><span class="math">\(g_2(x,y)=(x+y)^e-C_2\)</span></p>
<p>其中<span class="math">\(y=r_2-r_1\)</span> 。显然这两个方程具有相同的根M1。然后还有一系列的推导。。。</p>
</div>
</div>
<div class="section" id="known-high-bits-message-attack">
<h2>Known High Bits Message Attack<a class="headerlink" href="#known-high-bits-message-attack" title="永久链接至标题">¶</a></h2>
<div class="section" id="id11">
<h3>攻击条件<a class="headerlink" href="#id11" title="永久链接至标题">¶</a></h3>
<p>这里我们假设我们首先加密了消息m，如下</p>
<p><span class="math">\(C\equiv m^d \bmod N\)</span></p>
<p>并且我们假设我们知道消息m的很大的一部分<span class="math">\(m_0\)</span> ，即<span class="math">\(m=m_0+x\)</span> ，但是我们不知道<span class="math">\(x\)</span> 。那么我们就有可能通过该方法进行恢复消息。</p>
</div>
<div class="section" id="id12">
<h3>例子1<a class="headerlink" href="#id12" title="永久链接至标题">¶</a></h3>
<p>可以参考https://github.com/mimoo/RSA-and-LLL-attacks。</p>
</div>
<div class="section" id="id13">
<h3>例子2<a class="headerlink" href="#id13" title="永久链接至标题">¶</a></h3>
</div>
</div>
<div class="section" id="factoring-with-high-bits-known">
<h2>Factoring with High Bits Known<a class="headerlink" href="#factoring-with-high-bits-known" title="永久链接至标题">¶</a></h2>
<div class="section" id="id14">
<h3>攻击条件<a class="headerlink" href="#id14" title="永久链接至标题">¶</a></h3>
<p>当我们知道一个公钥中模数N的一个因子的较高位时，我们就有一定几率来分解N。</p>
</div>
<div class="section" id="id15">
<h3>攻击工具<a class="headerlink" href="#id15" title="永久链接至标题">¶</a></h3>
<p>请参考https://github.com/mimoo/RSA-and-LLL-attacks 。上面有使用教程。</p>
</div>
<div class="section" id="id16">
<h3>例子1<a class="headerlink" href="#id16" title="永久链接至标题">¶</a></h3>
<p>参考https://github.com/mimoo/RSA-and-LLL-attacks 。这里我们关注下面的代码</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">beta</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">dd</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">degree</span><span class="p">()</span>
<span class="n">epsilon</span> <span class="o">=</span> <span class="n">beta</span> <span class="o">/</span> <span class="mi">7</span>
<span class="n">mm</span> <span class="o">=</span> <span class="n">ceil</span><span class="p">(</span><span class="n">beta</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="n">dd</span> <span class="o">*</span> <span class="n">epsilon</span><span class="p">))</span>
<span class="n">tt</span> <span class="o">=</span> <span class="n">floor</span><span class="p">(</span><span class="n">dd</span> <span class="o">*</span> <span class="n">mm</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span><span class="o">/</span><span class="n">beta</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">XX</span> <span class="o">=</span> <span class="n">ceil</span><span class="p">(</span><span class="n">N</span><span class="o">**</span><span class="p">((</span><span class="n">beta</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">dd</span><span class="p">)</span> <span class="o">-</span> <span class="n">epsilon</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1000000000000000000000000000000000</span>
<span class="n">roots</span> <span class="o">=</span> <span class="n">coppersmith_howgrave_univariate</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">mm</span><span class="p">,</span> <span class="n">tt</span><span class="p">,</span> <span class="n">XX</span><span class="p">)</span>
</pre></div>
</div>
<p>其中，</p>
<ul class="simple">
<li>必须满足 <span class="math">\(q\geq N^{beta}\)</span> ，所以这里给出了<span class="math">\(beta=0.5\)</span> ，显然两个因数中必然有一个是大于的。</li>
<li>XX是$f(x)=q’+x $ 在模q意义下的根的上界，自然我们可以选择调整它，这里其实也表明了我们已知的<span class="math">\(q'\)</span> 与因数q之间可能的差距。</li>
</ul>
</div>
<div class="section" id="id17">
<h3>例子2<a class="headerlink" href="#id17" title="永久链接至标题">¶</a></h3>
<p>这里我们以2016年HCTF中的RSA2为例进行介绍。</p>
<p>首先程序的开头是一个绕过验证的，我们大概搞搞，绕过即可，代码如下</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pwn</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">hashlib</span> <span class="k">import</span> <span class="n">sha512</span>
<span class="n">sh</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mi">9999</span><span class="p">)</span>
<span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s1">&#39;debug&#39;</span>
<span class="k">def</span> <span class="nf">sha512_proof</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">verify</span><span class="p">):</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">pading</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
            <span class="n">pading</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pading</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">200</span><span class="p">:</span>
                <span class="n">pading</span> <span class="o">=</span> <span class="n">pading</span><span class="p">[</span><span class="mi">200</span><span class="p">:]</span>
            <span class="c1">#print pading</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">sha512</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">pading</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">verify</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pading</span>


<span class="k">def</span> <span class="nf">verify</span><span class="p">():</span>
    <span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&quot;Prefix: &quot;</span><span class="p">)</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="n">sh</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
    <span class="nb">print</span> <span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="n">prefix</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="n">prefix</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;base64&#39;</span><span class="p">)</span>
    <span class="n">proof</span> <span class="o">=</span> <span class="n">sha512_proof</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="s2">&quot;fffffff&quot;</span><span class="p">)</span>
    <span class="n">sh</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">proof</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;base64&#39;</span><span class="p">))</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">verify</span><span class="p">()</span>
    <span class="nb">print</span> <span class="s1">&#39;verify success&#39;</span>
    <span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&quot;token: &quot;</span><span class="p">)</span>
    <span class="n">token</span> <span class="o">=</span> <span class="s2">&quot;5c9597f3c8245907ea71a89d9d39d08e&quot;</span>
    <span class="n">sh</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

    <span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&quot;n: &quot;</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">sh</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span> <span class="mi">16</span><span class="p">)</span>

    <span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&quot;e: &quot;</span><span class="p">)</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">sh</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">e</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span> <span class="mi">16</span><span class="p">)</span>

    <span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&quot;e2: &quot;</span><span class="p">)</span>
    <span class="n">e2</span> <span class="o">=</span> <span class="n">sh</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">e2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">e2</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span> <span class="mi">16</span><span class="p">)</span>

    <span class="n">sh</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&quot;is: &quot;</span><span class="p">)</span>
    <span class="n">enc_flag</span> <span class="o">=</span> <span class="n">sh</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">enc_flag</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">enc_flag</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s2">&quot;n: &quot;</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s2">&quot;e: &quot;</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s2">&quot;e2: &quot;</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="n">e2</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s2">&quot;flag: &quot;</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="n">enc_flag</span><span class="p">)</span>
</pre></div>
</div>
<p>这里我们也已经得到n，e，e2，加密后的flag了，如下</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">n</span><span class="p">:</span>  <span class="mh">0x724d41149e1bd9d2aa9b333d467f2dfa399049a5d0b4ee770c9d4883123be11a52ff1bd382ad37d0ff8d58c8224529ca21c86e8a97799a31ddebd246aeeaf0788099b9c9c718713561329a8e529dfeae993036921f036caa4bdba94843e0a2e1254c626abe54dc3129e2f6e6e73bbbd05e7c6c6e9f44fcd0a496f38218ab9d52bf1f266004180b6f5b9bee7988c4fe5ab85b664280c3cfe6b80ae67ed8ba37825758b24feb689ff247ee699ebcc4232b4495782596cd3f29a8ca9e0c2d86ea69372944d027a0f485cea42b74dfd74ec06f93b997a111c7e18017523baf0f57ae28126c8824bd962052623eb565cee0ceee97a35fd8815d2c5c97ab9653c4553f</span>
<span class="n">e</span><span class="p">:</span>  <span class="mh">0x10001</span>
<span class="n">e2</span><span class="p">:</span>  <span class="mh">0xf93b</span>
<span class="n">flag</span><span class="p">:</span>  <span class="mh">0xf11e932fa420790ca3976468dc4df1e6b20519ebfdc427c09e06940e1ef0ca566d41714dc1545ddbdcae626eb51c7fa52608384a36a2a021960d71023b5d0f63e6b38b46ac945ddafea42f01d24cc33ce16825df7aa61395d13617ae619dca2df15b5963c77d6ededf2fe06fd36ae8c5ce0e3c21d72f2d7f20cd9a8696fbb628df29299a6b836c418cbfe91e2b5be74bdfdb4efdd1b33f57ebb72c5246d5dce635529f1f69634d565a631e950d4a34a02281cbed177b5a624932c2bc02f0c8fd9afd332ccf93af5048f02b8bd72213d6a52930b0faa0926973883136d8530b8acf732aede8bb71cb187691ebd93a0ea8aeec7f82d0b8b74bcf010c8a38a1fa8</span>
</pre></div>
</div>
<p>接下来我们来分析主程序。可以看出</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">gen_key</span><span class="p">()</span>
<span class="n">n</span> <span class="o">=</span> <span class="n">p</span> <span class="o">*</span> <span class="n">q</span>
<span class="n">phi_n</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">d</span> <span class="o">=</span> <span class="n">invmod</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">phi_n</span><span class="p">)</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">e2</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mh">0x1000</span><span class="p">,</span> <span class="mh">0x10000</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">gcd</span><span class="p">(</span><span class="n">e2</span><span class="p">,</span> <span class="n">phi_n</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">break</span>
</pre></div>
</div>
<p>我们的得到的n=p*q。而p，q，以及我们已知的e都在gen_key函数中生成。看一看gen_key函数</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">gen_key</span><span class="p">():</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">getPrime</span><span class="p">(</span><span class="n">k</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">gcd</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">p</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="n">q_t</span> <span class="o">=</span> <span class="n">getPrime</span><span class="p">(</span><span class="n">k</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">n_t</span> <span class="o">=</span> <span class="n">p</span> <span class="o">*</span> <span class="n">q_t</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">get_bit</span><span class="p">(</span><span class="n">n_t</span><span class="p">,</span> <span class="n">k</span><span class="o">/</span><span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">get_bit</span><span class="p">(</span><span class="n">n_t</span><span class="p">,</span> <span class="mi">5</span><span class="o">*</span><span class="n">k</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">p4</span> <span class="o">=</span> <span class="n">get_bit</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">5</span><span class="o">*</span><span class="n">k</span><span class="o">/</span><span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">pi_b</span><span class="p">(</span><span class="n">p4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">long_to_bytes</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">+</span> <span class="n">long_to_bytes</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">+</span> <span class="n">long_to_bytes</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">n</span> <span class="o">/</span> <span class="n">p</span>
    <span class="k">if</span> <span class="n">q</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">q</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">isPrime</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="ow">and</span> <span class="n">gcd</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">q</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">getPrime</span><span class="p">(</span><span class="n">k</span><span class="o">/</span><span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">q</span> <span class="o">^=</span> <span class="n">m</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</pre></div>
</div>
<p>其中我们已知如下参数</p>
<ul class="simple">
<li>k=2048</li>
<li>e=0x10001</li>
</ul>
<p>首先，程序先得到了1024比特位的素数p，并且gcd(2,p-1)=1。</p>
<p>然后，程序又得到了一个1024比特位的素数q_t，并且计算n_t=p*q_t。</p>
<p>下面多次调用了get_bit函数，我们来简单分析一下</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_bit</span><span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="n">n_bit</span><span class="p">,</span> <span class="n">dire</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    dire:</span>
<span class="sd">        1: left</span>
<span class="sd">        0: right</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">dire</span><span class="p">:</span>
        <span class="n">sn</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sn</span> <span class="o">%</span> <span class="mi">8</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sn</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">sn</span> <span class="o">%</span> <span class="mi">8</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">number</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">sn</span><span class="o">-</span><span class="n">n_bit</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">number</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_bit</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>可以看出根据dire(ction)的不同，会得到不同的数</p>
<ul class="simple">
<li>dire=1时，程序首先计算number的二进制位数sn，如果不是8 的整数倍的话，就将sn增大为8的整数倍，然后返回number右移(sn-n_bit)的数字。其实 就是最多保留number的n_bit位。</li>
<li>dire=0时，程序直接获取number的低n_bit位。</li>
</ul>
<p>然后我们再来看程序</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">t</span> <span class="o">=</span> <span class="n">get_bit</span><span class="p">(</span><span class="n">n_t</span><span class="p">,</span> <span class="n">k</span><span class="o">/</span><span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">get_bit</span><span class="p">(</span><span class="n">n_t</span><span class="p">,</span> <span class="mi">5</span><span class="o">*</span><span class="n">k</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">p4</span> <span class="o">=</span> <span class="n">get_bit</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">5</span><span class="o">*</span><span class="n">k</span><span class="o">/</span><span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>这三个操作分别做了如下的事情</p>
<ul class="simple">
<li>t为n_t的最多高k/16，即128位，位数不固定。</li>
<li>y为n_t的低5*k/8位，即1280位，位数固定。</li>
<li>p4为p的最多高5k/16位，即640位，位数不固定。</li>
</ul>
<p>此后，程序有如下操作</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">u</span> <span class="o">=</span> <span class="n">pi_b</span><span class="p">(</span><span class="n">p4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>利用pi_b对p4进行了加密</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">pi_b</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    m:</span>
<span class="sd">        1: encrypt</span>
<span class="sd">        0: decrypt</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">enc</span> <span class="o">=</span> <span class="n">DES</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
        <span class="n">method</span> <span class="o">=</span> <span class="n">enc</span><span class="o">.</span><span class="n">encrypt</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">method</span> <span class="o">=</span> <span class="n">enc</span><span class="o">.</span><span class="n">decrypt</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">long_to_bytes</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">sp</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="n">a</span><span class="p">:</span><span class="n">a</span><span class="o">+</span><span class="mi">8</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="mi">8</span><span class="p">)]</span>
    <span class="n">r</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">sp</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">+=</span> <span class="n">method</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
</pre></div>
</div>
<p>其中，我们已知了秘钥key，所以只要我们有密文就可以解密。此外，可以看到的是程序是对传入的消息进行8字节分组，采用密码本方式加密，所以密文之间互不影响。</p>
<p>下面</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">long_to_bytes</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">+</span> <span class="n">long_to_bytes</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">+</span> <span class="n">long_to_bytes</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">n</span> <span class="o">/</span> <span class="n">p</span>
<span class="k">if</span> <span class="n">q</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">q</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">isPrime</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="ow">and</span> <span class="n">gcd</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">q</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">break</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">getPrime</span><span class="p">(</span><span class="n">k</span><span class="o">/</span><span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">q</span> <span class="o">^=</span> <span class="n">m</span>
<span class="k">return</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</pre></div>
</div>
<p>程序将t，u，y拼接在一起得到n，进而，程序得到了q，并对q的低k/16位做了抑或，然后返回q’。</p>
<p>在主程序里，再一次得到了n’=p*q’。这里我们仔细分析一下</p>
<p><span class="math">\(n'=p*(q+random(2^{k/16}))\)</span></p>
<p>而p是k/2位的，所以说，random的部分最多可以影响原来的n的最低的<span class="math">\(k/2+k/16=9k/16\)</span> 比特位。</p>
<p>而，我们还知道n的最低的5k/8=10k/16 比特为其实就是y，所以其并没有影响到u，即使影响到也就最多影响到一位。</p>
<p>所以我们首先可以利用我们得到的n来获取u，如下</p>
<p><span class="math">\(u=hex(n)[2:-1][-480:-320]\)</span></p>
<p>虽然，这样可能会获得较多位数的u，但是这样并不影响，我们对u解密的时候每一分组都互不影响，所以我们只可能影响最高位数的p4。而p4的的高8位也有可能是填充的。但这也并不影响，我们已经得到了因子p的的很多部分了，我们可以去
尝试着解密了。如下</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="vm">__name__</span><span class="o">==</span><span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mh">0x724d41149e1bd9d2aa9b333d467f2dfa399049a5d0b4ee770c9d4883123be11a52ff1bd382ad37d0ff8d58c8224529ca21c86e8a97799a31ddebd246aeeaf0788099b9c9c718713561329a8e529dfeae993036921f036caa4bdba94843e0a2e1254c626abe54dc3129e2f6e6e73bbbd05e7c6c6e9f44fcd0a496f38218ab9d52bf1f266004180b6f5b9bee7988c4fe5ab85b664280c3cfe6b80ae67ed8ba37825758b24feb689ff247ee699ebcc4232b4495782596cd3f29a8ca9e0c2d86ea69372944d027a0f485cea42b74dfd74ec06f93b997a111c7e18017523baf0f57ae28126c8824bd962052623eb565cee0ceee97a35fd8815d2c5c97ab9653c4553f</span>
    <span class="n">u</span> <span class="o">=</span> <span class="nb">hex</span><span class="p">(</span><span class="n">n</span><span class="p">)[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">480</span><span class="p">:</span><span class="o">-</span><span class="mi">320</span><span class="p">]</span>
    <span class="n">u</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">p4</span> <span class="o">=</span> <span class="n">pi_b</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="nb">print</span> <span class="nb">hex</span><span class="p">(</span><span class="n">p4</span><span class="p">)</span>
</pre></div>
</div>
<p>解密结果如下</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span>➜  2016-HCTF-RSA2 git:(master) ✗ python exp_p4.py
0xa37302107c17fb4ef5c3443f4ef9e220ac659670077b9aa9ff7381d11073affe9183e88acae0ab61fb75a3c7815ffcb1b756b27c4d90b2e0ada753fa17cc108c1d0de82c747db81b9e6f49bde1362693L
</pre></div>
</div>
<p>下面，我们直接使用sage来解密，这里sage里面已经实现了这个攻击，我们直接拿来用就好</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sage.all</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">binascii</span>
<span class="n">n</span> <span class="o">=</span> <span class="mh">0x724d41149e1bd9d2aa9b333d467f2dfa399049a5d0b4ee770c9d4883123be11a52ff1bd382ad37d0ff8d58c8224529ca21c86e8a97799a31ddebd246aeeaf0788099b9c9c718713561329a8e529dfeae993036921f036caa4bdba94843e0a2e1254c626abe54dc3129e2f6e6e73bbbd05e7c6c6e9f44fcd0a496f38218ab9d52bf1f266004180b6f5b9bee7988c4fe5ab85b664280c3cfe6b80ae67ed8ba37825758b24feb689ff247ee699ebcc4232b4495782596cd3f29a8ca9e0c2d86ea69372944d027a0f485cea42b74dfd74ec06f93b997a111c7e18017523baf0f57ae28126c8824bd962052623eb565cee0ceee97a35fd8815d2c5c97ab9653c4553f</span>
<span class="n">p4</span> <span class="o">=</span><span class="mh">0xa37302107c17fb4ef5c3443f4ef9e220ac659670077b9aa9ff7381d11073affe9183e88acae0ab61fb75a3c7815ffcb1b756b27c4d90b2e0ada753fa17cc108c1d0de82c747db81b9e6f49bde1362693</span>
<span class="n">cipher</span> <span class="o">=</span> <span class="mh">0xf11e932fa420790ca3976468dc4df1e6b20519ebfdc427c09e06940e1ef0ca566d41714dc1545ddbdcae626eb51c7fa52608384a36a2a021960d71023b5d0f63e6b38b46ac945ddafea42f01d24cc33ce16825df7aa61395d13617ae619dca2df15b5963c77d6ededf2fe06fd36ae8c5ce0e3c21d72f2d7f20cd9a8696fbb628df29299a6b836c418cbfe91e2b5be74bdfdb4efdd1b33f57ebb72c5246d5dce635529f1f69634d565a631e950d4a34a02281cbed177b5a624932c2bc02f0c8fd9afd332ccf93af5048f02b8bd72213d6a52930b0faa0926973883136d8530b8acf732aede8bb71cb187691ebd93a0ea8aeec7f82d0b8b74bcf010c8a38a1fa8</span>
<span class="n">e2</span> <span class="o">=</span> <span class="mh">0xf93b</span>
<span class="n">pbits</span> <span class="o">=</span> <span class="mi">1024</span>
<span class="n">kbits</span> <span class="o">=</span> <span class="n">pbits</span> <span class="o">-</span> <span class="n">p4</span><span class="o">.</span><span class="n">nbits</span><span class="p">()</span>
<span class="nb">print</span> <span class="n">p4</span><span class="o">.</span><span class="n">nbits</span><span class="p">()</span>
<span class="n">p4</span> <span class="o">=</span> <span class="n">p4</span> <span class="o">&lt;&lt;</span> <span class="n">kbits</span>
<span class="n">PR</span><span class="o">.&lt;</span><span class="n">x</span><span class="o">&gt;</span> <span class="o">=</span> <span class="n">PolynomialRing</span><span class="p">(</span><span class="n">Zmod</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">p4</span>
<span class="n">roots</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">small_roots</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="mi">2</span><span class="o">^</span><span class="n">kbits</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="k">if</span> <span class="n">roots</span><span class="p">:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">p4</span><span class="o">+</span><span class="nb">int</span><span class="p">(</span><span class="n">roots</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="nb">print</span> <span class="s2">&quot;p: &quot;</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">n</span> <span class="o">%</span> <span class="n">p</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">n</span><span class="o">/</span><span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s2">&quot;q: &quot;</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>
    <span class="nb">print</span> <span class="n">gcd</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">q</span><span class="p">)</span>
    <span class="n">phin</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="nb">print</span> <span class="n">gcd</span><span class="p">(</span><span class="n">e2</span><span class="p">,</span><span class="n">phin</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">inverse_mod</span><span class="p">(</span><span class="n">e2</span><span class="p">,</span><span class="n">phin</span><span class="p">)</span>
    <span class="n">flag</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">cipher</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">flag</span> <span class="o">=</span> <span class="nb">hex</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">flag</span><span class="p">))[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="nb">print</span> <span class="n">binascii</span><span class="o">.</span><span class="n">unhexlify</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
</pre></div>
</div>
<p>关于small_roots的使用，可以参考<a class="reference external" href="http://doc.sagemath.org/html/en/reference/polynomial_rings/sage/rings/polynomial/polynomial_modn_dense_ntl.html#sage.rings.polynomial.polynomial_modn_dense_ntl.small_roots">SAGE
说明</a>。</p>
<p>结果如下</p>
<div class="code shell highlight-default"><div class="highlight"><pre><span></span>➜  2016-HCTF-RSA2 git:(master) ✗ sage payload.sage
sys:1: RuntimeWarning: not adding directory &#39;&#39; to sys.path since everybody can write to it.
Untrusted users could put files in this directory which might then be imported by your Python code. As a general precaution from similar exploits, you should not execute Python code from this directory
640
p:  0xa37302107c17fb4ef5c3443f4ef9e220ac659670077b9aa9ff7381d11073affe9183e88acae0ab61fb75a3c7815ffcb1b756b27c4d90b2e0ada753fa17cc108c1d0de82c747db81b9e6f49bde13626933aa6762057e1df53d27356ee6a09b17ef4f4986d862e3bb24f99446a0ab2385228295f4b776c1f391ab2a0d8c0dec1e5L
q:  0xb306030a7c6ace771db8adb45fae597f3c1be739d79fd39dfa6fd7f8c177e99eb29f0462c3f023e0530b545df6e656dadb984953c265b26f860b68aa6d304fa403b0b0e37183008592ec2a333c431e2906c9859d7cbc4386ef4c4407ead946d855ecd6a8b2067ad8a99b21111b26905fcf0d53a1b893547b46c3142b06061853L
1
1
hctf{d8e8fca2dc0f896fd7cb4cb0031ba249}
</pre></div>
</div>
</div>
<div class="section" id="id18">
<h3>题目<a class="headerlink" href="#id18" title="永久链接至标题">¶</a></h3>
<ul class="simple">
<li>2016 湖湘杯 简单的RSA</li>
<li>2017 WHCTF Untitled</li>
</ul>
</div>
</div>
<div class="section" id="boneh-and-durfee-attack">
<h2>Boneh and Durfee attack<a class="headerlink" href="#boneh-and-durfee-attack" title="永久链接至标题">¶</a></h2>
<div class="section" id="id19">
<h3>攻击条件<a class="headerlink" href="#id19" title="永久链接至标题">¶</a></h3>
<p>当d较小时，满足<span class="math">\(d\leq N^{0.292}\)</span> 时，我们可以利用该工具，在一定程度上该要攻击比wiener attack要强一些。</p>
</div>
<div class="section" id="id20">
<h3>攻击原理<a class="headerlink" href="#id20" title="永久链接至标题">¶</a></h3>
<p>这里简单说一下原理</p>
<p>首先我们有</p>
<p><span class="math">\(ed \equiv 1 \bmod \varphi(N)\)</span></p>
<p>进而我们有</p>
<p><span class="math">\(ed =k\varphi(N)+1\)</span> 即 <span class="math">\(k \varphi(N) +1 \equiv 0 \bmod e\)</span> 。</p>
<p>又</p>
<p><span class="math">\(\varphi(N)=(p-1)(q-1)=qp-p-q+1=N-p-q+1\)</span></p>
<p>所以</p>
<p><span class="math">\(k(N-p-q+1)+1 \equiv 0 \bmod e\)</span></p>
<p>我们假设<span class="math">\(A=N+1\)</span>，<span class="math">\(y=-p-q\)</span> 那么</p>
<p>原式可化为</p>
<p><span class="math">\(f(k,y)=k(A+y)+1 \equiv 0 \bmod e\)</span></p>
<p>如果我们求得了该二元方程的根，那么我们自然也就可以解一元二次方程(<span class="math">\(N=pq,p+q=-y\)</span>)来得到p与q。</p>
</div>
<div class="section" id="id21">
<h3>攻击工具<a class="headerlink" href="#id21" title="永久链接至标题">¶</a></h3>
<p>请参考https://github.com/mimoo/RSA-and-LLL-attacks。上面有使用教程。</p>
</div>
<div class="section" id="id22">
<h3>例子<a class="headerlink" href="#id22" title="永久链接至标题">¶</a></h3>
<p>这里我们以2015年PlaidCTF-CTF-Curious为例进行介绍。</p>
<p>首先题目给了一堆N，e，c。简单看一下可以发现该e比较大。这时候我们可以考虑使用wiener attack，这里我们使用更强的目前介绍的攻击。</p>
<p>核心代码如下</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">nlist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<span class="n">elist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<span class="n">clist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;captured&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="c1"># read the line {N : e : c} and do nothing with it</span>
    <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
        <span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; : &quot;</span><span class="p">)</span>
        <span class="n">nlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">long</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="mi">16</span><span class="p">))</span>
        <span class="n">elist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">long</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="mi">16</span><span class="p">))</span>
        <span class="n">clist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">long</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="mi">16</span><span class="p">))</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nlist</span><span class="p">)):</span>
    <span class="nb">print</span> <span class="s1">&#39;index i&#39;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">nlist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">elist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">clist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">e</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">d</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">continue</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">power_mod</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
        <span class="n">hex_string</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%x</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">m</span>
        <span class="kn">import</span> <span class="nn">binascii</span>
        <span class="nb">print</span> <span class="s2">&quot;the plaintext:&quot;</span><span class="p">,</span> <span class="n">binascii</span><span class="o">.</span><span class="n">unhexlify</span><span class="p">(</span><span class="n">hex_string</span><span class="p">)</span>
        <span class="k">return</span>
</pre></div>
</div>
<p>结果如下</p>
<div class="code shell highlight-default"><div class="highlight"><pre><span></span>=== solution found ===
private key found: 23974584842546960047080386914966001070087596246662608796022581200084145416583
the plaintext: flag_S0Y0UKN0WW13N3R$4TT4CK!
</pre></div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>快速搜索</h3>
    <form class="search" action="../../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="转向" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
<div class="sphinx-toc sphinxglobaltoc">
<h3><a href="../../../index.html">內容目录</a></h3>
<p class="caption"><span class="caption-text">CTF 介绍</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction/history.html">CTF 竞赛的历史</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction/mode.html">CTF 竞赛模式简介</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction/content.html">CTF 竞赛内容</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction/experience.html">线下攻防经验小结</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction/cgc.html">CGC 网络超级挑战赛</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction/resources.html">学习资源</a></li>
</ul>
<p class="caption"><span class="caption-text">Misc</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/about.html">杂项简介</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/recon.html">信息搜集技术</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/encode/index.html">编码分析</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/prefix.html">取证隐写</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/picture/index.html">图片分析</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/traffic/index.html">流量包分析</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/archive/index.html">压缩包分析</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/audio/index.html">音频分析</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/disk_memory/index.html">磁盘 / 内存分析</a></li>
</ul>
<p class="caption"><span class="caption-text">Crypto</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html">密码学简介</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../classical/index.html">古典密码</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../symmetric/index.html">对称加密</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">非对称密码</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="rsa_index.html">RSA</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="rsa_theory.html">RSA 基本介绍</a></li>
<li class="toctree-l3"><a class="reference internal" href="rsa_module_attack.html">模数相关攻击</a></li>
<li class="toctree-l3"><a class="reference internal" href="rsa_e_attack.html">公钥指数相关攻击</a></li>
<li class="toctree-l3"><a class="reference internal" href="rsa_d_attack.html">私钥 d 相关攻击</a></li>
<li class="toctree-l3"><a class="reference internal" href="rsa_chosen_cipher.html">选择密文攻击</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Coppersmith Related Attack</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id1">基本原理</a></li>
<li class="toctree-l4"><a class="reference internal" href="#basic-broadcast-attack">Basic Broadcast Attack</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#id2">攻击条件</a></li>
<li class="toctree-l5"><a class="reference internal" href="#id3">攻击原理</a></li>
<li class="toctree-l5"><a class="reference internal" href="#sctf-rsa3-level4">SCTF RSA3 LEVEL4</a></li>
<li class="toctree-l5"><a class="reference internal" href="#id4">题目</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#broadcast-attack-with-linear-padding">Broadcast Attack with Linear Padding</a></li>
<li class="toctree-l4"><a class="reference internal" href="#related-message-attack">Related Message Attack</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#id5">攻击条件</a></li>
<li class="toctree-l5"><a class="reference internal" href="#id6">攻击原理</a></li>
<li class="toctree-l5"><a class="reference internal" href="#id7">例子</a></li>
<li class="toctree-l5"><a class="reference internal" href="#id8">题目</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#coppersmiths-short-pad-attack">Coppersmith’s short-pad attack</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#id9">攻击条件</a></li>
<li class="toctree-l5"><a class="reference internal" href="#id10">攻击原理</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#known-high-bits-message-attack">Known High Bits Message Attack</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#id11">攻击条件</a></li>
<li class="toctree-l5"><a class="reference internal" href="#id12">例子1</a></li>
<li class="toctree-l5"><a class="reference internal" href="#id13">例子2</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#factoring-with-high-bits-known">Factoring with High Bits Known</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#id14">攻击条件</a></li>
<li class="toctree-l5"><a class="reference internal" href="#id15">攻击工具</a></li>
<li class="toctree-l5"><a class="reference internal" href="#id16">例子1</a></li>
<li class="toctree-l5"><a class="reference internal" href="#id17">例子2</a></li>
<li class="toctree-l5"><a class="reference internal" href="#id18">题目</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#boneh-and-durfee-attack">Boneh and Durfee attack</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#id19">攻击条件</a></li>
<li class="toctree-l5"><a class="reference internal" href="#id20">攻击原理</a></li>
<li class="toctree-l5"><a class="reference internal" href="#id21">攻击工具</a></li>
<li class="toctree-l5"><a class="reference internal" href="#id22">例子</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="rsa_side_channel.html">侧信道攻击</a></li>
<li class="toctree-l3"><a class="reference internal" href="rsa_pkcs_attack.html">Bleichenbacher’s attack</a></li>
<li class="toctree-l3"><a class="reference internal" href="rsa_complex.html">综合题目</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../knapsack/knapsack_intro.html">背包加密</a></li>
<li class="toctree-l2"><a class="reference internal" href="../discrete_log/discrete_log_intro.html">离散对数相关</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../hash/index.html">哈希函数</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../signature/index.html">数字签名</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../others/others.html">证书格式</a></li>
</ul>
<p class="caption"><span class="caption-text">Web</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../web/index.html">WEB 简介</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../web/sqli.html">SQL 注入</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../web/xss.html">XSS 跨站脚本攻击</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../web/csrf.html">CSRF 跨站请求伪造</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../web/ssrf.html">SSRF 服务端请求伪造</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../web/php.html">PHP 代码审计</a></li>
</ul>
<p class="caption"><span class="caption-text">Reverse</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../reverse/introduction.html">软件逆向工程简介</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reverse/unpack/index.html">Unpack Tricks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reverse/unicorn/index.html">Unicorn Engine</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reverse/anti_debug/index.html">Anti Debug Tech</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reverse/linux/index.html">Linux RE</a></li>
</ul>
<p class="caption"><span class="caption-text">Pwn</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../pwn/stackoverflow/index.html">栈溢出</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pwn/fmtstr/index.html">格式化字符串漏洞</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pwn/heap/index.html">堆利用</a></li>
</ul>
<p class="caption"><span class="caption-text">Executable</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../executable/elf/index.html">ELF文件</a></li>
</ul>
</div>
        </div>
      </div>
    
    
        <div class="sidebar-toggle-group no-js">
            
            <button class="sidebar-toggle" id="sidebar-hide" title="Hide the sidebar menu">
                 «
                <span class="show-for-small">hide menu</span>
                
            </button>
            <button class="sidebar-toggle" id="sidebar-show" title="Show the sidebar menu">
                
                <span class="show-for-small">menu</span>
                <span class="hide-for-small">sidebar</span>
                 »
            </button>
        </div>
    
      <div class="clearer"></div>
    </div>
    <div class="relbar-bottom">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>导航</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../index.html" title="內容目录"
             >toc</a></li>
        <li class="right" >
          <a href="rsa_side_channel.html" title="侧信道攻击"
             >下一页</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="rsa_chosen_cipher.html" title="选择密文攻击"
             >上一页</a> &nbsp; &nbsp;</li>
    <li><a href="../../../index.html">CTF Wiki </a> &#187;</li>

          <li class="nav-item nav-item-1"><a href="../index.html" >非对称密码</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="rsa_index.html" >RSA</a> &#187;</li> 
      </ul>
    </div>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2016-2017, CTF Wiki.
      由 <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.7 创建。
    </div>
    <!-- cloud_sptheme 1.4 -->
  </body>
</html>